(()=>{let t,e=!1,o=null,n=!1,s=0,i=null;let a=!1;setTimeout((function e(){if("loading"!==shadowRoot.readyState){if(window.PipController)try{t=new window.PipController({pipTitle:"BrowserGPT SmartSense (Stealth mode)",pipHeader:'\n\t\t\t\t\t<div style="display: flex; align-items: center; gap: 10px; width: 100%; justify-content: center;">\n\t\t\t\t\t\t\x3c!-- <i class="fas fa-eye-slash"></i> --\x3e\n\t\t\t\t\t\t<span>BrowserGPT SmartSense</span>\n\t\t\t\t\t</div>\n\t\t\t\t',pipHeaderStyle:{backgroundColor:"#15191E",color:"#04A492",padding:"10px",borderBottom:"1px solid rgba(4, 164, 146, 0.2)"},enableExtensionSuggestions:!0,customSuggestions:[{action:"scroll_down",text:"Scroll down to the bottom of the current page"},{action:"scroll_up",text:"Scroll up to the top of the current page"},{action:"close_stealth_mode",text:"Close SmartSense in Stealth Mode"}]}),window.pipController=t}catch(t){}}else shadowRoot.addEventListener("DOMContentLoaded",(()=>setTimeout(e,100)))}),500);let c,r,l=!1,d=null;const u=shadowRoot.querySelector(".sticky-button.top"),m=shadowRoot.querySelector(".sticky-button.bottom"),p=shadowRoot.querySelector(".sticky-button:not(.top):not(.bottom)"),y=shadowRoot.querySelector(".sticky-button-container");function h(t=!0){const e=b.querySelector("style");if(t&&!e){const t=document.createElement("style");t.textContent="\n\t\t\t:host #sticky-chat-button:hover + .suggestions-list,\n\t\t\t:host .suggestions-list:hover {\n\t\t\t\topacity: 1 !important;\n\t\t\t\tvisibility: visible !important;\n\t\t\t\ttransform: translateX(0) !important;\n\t\t\t}\n\t\t",b.appendChild(t)}else!t&&e&&e.remove()}function g(t){l=!1;shadowRoot.querySelector(".kebab-handle").style.cursor="grab"}let f=[{text:"Scroll down to the bottom of the current page",icon:"arrow-down",action:"scroll_down"},{text:"Scroll up to the top of the current page",icon:"arrow-up",action:"scroll_top"},{text:"Open SmartSense in Stealth Mode",icon:"eye",action:"open_stealth_mode"},{text:"Close Sticky",icon:"times",action:"close_sticky_mode"}],b=null;function w(){const t=Math.max(document.body.scrollHeight,document.documentElement.scrollHeight,document.body.offsetHeight,document.documentElement.offsetHeight),e=window.innerHeight,o=document.querySelector('[class*="scroll"], [class*="overflow"], [class*="main"]');return o?o.scrollHeight>o.clientHeight:t>e}function v(t){setTimeout((()=>{t.relatedTarget?.closest("#sticky-chat-button")||this.classList.remove("show")}),2e3),R(y,"both")}function S(t,e=!1){if(!b)return;if(!e){const e=t.querySelector(".suggestions-list");let n=0,s=0;document.addEventListener("mousemove",(t=>{n=t.clientX,s=t.clientY}));const i=t=>{if(!t)return!1;const e=t.getBoundingClientRect();return n>=e.left&&n<=e.right&&s>=e.top&&s<=e.bottom};e&&(h(!0),e?.classList.add("show"),o=setTimeout((()=>{const o=t.querySelector(".sticky-button-container");i(e)||i(o)||b?.classList.remove("show")}),7e3))}m.addEventListener("mouseenter",(()=>{m.querySelector(".chat-icon").classList.contains("hidden")&&(h(!0),b?.classList.add("show"),T())})),m.addEventListener("mouseleave",(t=>{t.relatedTarget?.closest(".suggestions-list")||setTimeout((()=>{b?.classList.remove("show")}),2e3)})),u.addEventListener("mouseenter",(()=>{b?.classList.remove("show")})),p.addEventListener("mouseenter",(()=>{b?.classList.remove("show")}));t.querySelector(".sticky-button-container").addEventListener("mouseleave",(()=>{setTimeout((()=>{b?.classList.remove("show")}),2e3)})),b.addEventListener("mouseenter",(()=>{o&&(clearTimeout(o),o=null)})),b.addEventListener("mouseleave",v),window.addEventListener("resize",T)}async function E(t){return String(t).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;").replace(/\n/g,"<br>")}function L(t){const e=document.createElement("div");return e.className="suggestions-list",t.forEach((t=>{const o=document.createElement("div");o.className="suggestion-item";const n=document.createElement("i");n.className=`fas fa-${t.icon}`;const s=document.createElement("span");if("do_nothing"===t.action){o.title="Click to copy to clipboard",o.classList.add("copyable");const t=document.createElement("i");if(t.className="fas fa-copy copy-indicator",t.style.cssText="\n\t\t\t\tfont-size: 10px;\n\t\t\t\tmargin-left: 5px;\n\t\t\t\tcolor: rgba(255,255,255,0.6);\n\t\t\t",!shadowRoot.querySelector("#copyable-style")){const t=document.createElement("style");t.id="copyable-style",t.textContent="\n\t\t\t\t\t.suggestion-item.copyable {\n\t\t\t\t\t\tposition: relative;\n\t\t\t\t\t}\n\t\t\t\t\t.suggestion-item.copyable:hover {\n\t\t\t\t\t\tbackground-color: rgba(4, 164, 146, 0.1);\n\t\t\t\t\t}\n\t\t\t\t\t.suggestion-item .copy-indicator {\n\t\t\t\t\t\topacity: 0.6;\n\t\t\t\t\t\ttransition: opacity 0.2s ease;\n\t\t\t\t\t}\n\t\t\t\t\t.suggestion-item.copyable:hover .copy-indicator {\n\t\t\t\t\t\topacity: 1;\n\t\t\t\t\t}\n\t\t\t\t",shadowRoot.appendChild(t)}}(async function(t){try{if(window.bgptMarked){if("function"==typeof window.bgptMarked)return window.bgptMarked(t);if("function"==typeof window.bgptMarked.parse)return window.bgptMarked.parse(t)}return E(t)}catch(e){return E(t)}})(t.text).then((i=>{if(s.innerHTML=i,o.appendChild(n),o.appendChild(s),"do_nothing"===t.action){const t=document.createElement("i");t.className="fas fa-copy copy-indicator",t.style.cssText="\n\t\t\t\t\tfont-size: 10px;\n\t\t\t\t\tmargin-left: 5px;\n\t\t\t\t\tcolor: rgba(255,255,255,0.6);\n\t\t\t\t",o.appendChild(t)}o.addEventListener("click",(()=>{!function(t,e){switch(t){case"scroll_next":window.scrollBy({top:window.innerHeight,behavior:"smooth"});break;case"scroll_top":case"scroll_up":const t=document.querySelector('[class*="scroll"], [class*="overflow"], [class*="main"]')||document.documentElement;t!==document.documentElement&&t.scrollTo({top:0,behavior:"smooth"}),window.scrollTo({top:0,behavior:"smooth"});break;case"scroll_down":const o=document.querySelector('[class*="scroll"], [class*="overflow"], [class*="main"]')||document.documentElement;o!==document.documentElement&&o.scrollTo({top:Math.max(o.scrollHeight,o.offsetHeight),behavior:"smooth"}),window.scrollTo({top:Math.max(document.body.scrollHeight,document.documentElement.scrollHeight,document.body.offsetHeight,document.documentElement.offsetHeight),behavior:"smooth"});break;case"trigger_license_prompt":N(!0,m),setTimeout((()=>{N(!1,m)}),4e3),licenseTrigger(!0);break;case"do_nothing":navigator.clipboard.writeText(e).then((()=>{I("Copied to clipboard","success")})).catch((t=>{I("Failed to copy to clipboard","error")}));break;case"open_stealth_mode":C(!0);break;case"close_sticky_mode":a=!0,C(!0,"sticky");break;case"ask_clarifying_questions":N(!0,m),R(y,"both"),q(y,"bottom"),window.postMessage({type:"BGPT_INVOKE_EXTENSION",action:"generateSuggestions",currentStateId:setCurrentStateId,showLoading:!0,bgptIndex:!1,extraInstructions:e});break;default:toggleCancelMode(!0),window.postMessage({type:"BGPT_INVOKE_EXTENSION",action:"captureTab",prompt:e,data:null,apikey:getLicenseKey(),bgptIndex:!1,novaUrl:"",currentStateId:setCurrentStateId,instructionId:Date.now(),enforceUserConfirmation:!1,enable_realtime_mode:!1,directExecution:!1,stepsLimit:10,maxAttempts:3},"*")}}(t.action,t.text),h(!1),"do_nothing"!==t.action&&e.classList.remove("show")})),e.appendChild(o)}))})),e.addEventListener("mouseleave",v),e}function x(t=null){let e=m.querySelector(".chat-icon");t||(t=e&&!e.classList.contains("hidden")?"Hover for 3s to see suggestions":"Hover for 3s to see chat"),document.documentElement.style.setProperty("--chat-button-tooltip",`"${t}"`),m&&m.classList.add("show-tooltip")}function k(){m&&m.classList.remove("show-tooltip")}function _(t){k(),setTimeout((()=>{x(t)}),100)}function T(){if(!b||!m)return;const t=m.getBoundingClientRect(),e=window.innerHeight;b.style.bottom="",b.style.top="",b.style.visibility="hidden",b.style.display="block";const o=b.scrollHeight;b.style.display="",b.style.visibility="";const n=e-t.bottom,s=t.top;n<o&&s>n?(b.style.bottom=`${t.height+10}px`,b.style.top="auto"):(b.style.top=`${t.height+10}px`,b.style.bottom="auto");const i=Math.min(300,Math.max(n,s)-20);b.style.maxHeight=`${i}px`}function C(o,n="normal"){if(!t)return;const s=shadowRoot.querySelector(".sticky-button-container");o?(e=!0,s&&(s.style.display="none"),"normal"===n&&t.openPip()):(e=!1,s&&(s.style.display=""),t.closePip())}!function(){if(shadowRoot.querySelector("#suggestions-list-style"))return;const t=document.createElement("style");t.id="suggestions-list-style",t.textContent="\n\t\t.suggestions-list {\n\t\t\tmax-height: 300px;\n\t\t\toverflow-y: auto;\n\t\t\tscrollbar-width: none; /* Firefox */\n\t\t\t-ms-overflow-style: none; /* IE and Edge */\n\t\t}\n\t\t.suggestions-list::-webkit-scrollbar {\n\t\t\tdisplay: none; /* Chrome, Safari, Opera */\n\t\t}\n\t",shadowRoot.appendChild(t)}();const q=(t=y,e="both")=>{if(t)if("undefined"!=typeof shadowRoot&&shadowRoot){const t=shadowRoot.querySelectorAll(".sticky-button.top"),o=shadowRoot.querySelectorAll(".sticky-button.bottom");"top"!==e&&"both"!==e||t.forEach((t=>{t.style.opacity="1",t.style.visibility="visible",t.style.transform="translateY(0)"})),"bottom"!==e&&"both"!==e||o.forEach((t=>{t.style.opacity="1",t.style.visibility="visible",t.style.transform="translateY(0)"}))}else{const o=t.querySelectorAll(".sticky-button.top"),n=t.querySelectorAll(".sticky-button.bottom");"top"!==e&&"both"!==e||o.forEach((t=>{t.style.opacity="1",t.style.visibility="visible",t.style.transform="translateY(0)"})),"bottom"!==e&&"both"!==e||n.forEach((t=>{t.style.opacity="1",t.style.visibility="visible",t.style.transform="translateY(0)"}))}},R=(t,e="both")=>{if(t)if("undefined"!=typeof shadowRoot&&shadowRoot){const t=shadowRoot.querySelectorAll(".sticky-button.top"),o=shadowRoot.querySelectorAll(".sticky-button.bottom");"top"!==e&&"both"!==e||t.forEach((t=>{t.style.opacity="",t.style.visibility="",t.style.transform=""})),"bottom"!==e&&"both"!==e||o.forEach((t=>{t.style.opacity="",t.style.visibility="",t.style.transform=""}))}else{const o=t.querySelectorAll(".sticky-button.top"),n=t.querySelectorAll(".sticky-button.bottom");"top"!==e&&"both"!==e||o.forEach((t=>{t.style.opacity="",t.style.visibility="",t.style.transform=""})),"bottom"!==e&&"both"!==e||n.forEach((t=>{t.style.opacity="",t.style.visibility="",t.style.transform=""}))}};function I(t,e="success"){if(!b)return;let o=shadowRoot.querySelector(".suggestions-notification-container");o||(o=document.createElement("div"),o.className="suggestions-notification-container",o.style.cssText="\n\t\t\tposition: absolute;\n\t\t\ttop: 0;\n\t\t\tleft: 0;\n\t\t\tright: 0;\n\t\t\tdisplay: flex;\n\t\t\tflex-direction: column;\n\t\t\talign-items: center;\n\t\t\tjustify-content: center;\n\t\t\tpointer-events: none;\n\t\t\tz-index: 1000;\n\t\t",b.appendChild(o));const n=document.createElement("div");n.className=`suggestions-notification suggestions-notification-${e}`,n.textContent=t,n.style.cssText=`\n\t\tpadding: 8px 16px;\n\t\tborder-radius: 4px;\n\t\tmargin: 8px;\n\t\tfont-size: 14px;\n\t\tfont-weight: 500;\n\t\tbox-shadow: 0 2px 4px rgba(0,0,0,0.2);\n\t\topacity: 0;\n\t\ttransition: opacity 0.3s ease-in-out;\n\t\tcolor: white;\n\t\tbackground-color: ${"error"===e?"#f44336":"#04A492"};\n\t\tpointer-events: none;\n\t\ttext-align: center;\n\t\tmax-width: 90%;\n\t`,o.appendChild(n),setTimeout((()=>{n.style.opacity="1"}),10),setTimeout((()=>{n.style.opacity="0",setTimeout((()=>{n&&n.parentNode&&n.parentNode.removeChild(n),o&&0===o.children.length&&o.parentNode.removeChild(o)}),300)}),2e3)}function N(t,e=null){n=t,t?(s=Date.now(),i&&(clearTimeout(i),i=null),i=setTimeout((()=>{const t=Date.now();n&&t-s>=59e3&&N(!1,e)}),6e4)):i&&(clearTimeout(i),i=null),toggleSpinnerMode(t,e)}!function(){const t=shadowRoot.querySelector(".kebab-handle");t.addEventListener("mousedown",(function(t){l=!0,this.style.cursor="grabbing",function(t){l=!0;const e=shadowRoot.querySelector(".sticky-button-container");c=t.clientY,r=parseInt(getComputedStyle(e).top)}(t)})),t.addEventListener("mouseup",(function(t){l=!1,this.style.cursor="grab",g()})),window.addEventListener("mousemove",(function(t){if(l){const e=shadowRoot.querySelector(".sticky-button-container"),o=t.clientY-c;e.style.top=`${r+o}px`}})),window.addEventListener("pointermove",(function(t){if(l){const e=shadowRoot.querySelector(".sticky-button-container"),o=t.clientY-c;e.style.top=`${r+o}px`}})),window.addEventListener("mouseup",g),window.addEventListener("pointerup",g),globalButton=p,p.addEventListener("mousedown",(function(t){t.target.closest(".kebab-handle")||this.classList.add("active")})),p.addEventListener("mouseup",(function(t){this.classList.remove("active")})),p.addEventListener("mouseleave",(function(t){this.classList.remove("active")})),m.addEventListener("mousedown",(function(t){if(t.preventDefault(),!t.target.closest(".kebab-handle")){const t=m.querySelector(".chat-icon");if(t&&!t.classList.contains("hidden"))window.postMessage({type:"BGPT_INVOKE_EXTENSION",action:"handleChatButtonClick",currentStateId:setCurrentStateId,bgptIndex:!1},"*"),N(!0,m);else{N(!0,m),R(y,"both"),q(y,"bottom"),window.postMessage({type:"BGPT_INVOKE_EXTENSION",action:"generateSuggestions",currentStateId:setCurrentStateId,showLoading:!0,bgptIndex:!1,extraInstructions:""},"*");const t=shadowRoot.querySelector(".suggestions-list");t&&t.classList.add("loading")}}const e=document.getElementById("modal");if(e){const t=e.querySelector(".modal-content");e.addEventListener("click",(function(o){t.contains(o.target)||e.classList.add("hidden")}))}})),u.addEventListener("mousedown",(function(t){if(t.preventDefault(),t.target.closest(".kebab-handle"))return;showSupportForm();const e=o.querySelector(".modal-content");o.addEventListener("click",(function(t){e.contains(t.target)||o&&o.classList&&!o.classList.contains("hidden")&&o.classList.add("hidden")}))}));const o=shadowRoot.querySelector("#support-form-modal");if(o){const t=o.querySelector(".modal-close-button"),e=o.querySelector("#help-form");t&&t.addEventListener("click",(function(t){t.preventDefault(),o.classList.add("hidden")})),e&&e.addEventListener("submit",(async function(t){handleFormSubmit(t)}))}const n=document.getElementById("modal"),s=document.getElementById("close-modal");s&&n&&s.addEventListener("click",(function(t){t.preventDefault(),n.classList.add("hidden")})),function(t){if(a)return;const o=m.querySelector(".chat-icon"),n=m.querySelector(".lightbulb-icon");let s=w()?f:f.filter((t=>!["scroll_down","scroll_top"].includes(t.action)));s.length>0?(o.classList.add("hidden"),n.classList.remove("hidden"),b=L(s),y.appendChild(b),S(t,dontPopOut=!0)):(o.classList.remove("hidden"),n.classList.add("hidden"),b=null);window.addEventListener("message",(function(s){if(s.data&&"PIP_CLOSED"===s.data.type&&"show_sticky_container"===s.data.action){e=!1;const o=t.querySelector(".sticky-button-container");o&&(o.style.display="")}else if(s.source===window&&"BGPT_FROM_EXTENSION"===s.data.type&&"updateSuggestions"===s.data.content.action){if(N(!1,m),R(y,"both"),b&&b.classList.remove("loading"),"smartSenseDisabled"===s.data.content.message)return void showAlert("BrowserGPT SmartSense is disabled. Please enable it via Voice Prompt.");if("loading"===s.data.content.message)return N(!0,m),void b.classList.add("loading");if("error"===s.data.content.message||"error403"===s.data.content.message){let t={text:"error403"===s.data.content.message?"Your license key is invalid or expired. Please click here to update your license key to continue using BrowserGPT":"Error generating suggestions. Please try again later.",icon:"exclamation-triangle",action:"do_nothing"};e&&a||("error403"===s.data.content.message?showAlert("Your license key is invalid or expired. Please click here to update your license key to continue using BrowserGPT",(()=>{licenseTrigger(!0)})):showAlert("Error generating suggestions. Please try again later.")),Array.isArray(s.data.content.message)||(s.data.content.message=[]),s.data.content.message.push(t)}if("no_suggestions"===s.data.content.message){let t={text:"No suggestions available. Please try again later.",icon:"exclamation-triangle",action:"do_nothing"};e||a||showAlert("No suggestions available. Please try again later."),Array.isArray(s.data.content.message)||(s.data.content.message=[]),s.data.content.message.push(t)}const i=t.querySelector(".suggestions-list");if(i&&i.classList.remove("loading"),N(!1,m),!s.data.content.message)return;if(!Array.isArray(s.data.content.message))return;let c=w()?s.data.content.message:s.data.content.message.filter((t=>!["scroll_down","scroll_top"].includes(t.action)));if("function"==typeof broadCastData){const t=c.map((t=>t.text));if("function"==typeof addMessageToChatHistory&&addMessageToChatHistory(senderAI,"Sending new suggestions to mobile...",!1),broadCastData("updateSuggestions",t),a)return}if(c.push({text:"Open SmartSense in Stealth Mode",icon:"eye",action:"open_stealth_mode"}),c.push({text:"Close Sticky",icon:"times",action:"close_sticky_mode"}),c&&c.length>0){o.classList.add("hidden"),n.classList.remove("hidden"),b&&b.removeEventListener("mouseleave",v);const e=L(c);b&&b.parentNode?y.replaceChild(e,b):y.appendChild(e),b=e,S(t)}else o.classList.remove("hidden"),n.classList.add("hidden"),b&&b.parentNode&&b.remove(),b=null}}))}(shadowRoot)}(shadowRoot),function(){if(!m)return;let t=!1;m.addEventListener("mouseenter",(function(){t=!0,x(),d&&clearTimeout(d),d=setTimeout((function(){if(t){k();const t=m.querySelector(".chat-icon"),e=m.querySelector(".lightbulb-icon");t&&!t.classList.contains("hidden")?(t.classList.add("hidden"),e.classList.remove("hidden"),_("Click to fetch suggestions"),b&&b.classList.add("show")):e&&!e.classList.contains("hidden")&&(e.classList.add("hidden"),t.classList.remove("hidden"),_("Hover for 3s to see suggestions"))}}),3e3)})),m.addEventListener("mouseleave",(function(){t=!1,k(),d&&(clearTimeout(d),d=null)}))}(),window.openSticky=function(){a=!1}})();