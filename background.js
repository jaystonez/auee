(()=>{"use strict";var e={206:(e,t,n)=>{n.d(t,{BH:()=>l,Bl:()=>a,J0:()=>u,K5:()=>c,iB:()=>i});let r=new AbortController;const s=globalThis.fetch,o=new Set;function i(e){o.add(e)}function a(e){o.delete(e)}function c(){r.abort(),globalThis.socket&&(o.forEach((e=>{globalThis.socket.emit("abort_request",{requestId:e})})),o.clear()),r=new AbortController}async function u(){globalThis.fetch=async function(e,t={}){const n={...t,signal:t.signal?AbortSignal.any([t.signal,r.signal]):r.signal};try{const t=await s(e,n);if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);return t}catch(e){if("AbortError"===e.name)throw new Error("Operation cancelled by user");throw e}}}function l(){return r.signal}},565:(e,t,n)=>{n.d(t,{Em:()=>o,je:()=>c,uk:()=>i});var r=n(413);async function s(e,t,n){return new Promise(((n,r)=>{chrome.tabs.sendMessage(e,t,(e=>{chrome.runtime.lastError?r(chrome.runtime.lastError.message):n(e)}))}))}async function o(e,t,n=100){try{const n=await(0,r.id)(e);if(!n)return;await s(e,{action:"sendMessagetoUser",status:"dont_override_nova_agent_mode",message:"Disconnecting from the Bgpt Socket",bgptIndex:!1,stateId:t,playSpeech:!1},n.url)}catch(e){}}async function i(e,t,n){t&&await s(e,{action:"sendMessagetoUser",status:"override_nova_agent_mode",message:"Connect to the Bgpt Socket",bgptIndex:!1,stateId:n,playSpeech:!1})}async function a(e,t,n=null){try{const s=await(0,r.id)(e);s&&s.url||(e=null,s.url=null);const a=s?.url;if(a&&(a.startsWith("chrome://")||a.startsWith("about:")))return;const c=await(0,r.bQ)("previousActiveTabId");c&&await(0,r.id)(c);if(e!==c&&await(0,r.XO)("activeTabId",e),c&&c!==e&&await o(c,t),null!==e&&c!==e&&await(0,r.XO)("previousActiveTabId",e),e&&c!==e){await i(e,a,t);const n=await(0,r.bQ)("bgptLicenseKey");(0,r.Y7)("license_key",n,e,t)}else if(e&&n){await i(e,a,t);const n=await(0,r.bQ)("bgptLicenseKey");(0,r.Y7)("license_key",n,e,t)}}catch(e){}}function c(e){chrome.tabs.onActivated.addListener((t=>{a(t.tabId,e)})),chrome.windows.onFocusChanged.addListener((async t=>{if(t!==chrome.windows.WINDOW_ID_NONE){const[n]=await chrome.tabs.query({active:!0,windowId:t});n&&a(n.id,e,!0)}})),chrome.webNavigation.onCompleted.addListener((t=>{!async function(e,t,n,s){if(t&&0===n&&!t.startsWith("chrome://")&&!t.startsWith("about:"))try{const n=await(0,r.bQ)("activeTabId");if(n&&await(0,r.id)(n),n&&e!==n)return;null===n&&await(0,r.XO)("activeTabId",e);const a=await(0,r.bQ)("previousActiveTabId");a&&await(0,r.id)(a),a&&a!==e&&await o(a,s),await i(e,t,s);const c=await(0,r.bQ)("bgptLicenseKey");(0,r.Y7)("license_key",c,e,s)}catch(e){}}(t.tabId,t.url,t.frameId,e)}))}},384:(e,t,n)=>{n.d(t,{J:()=>r});const r="https://api.browser.civai.co"},851:(e,t,n)=>{n.d(t,{t:()=>o});var r=n(384),s=n(413);async function o(e=null){try{let t=null;if(t=await(0,s.bQ)("chatHistory"),!e&&!t)throw new Error("Either conversations or conversation_data must be provided");const n=await fetch(`${r.J}/index_conversations`,{method:"POST",headers:{"Content-Type":"application/json","bgpt-license-key":await(0,s.bQ)("bgptLicenseKey")},body:JSON.stringify({conversations:t,conversation_data:e})});if(!n.ok){const e=await n.json();throw new Error(e.detail||"Failed to index conversations")}return await n.json()}catch(e){}}},285:(e,t,n)=>{async function r(e,t,n){if(!chrome.debugger)return{success:!1,error:"Debugger API not available"};try{await new Promise(((t,n)=>{chrome.debugger.attach({tabId:e},"1.3",(()=>{chrome.runtime.lastError?n(new Error(chrome.runtime.lastError.message)):t()}))})),await new Promise(((t,n)=>{chrome.debugger.sendCommand({tabId:e},"DOM.enable",{},(e=>{chrome.runtime.lastError?n(new Error(chrome.runtime.lastError.message)):t(e)}))}));const r=await new Promise(((t,n)=>{chrome.debugger.sendCommand({tabId:e},"DOM.getDocument",{depth:0},(e=>{chrome.runtime.lastError?n(new Error(chrome.runtime.lastError.message)):t(e)}))}));if(!r||!r.root||!r.root.nodeId)throw new Error("Failed to get document root");const s=await new Promise(((n,s)=>{chrome.debugger.sendCommand({tabId:e},"DOM.querySelector",{nodeId:r.root.nodeId,selector:t},(e=>{chrome.runtime.lastError?s(new Error(chrome.runtime.lastError.message)):n(e)}))}));if(!s||!s.nodeId)throw new Error(`Element not found: ${t}`);await new Promise(((t,n)=>{chrome.debugger.sendCommand({tabId:e},"DOM.focus",{nodeId:s.nodeId},(e=>{chrome.runtime.lastError?n(new Error(chrome.runtime.lastError.message)):t(e)}))}));const o=`\n\t\t\t(() => {\n\t\t\t\tconst selector = '${t.replace(/\\/g,"\\\\")}';  // Double escape backslashes\n\t\t\t\tconst element = document.querySelector(selector);\n\t\t\t\tif (element) {\n\t\t\t\t\telement.value = '${n.replace(/'/g,"\\'")}';\n\t\t\t\t\telement.dispatchEvent(new Event('input', { bubbles: true }));\n\t\t\t\t\telement.dispatchEvent(new Event('change', { bubbles: true }));\n\t\t\t\t\treturn true;\n\t\t\t\t} else {\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t})()\n\t\t`;return await new Promise(((t,n)=>{chrome.debugger.sendCommand({tabId:e},"Runtime.evaluate",{expression:o,returnByValue:!0},(e=>{chrome.runtime.lastError?n(new Error(chrome.runtime.lastError.message)):e.result&&e.result.value?t(e):n(new Error("Failed to set input value"))}))})),await new Promise((t=>chrome.debugger.detach({tabId:e},t))),{success:!0}}catch(t){try{await new Promise((t=>chrome.debugger.detach({tabId:e},t)))}catch(e){}return{success:!1,error:"object"==typeof t?t.message:String(t)}}}async function s(){try{const e=54784092,t=await chrome.tabs.get(e);await chrome.windows.update(t.windowId,{focused:!0}),await chrome.tabs.update(e,{active:!0});(await r(e,"#ea7abc928dcc1b352dcc9ecff96213cf","Test input from debugger")).success}catch(e){}}n.d(t,{Sp:()=>r,uZ:()=>s})},506:(e,t,n)=>{n.d(t,{FK:()=>k,Iz:()=>y,S4:()=>v,pq:()=>E});var r=n(413),s=n(384);let o=null,i={},a={},c={},u=null;const l=3e5,d=9e5,h=5;let p=0,m=d,f=0,g=!1;async function b(e,t,n=""){try{if(!w(e,t))return null;const o=await(0,r.VS)(e),i=await(0,r.lz)(e,"summarize");if(!o)return null;const a=await(0,r.bQ)("bgptLicenseKey"),c=await fetch(`${s.J}/determine_intent`,{method:"POST",headers:{"Content-Type":"application/json","bgpt-license-key":a},body:JSON.stringify({url:t,image:o,text_elements:i,multiple_suggestions:!0,extra_instructions:n})});if(!c.ok)throw Object.assign(new Error(`HTTP error! status: ${c.status}`),{statusCode:c.status});return await c.json()}catch(e){const t=e.statusCode?String(e.statusCode):null;return t&&["403","429","500","502","503","504"].includes(t)?t:null}}function y(e){return{fill_in_the_form:"lightbulb",send_message:"comment",summarize_page:"book-open",post_tweet:"hashtag",analyze_trading_chart:"chart-line",scroll_down:"arrow-down",scroll_top:"arrow-up",no_action:"times"}[e]||"lightbulb"}async function _(){let e=await(0,r.bQ)("runSmartSense");return null!=e&&null!=e||(e=!0,await(0,r.XO)("runSmartSense",!0)),e}async function w(e,t){const n=await(0,r.bQ)("activeTabId");return!n||t.includes("browser.civai.co")||t.includes("browsergpt.co")||n===e}async function v(e,t,n=!0){try{let s=await(0,r.bQ)("stateId");if(!t||t.includes("chrome://")||t.includes("about:")||t.includes("file://"))return null;const o=await(0,r.bQ)("previousActiveTabId");if(o&&o===e&&n)return;const i=Date.now();if(!function(e){const t=e-f;if(g){if(!(t>=m))return!1;g=!1,p=0,m=d}if(t<m)return!1;p++,p>=h&&(g=!0,m=d*h);return f=e,!0}(i)&&n)return;if(!await _()){const n=await(0,r.bQ)("bgptLicenseKey");if(!await(0,r.AN)(n))return;{const n=await(0,r.VS)(e),o=`\n\t\t\t\t\n\t\t\t\tSYSTEM Notification: \n                                            \n\t\t\t\tUser is currently on the webpage ${t} \n\t\t\t\t\n\t\t\t\tHere is the Visual Description of the webpage: \n\t\t\t\t${await(0,r.s4)(n)}.\n\t\t\t\t`;(0,r.Y7)("captureScreen",o,e,s)}return}if(await async function(){const e=await(0,r.vH)();if(e&&Date.now()-e.timestamp<l&&null!==e.task)return!0;return!1}())return;const v=c[e]>i;if(!await w(e,t)&&n)return;if(v&&n)return;(0,r.u3)(e,{action:"updateSuggestions",message:"loading",stateId:s,bgptIndex:!1});const k=await b(e,t);if(a[e]=Date.now(),await(0,r.XO)("activeTabId",e),await(0,r.XO)("previousActiveTabId",u),k&&Array.isArray(k)){const t=k.filter((e=>"no_action"!==e.action)).map((e=>({text:e.instruction,icon:y(e.action),action:e.action})));t.length>0?(0,r.u3)(e,{action:"updateSuggestions",message:t,stateId:s,bgptIndex:!1}):(0,r.u3)(e,{action:"updateSuggestions",message:null,stateId:s,bgptIndex:!1})}}catch(e){}}function k(e){o=e,chrome.tabs.onActivated.addListener((e=>{u=e.tabId,i[e.tabId]=Date.now(),(0,r.id)(e.tabId).then((t=>{v(e.tabId,t.url)}))})),chrome.windows.onFocusChanged.addListener((async e=>{if(e!==chrome.windows.WINDOW_ID_NONE){const[t]=await chrome.tabs.query({active:!0,windowId:e});t&&v(t.id,t.url)}})),chrome.tabs.onRemoved.addListener((e=>{delete i[e],delete a[e],delete c[e],u===e&&(u=null)}))}async function E(e,t=!0,n=""){try{const t=await(0,r.id)(e);if(!t||!t.url)return!1;const s=t.url;if(!s||s.includes("chrome://")||s.includes("about:")||s.includes("file://"))return!1;const o=await(0,r.bQ)("stateId");if(!await _()){const t=[{text:"BrowserGPT SmartSense is disabled. Please enable it via Voice Prompt.",icon:"exclamation-triangle",action:"do_nothing"}];return(0,r.u3)(e,{action:"updateSuggestions",message:t,stateId:o,bgptIndex:!1}),!1}const i=await b(e,s,n);if(i&&Array.isArray(i)){const t=i.filter((e=>"no_action"!==e.action)).map((e=>({text:e.instruction,icon:y(e.action),action:e.action})));if(t.length>0)return(0,r.u3)(e,{action:"updateSuggestions",message:t,stateId:o,bgptIndex:!1}),!0;{const t=[{text:"No suggestions available. Please try again later.",icon:"exclamation-triangle",action:"do_nothing"}];return(0,r.u3)(e,{action:"updateSuggestions",message:t,stateId:o,bgptIndex:!1}),!1}}if("403"===i){const t=[{text:"Your license key is invalid or expired. Please click here to update your license key to continue using BrowserGPT",icon:"exclamation-triangle",action:"trigger_license_prompt"}];return(0,r.u3)(e,{action:"updateSuggestions",message:t,stateId:o,bgptIndex:!1}),!1}if("429"===i){const t=[{text:"You have made too many requests. Please wait a few minutes before trying again.",icon:"exclamation-triangle",action:"do_nothing"}];return(0,r.u3)(e,{action:"updateSuggestions",message:t,stateId:o,bgptIndex:!1}),!1}{const t=[{text:"Error generating suggestions. Please try again later.",icon:"exclamation-triangle",action:"do_nothing"}];return(0,r.u3)(e,{action:"updateSuggestions",message:t,stateId:o,bgptIndex:!1}),!1}}catch(t){const n=await(0,r.bQ)("stateId"),s=[{text:"Error generating suggestions. Please try again later.",icon:"exclamation-triangle",action:"do_nothing"}];return(0,r.u3)(e,{action:"updateSuggestions",message:s,stateId:n,bgptIndex:!1}),!1}}},573:(e,t,n)=>{n.d(t,{A:()=>s});var r=n(413);const s=class{constructor(e){this.socket=e,this.initialize(),this.notificationTimeouts={}}initialize(){this.socket.on("bgpt_extension_notification",(e=>{this.handleNotification(e)})),"granted"!==Notification.permission&&Notification.requestPermission(),chrome.notifications.onClosed.addListener(this.handleNotificationClosed.bind(this)),chrome.notifications.onButtonClicked.addListener(this.handleNotificationClick.bind(this)),this.cleanupOrphanedNotificationData()}handleNotification(e){const{title:t,message:n,type:r,action:s}=e,o=`bgpt_${Date.now()}`;s&&(chrome.storage.local.set({[`bgtp_notification_action_${o}`]:s}),this.notificationTimeouts[o]=setTimeout((()=>{this.cleanupNotificationData(o)}),864e5));const i={type:"basic",iconUrl:chrome.runtime.getURL("icon.png"),title:t,message:n,priority:"error"===r?2:1,requireInteraction:"error"===r};chrome.notifications.create(o,i,(e=>{}))}handleNotificationClick(e,t){chrome.storage.local.get([`bgtp_notification_action_${e}`],(t=>{const n=t[`bgtp_notification_action_${e}`];n?(this.executeAction(n),this.cleanupNotificationData(e)):(this.getOrCreateTab(),(0,r.xo)("https://browsergpt.co").catch((e=>{})))}))}handleNotificationClosed(e,t){this.cleanupNotificationData(e)}cleanupNotificationData(e){this.notificationTimeouts[e]&&(clearTimeout(this.notificationTimeouts[e]),delete this.notificationTimeouts[e]),chrome.storage.local.remove(`bgtp_notification_action_${e}`,(()=>{}))}cleanupOrphanedNotificationData(){chrome.storage.local.get(null,(e=>{const t=Date.now();for(const n in e)if(n.startsWith("bgtp_notification_action_")){const e=n.replace("bgtp_notification_action_","");t-parseInt(e.replace("bgpt_",""))>864e5&&chrome.storage.local.remove(n)}}))}executeAction(e){switch(e.type){case"open_url":chrome.tabs.create({url:e.url});break;case"focus_tab":chrome.tabs.update(e.tabId,{active:!0})}}getOrCreateTab(){chrome.tabs.query({url:chrome.runtime.getURL("index.html")},(e=>{e.length>0?(chrome.tabs.update(e[0].id,{active:!0}),chrome.windows.update(e[0].windowId,{focused:!0})):chrome.tabs.create({url:chrome.runtime.getURL("index.html")})}))}}},31:(e,t,n)=>{n.d(t,{s:()=>je,w:()=>Be});var r={};n.r(r),n.d(r,{Decoder:()=>be,Encoder:()=>fe,PacketType:()=>me,protocol:()=>pe});const s=Object.create(null);s.open="0",s.close="1",s.ping="2",s.pong="3",s.message="4",s.upgrade="5",s.noop="6";const o=Object.create(null);Object.keys(s).forEach((e=>{o[s[e]]=e}));const i={type:"error",data:"parser error"},a="function"==typeof Blob||"undefined"!=typeof Blob&&"[object BlobConstructor]"===Object.prototype.toString.call(Blob),c="function"==typeof ArrayBuffer,u=e=>"function"==typeof ArrayBuffer.isView?ArrayBuffer.isView(e):e&&e.buffer instanceof ArrayBuffer,l=({type:e,data:t},n,r)=>a&&t instanceof Blob?n?r(t):d(t,r):c&&(t instanceof ArrayBuffer||u(t))?n?r(t):d(new Blob([t]),r):r(s[e]+(t||"")),d=(e,t)=>{const n=new FileReader;return n.onload=function(){const e=n.result.split(",")[1];t("b"+(e||""))},n.readAsDataURL(e)};function h(e){return e instanceof Uint8Array?e:e instanceof ArrayBuffer?new Uint8Array(e):new Uint8Array(e.buffer,e.byteOffset,e.byteLength)}let p;const m="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",f="undefined"==typeof Uint8Array?[]:new Uint8Array(256);for(let e=0;e<64;e++)f[m.charCodeAt(e)]=e;const g="function"==typeof ArrayBuffer,b=(e,t)=>{if("string"!=typeof e)return{type:"message",data:_(e,t)};const n=e.charAt(0);if("b"===n)return{type:"message",data:y(e.substring(1),t)};return o[n]?e.length>1?{type:o[n],data:e.substring(1)}:{type:o[n]}:i},y=(e,t)=>{if(g){const n=(e=>{let t,n,r,s,o,i=.75*e.length,a=e.length,c=0;"="===e[e.length-1]&&(i--,"="===e[e.length-2]&&i--);const u=new ArrayBuffer(i),l=new Uint8Array(u);for(t=0;t<a;t+=4)n=f[e.charCodeAt(t)],r=f[e.charCodeAt(t+1)],s=f[e.charCodeAt(t+2)],o=f[e.charCodeAt(t+3)],l[c++]=n<<2|r>>4,l[c++]=(15&r)<<4|s>>2,l[c++]=(3&s)<<6|63&o;return u})(e);return _(n,t)}return{base64:!0,data:e}},_=(e,t)=>"blob"===t?e instanceof Blob?e:new Blob([e]):e instanceof ArrayBuffer?e:e.buffer,w=String.fromCharCode(30);function v(){return new TransformStream({transform(e,t){!function(e,t){a&&e.data instanceof Blob?e.data.arrayBuffer().then(h).then(t):c&&(e.data instanceof ArrayBuffer||u(e.data))?t(h(e.data)):l(e,!1,(e=>{p||(p=new TextEncoder),t(p.encode(e))}))}(e,(n=>{const r=n.length;let s;if(r<126)s=new Uint8Array(1),new DataView(s.buffer).setUint8(0,r);else if(r<65536){s=new Uint8Array(3);const e=new DataView(s.buffer);e.setUint8(0,126),e.setUint16(1,r)}else{s=new Uint8Array(9);const e=new DataView(s.buffer);e.setUint8(0,127),e.setBigUint64(1,BigInt(r))}e.data&&"string"!=typeof e.data&&(s[0]|=128),t.enqueue(s),t.enqueue(n)}))}})}let k;function E(e){return e.reduce(((e,t)=>e+t.length),0)}function x(e,t){if(e[0].length===t)return e.shift();const n=new Uint8Array(t);let r=0;for(let s=0;s<t;s++)n[s]=e[0][r++],r===e[0].length&&(e.shift(),r=0);return e.length&&r<e[0].length&&(e[0]=e[0].slice(r)),n}function I(e){if(e)return function(e){for(var t in I.prototype)e[t]=I.prototype[t];return e}(e)}I.prototype.on=I.prototype.addEventListener=function(e,t){return this._callbacks=this._callbacks||{},(this._callbacks["$"+e]=this._callbacks["$"+e]||[]).push(t),this},I.prototype.once=function(e,t){function n(){this.off(e,n),t.apply(this,arguments)}return n.fn=t,this.on(e,n),this},I.prototype.off=I.prototype.removeListener=I.prototype.removeAllListeners=I.prototype.removeEventListener=function(e,t){if(this._callbacks=this._callbacks||{},0==arguments.length)return this._callbacks={},this;var n,r=this._callbacks["$"+e];if(!r)return this;if(1==arguments.length)return delete this._callbacks["$"+e],this;for(var s=0;s<r.length;s++)if((n=r[s])===t||n.fn===t){r.splice(s,1);break}return 0===r.length&&delete this._callbacks["$"+e],this},I.prototype.emit=function(e){this._callbacks=this._callbacks||{};for(var t=new Array(arguments.length-1),n=this._callbacks["$"+e],r=1;r<arguments.length;r++)t[r-1]=arguments[r];if(n){r=0;for(var s=(n=n.slice(0)).length;r<s;++r)n[r].apply(this,t)}return this},I.prototype.emitReserved=I.prototype.emit,I.prototype.listeners=function(e){return this._callbacks=this._callbacks||{},this._callbacks["$"+e]||[]},I.prototype.hasListeners=function(e){return!!this.listeners(e).length};const T="function"==typeof Promise&&"function"==typeof Promise.resolve?e=>Promise.resolve().then(e):(e,t)=>t(e,0),S="undefined"!=typeof self?self:"undefined"!=typeof window?window:Function("return this")();function P(e,...t){return t.reduce(((t,n)=>(e.hasOwnProperty(n)&&(t[n]=e[n]),t)),{})}const O=S.setTimeout,A=S.clearTimeout;function N(e,t){t.useNativeTimers?(e.setTimeoutFn=O.bind(S),e.clearTimeoutFn=A.bind(S)):(e.setTimeoutFn=S.setTimeout.bind(S),e.clearTimeoutFn=S.clearTimeout.bind(S))}function R(){return Date.now().toString(36).substring(3)+Math.random().toString(36).substring(2,5)}class C extends Error{constructor(e,t,n){super(e),this.description=t,this.context=n,this.type="TransportError"}}class $ extends I{constructor(e){super(),this.writable=!1,N(this,e),this.opts=e,this.query=e.query,this.socket=e.socket,this.supportsBinary=!e.forceBase64}onError(e,t,n){return super.emitReserved("error",new C(e,t,n)),this}open(){return this.readyState="opening",this.doOpen(),this}close(){return"opening"!==this.readyState&&"open"!==this.readyState||(this.doClose(),this.onClose()),this}send(e){"open"===this.readyState&&this.write(e)}onOpen(){this.readyState="open",this.writable=!0,super.emitReserved("open")}onData(e){const t=b(e,this.socket.binaryType);this.onPacket(t)}onPacket(e){super.emitReserved("packet",e)}onClose(e){this.readyState="closed",super.emitReserved("close",e)}pause(e){}createUri(e,t={}){return e+"://"+this._hostname()+this._port()+this.opts.path+this._query(t)}_hostname(){const e=this.opts.hostname;return-1===e.indexOf(":")?e:"["+e+"]"}_port(){return this.opts.port&&(this.opts.secure&&Number(443!==this.opts.port)||!this.opts.secure&&80!==Number(this.opts.port))?":"+this.opts.port:""}_query(e){const t=function(e){let t="";for(let n in e)e.hasOwnProperty(n)&&(t.length&&(t+="&"),t+=encodeURIComponent(n)+"="+encodeURIComponent(e[n]));return t}(e);return t.length?"?"+t:""}}class q extends ${constructor(){super(...arguments),this._polling=!1}get name(){return"polling"}doOpen(){this._poll()}pause(e){this.readyState="pausing";const t=()=>{this.readyState="paused",e()};if(this._polling||!this.writable){let e=0;this._polling&&(e++,this.once("pollComplete",(function(){--e||t()}))),this.writable||(e++,this.once("drain",(function(){--e||t()})))}else t()}_poll(){this._polling=!0,this.doPoll(),this.emitReserved("poll")}onData(e){((e,t)=>{const n=e.split(w),r=[];for(let e=0;e<n.length;e++){const s=b(n[e],t);if(r.push(s),"error"===s.type)break}return r})(e,this.socket.binaryType).forEach((e=>{if("opening"===this.readyState&&"open"===e.type&&this.onOpen(),"close"===e.type)return this.onClose({description:"transport closed by the server"}),!1;this.onPacket(e)})),"closed"!==this.readyState&&(this._polling=!1,this.emitReserved("pollComplete"),"open"===this.readyState&&this._poll())}doClose(){const e=()=>{this.write([{type:"close"}])};"open"===this.readyState?e():this.once("open",e)}write(e){this.writable=!1,((e,t)=>{const n=e.length,r=new Array(n);let s=0;e.forEach(((e,o)=>{l(e,!1,(e=>{r[o]=e,++s===n&&t(r.join(w))}))}))})(e,(e=>{this.doWrite(e,(()=>{this.writable=!0,this.emitReserved("drain")}))}))}uri(){const e=this.opts.secure?"https":"http",t=this.query||{};return!1!==this.opts.timestampRequests&&(t[this.opts.timestampParam]=R()),this.supportsBinary||t.sid||(t.b64=1),this.createUri(e,t)}}let L=!1;try{L="undefined"!=typeof XMLHttpRequest&&"withCredentials"in new XMLHttpRequest}catch(e){}const M=L;function j(){}class D extends q{constructor(e){if(super(e),"undefined"!=typeof location){const t="https:"===location.protocol;let n=location.port;n||(n=t?"443":"80"),this.xd="undefined"!=typeof location&&e.hostname!==location.hostname||n!==e.port}}doWrite(e,t){const n=this.request({method:"POST",data:e});n.on("success",t),n.on("error",((e,t)=>{this.onError("xhr post error",e,t)}))}doPoll(){const e=this.request();e.on("data",this.onData.bind(this)),e.on("error",((e,t)=>{this.onError("xhr poll error",e,t)})),this.pollXhr=e}}class U extends I{constructor(e,t,n){super(),this.createRequest=e,N(this,n),this._opts=n,this._method=n.method||"GET",this._uri=t,this._data=void 0!==n.data?n.data:null,this._create()}_create(){var e;const t=P(this._opts,"agent","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","autoUnref");t.xdomain=!!this._opts.xd;const n=this._xhr=this.createRequest(t);try{n.open(this._method,this._uri,!0);try{if(this._opts.extraHeaders){n.setDisableHeaderCheck&&n.setDisableHeaderCheck(!0);for(let e in this._opts.extraHeaders)this._opts.extraHeaders.hasOwnProperty(e)&&n.setRequestHeader(e,this._opts.extraHeaders[e])}}catch(e){}if("POST"===this._method)try{n.setRequestHeader("Content-type","text/plain;charset=UTF-8")}catch(e){}try{n.setRequestHeader("Accept","*/*")}catch(e){}null===(e=this._opts.cookieJar)||void 0===e||e.addCookies(n),"withCredentials"in n&&(n.withCredentials=this._opts.withCredentials),this._opts.requestTimeout&&(n.timeout=this._opts.requestTimeout),n.onreadystatechange=()=>{var e;3===n.readyState&&(null===(e=this._opts.cookieJar)||void 0===e||e.parseCookies(n.getResponseHeader("set-cookie"))),4===n.readyState&&(200===n.status||1223===n.status?this._onLoad():this.setTimeoutFn((()=>{this._onError("number"==typeof n.status?n.status:0)}),0))},n.send(this._data)}catch(e){return void this.setTimeoutFn((()=>{this._onError(e)}),0)}"undefined"!=typeof document&&(this._index=U.requestsCount++,U.requests[this._index]=this)}_onError(e){this.emitReserved("error",e,this._xhr),this._cleanup(!0)}_cleanup(e){if(void 0!==this._xhr&&null!==this._xhr){if(this._xhr.onreadystatechange=j,e)try{this._xhr.abort()}catch(e){}"undefined"!=typeof document&&delete U.requests[this._index],this._xhr=null}}_onLoad(){const e=this._xhr.responseText;null!==e&&(this.emitReserved("data",e),this.emitReserved("success"),this._cleanup())}abort(){this._cleanup()}}if(U.requestsCount=0,U.requests={},"undefined"!=typeof document)if("function"==typeof attachEvent)attachEvent("onunload",B);else if("function"==typeof addEventListener){addEventListener("onpagehide"in S?"pagehide":"unload",B,!1)}function B(){for(let e in U.requests)U.requests.hasOwnProperty(e)&&U.requests[e].abort()}const F=function(){const e=H({xdomain:!1});return e&&null!==e.responseType}();function H(e){const t=e.xdomain;try{if("undefined"!=typeof XMLHttpRequest&&(!t||M))return new XMLHttpRequest}catch(e){}if(!t)try{return new(S[["Active"].concat("Object").join("X")])("Microsoft.XMLHTTP")}catch(e){}}const z="undefined"!=typeof navigator&&"string"==typeof navigator.product&&"reactnative"===navigator.product.toLowerCase();class Y extends ${get name(){return"websocket"}doOpen(){const e=this.uri(),t=this.opts.protocols,n=z?{}:P(this.opts,"agent","perMessageDeflate","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","localAddress","protocolVersion","origin","maxPayload","family","checkServerIdentity");this.opts.extraHeaders&&(n.headers=this.opts.extraHeaders);try{this.ws=this.createSocket(e,t,n)}catch(e){return this.emitReserved("error",e)}this.ws.binaryType=this.socket.binaryType,this.addEventListeners()}addEventListeners(){this.ws.onopen=()=>{this.opts.autoUnref&&this.ws._socket.unref(),this.onOpen()},this.ws.onclose=e=>this.onClose({description:"websocket connection closed",context:e}),this.ws.onmessage=e=>this.onData(e.data),this.ws.onerror=e=>this.onError("websocket error",e)}write(e){this.writable=!1;for(let t=0;t<e.length;t++){const n=e[t],r=t===e.length-1;l(n,this.supportsBinary,(e=>{try{this.doWrite(n,e)}catch(e){}r&&T((()=>{this.writable=!0,this.emitReserved("drain")}),this.setTimeoutFn)}))}}doClose(){void 0!==this.ws&&(this.ws.onerror=()=>{},this.ws.close(),this.ws=null)}uri(){const e=this.opts.secure?"wss":"ws",t=this.query||{};return this.opts.timestampRequests&&(t[this.opts.timestampParam]=R()),this.supportsBinary||(t.b64=1),this.createUri(e,t)}}const W=S.WebSocket||S.MozWebSocket;const K={websocket:class extends Y{createSocket(e,t,n){return z?new W(e,t,n):t?new W(e,t):new W(e)}doWrite(e,t){this.ws.send(t)}},webtransport:class extends ${get name(){return"webtransport"}doOpen(){try{this._transport=new WebTransport(this.createUri("https"),this.opts.transportOptions[this.name])}catch(e){return this.emitReserved("error",e)}this._transport.closed.then((()=>{this.onClose()})).catch((e=>{this.onError("webtransport error",e)})),this._transport.ready.then((()=>{this._transport.createBidirectionalStream().then((e=>{const t=function(e,t){k||(k=new TextDecoder);const n=[];let r=0,s=-1,o=!1;return new TransformStream({transform(a,c){for(n.push(a);;){if(0===r){if(E(n)<1)break;const e=x(n,1);o=!(128&~e[0]),s=127&e[0],r=s<126?3:126===s?1:2}else if(1===r){if(E(n)<2)break;const e=x(n,2);s=new DataView(e.buffer,e.byteOffset,e.length).getUint16(0),r=3}else if(2===r){if(E(n)<8)break;const e=x(n,8),t=new DataView(e.buffer,e.byteOffset,e.length),o=t.getUint32(0);if(o>Math.pow(2,21)-1){c.enqueue(i);break}s=o*Math.pow(2,32)+t.getUint32(4),r=3}else{if(E(n)<s)break;const e=x(n,s);c.enqueue(b(o?e:k.decode(e),t)),r=0}if(0===s||s>e){c.enqueue(i);break}}}})}(Number.MAX_SAFE_INTEGER,this.socket.binaryType),n=e.readable.pipeThrough(t).getReader(),r=v();r.readable.pipeTo(e.writable),this._writer=r.writable.getWriter();const s=()=>{n.read().then((({done:e,value:t})=>{e||(this.onPacket(t),s())})).catch((e=>{}))};s();const o={type:"open"};this.query.sid&&(o.data=`{"sid":"${this.query.sid}"}`),this._writer.write(o).then((()=>this.onOpen()))}))}))}write(e){this.writable=!1;for(let t=0;t<e.length;t++){const n=e[t],r=t===e.length-1;this._writer.write(n).then((()=>{r&&T((()=>{this.writable=!0,this.emitReserved("drain")}),this.setTimeoutFn)}))}}doClose(){var e;null===(e=this._transport)||void 0===e||e.close()}},polling:class extends D{constructor(e){super(e);const t=e&&e.forceBase64;this.supportsBinary=F&&!t}request(e={}){return Object.assign(e,{xd:this.xd},this.opts),new U(H,this.uri(),e)}}},V=/^(?:(?![^:@\/?#]+:[^:@\/]*@)(http|https|ws|wss):\/\/)?((?:(([^:@\/?#]*)(?::([^:@\/?#]*))?)?@)?((?:[a-f0-9]{0,4}:){2,7}[a-f0-9]{0,4}|[^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/,J=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"];function Q(e){if(e.length>8e3)throw"URI too long";const t=e,n=e.indexOf("["),r=e.indexOf("]");-1!=n&&-1!=r&&(e=e.substring(0,n)+e.substring(n,r).replace(/:/g,";")+e.substring(r,e.length));let s=V.exec(e||""),o={},i=14;for(;i--;)o[J[i]]=s[i]||"";return-1!=n&&-1!=r&&(o.source=t,o.host=o.host.substring(1,o.host.length-1).replace(/;/g,":"),o.authority=o.authority.replace("[","").replace("]","").replace(/;/g,":"),o.ipv6uri=!0),o.pathNames=function(e,t){const n=/\/{2,9}/g,r=t.replace(n,"/").split("/");"/"!=t.slice(0,1)&&0!==t.length||r.splice(0,1);"/"==t.slice(-1)&&r.splice(r.length-1,1);return r}(0,o.path),o.queryKey=function(e,t){const n={};return t.replace(/(?:^|&)([^&=]*)=?([^&]*)/g,(function(e,t,r){t&&(n[t]=r)})),n}(0,o.query),o}const G="function"==typeof addEventListener&&"function"==typeof removeEventListener,X=[];G&&addEventListener("offline",(()=>{X.forEach((e=>e()))}),!1);class Z extends I{constructor(e,t){if(super(),this.binaryType="arraybuffer",this.writeBuffer=[],this._prevBufferLen=0,this._pingInterval=-1,this._pingTimeout=-1,this._maxPayload=-1,this._pingTimeoutTime=1/0,e&&"object"==typeof e&&(t=e,e=null),e){const n=Q(e);t.hostname=n.host,t.secure="https"===n.protocol||"wss"===n.protocol,t.port=n.port,n.query&&(t.query=n.query)}else t.host&&(t.hostname=Q(t.host).host);N(this,t),this.secure=null!=t.secure?t.secure:"undefined"!=typeof location&&"https:"===location.protocol,t.hostname&&!t.port&&(t.port=this.secure?"443":"80"),this.hostname=t.hostname||("undefined"!=typeof location?location.hostname:"localhost"),this.port=t.port||("undefined"!=typeof location&&location.port?location.port:this.secure?"443":"80"),this.transports=[],this._transportsByName={},t.transports.forEach((e=>{const t=e.prototype.name;this.transports.push(t),this._transportsByName[t]=e})),this.opts=Object.assign({path:"/engine.io",agent:!1,withCredentials:!1,upgrade:!0,timestampParam:"t",rememberUpgrade:!1,addTrailingSlash:!0,rejectUnauthorized:!0,perMessageDeflate:{threshold:1024},transportOptions:{},closeOnBeforeunload:!1},t),this.opts.path=this.opts.path.replace(/\/$/,"")+(this.opts.addTrailingSlash?"/":""),"string"==typeof this.opts.query&&(this.opts.query=function(e){let t={},n=e.split("&");for(let e=0,r=n.length;e<r;e++){let r=n[e].split("=");t[decodeURIComponent(r[0])]=decodeURIComponent(r[1])}return t}(this.opts.query)),G&&(this.opts.closeOnBeforeunload&&(this._beforeunloadEventListener=()=>{this.transport&&(this.transport.removeAllListeners(),this.transport.close())},addEventListener("beforeunload",this._beforeunloadEventListener,!1)),"localhost"!==this.hostname&&(this._offlineEventListener=()=>{this._onClose("transport close",{description:"network connection lost"})},X.push(this._offlineEventListener))),this.opts.withCredentials&&(this._cookieJar=void 0),this._open()}createTransport(e){const t=Object.assign({},this.opts.query);t.EIO=4,t.transport=e,this.id&&(t.sid=this.id);const n=Object.assign({},this.opts,{query:t,socket:this,hostname:this.hostname,secure:this.secure,port:this.port},this.opts.transportOptions[e]);return new this._transportsByName[e](n)}_open(){if(0===this.transports.length)return void this.setTimeoutFn((()=>{this.emitReserved("error","No transports available")}),0);const e=this.opts.rememberUpgrade&&Z.priorWebsocketSuccess&&-1!==this.transports.indexOf("websocket")?"websocket":this.transports[0];this.readyState="opening";const t=this.createTransport(e);t.open(),this.setTransport(t)}setTransport(e){this.transport&&this.transport.removeAllListeners(),this.transport=e,e.on("drain",this._onDrain.bind(this)).on("packet",this._onPacket.bind(this)).on("error",this._onError.bind(this)).on("close",(e=>this._onClose("transport close",e)))}onOpen(){this.readyState="open",Z.priorWebsocketSuccess="websocket"===this.transport.name,this.emitReserved("open"),this.flush()}_onPacket(e){if("opening"===this.readyState||"open"===this.readyState||"closing"===this.readyState)switch(this.emitReserved("packet",e),this.emitReserved("heartbeat"),e.type){case"open":this.onHandshake(JSON.parse(e.data));break;case"ping":this._sendPacket("pong"),this.emitReserved("ping"),this.emitReserved("pong"),this._resetPingTimeout();break;case"error":const t=new Error("server error");t.code=e.data,this._onError(t);break;case"message":this.emitReserved("data",e.data),this.emitReserved("message",e.data)}}onHandshake(e){this.emitReserved("handshake",e),this.id=e.sid,this.transport.query.sid=e.sid,this._pingInterval=e.pingInterval,this._pingTimeout=e.pingTimeout,this._maxPayload=e.maxPayload,this.onOpen(),"closed"!==this.readyState&&this._resetPingTimeout()}_resetPingTimeout(){this.clearTimeoutFn(this._pingTimeoutTimer);const e=this._pingInterval+this._pingTimeout;this._pingTimeoutTime=Date.now()+e,this._pingTimeoutTimer=this.setTimeoutFn((()=>{this._onClose("ping timeout")}),e),this.opts.autoUnref&&this._pingTimeoutTimer.unref()}_onDrain(){this.writeBuffer.splice(0,this._prevBufferLen),this._prevBufferLen=0,0===this.writeBuffer.length?this.emitReserved("drain"):this.flush()}flush(){if("closed"!==this.readyState&&this.transport.writable&&!this.upgrading&&this.writeBuffer.length){const e=this._getWritablePackets();this.transport.send(e),this._prevBufferLen=e.length,this.emitReserved("flush")}}_getWritablePackets(){if(!(this._maxPayload&&"polling"===this.transport.name&&this.writeBuffer.length>1))return this.writeBuffer;let e=1;for(let n=0;n<this.writeBuffer.length;n++){const r=this.writeBuffer[n].data;if(r&&(e+="string"==typeof(t=r)?function(e){let t=0,n=0;for(let r=0,s=e.length;r<s;r++)t=e.charCodeAt(r),t<128?n+=1:t<2048?n+=2:t<55296||t>=57344?n+=3:(r++,n+=4);return n}(t):Math.ceil(1.33*(t.byteLength||t.size))),n>0&&e>this._maxPayload)return this.writeBuffer.slice(0,n);e+=2}var t;return this.writeBuffer}_hasPingExpired(){if(!this._pingTimeoutTime)return!0;const e=Date.now()>this._pingTimeoutTime;return e&&(this._pingTimeoutTime=0,T((()=>{this._onClose("ping timeout")}),this.setTimeoutFn)),e}write(e,t,n){return this._sendPacket("message",e,t,n),this}send(e,t,n){return this._sendPacket("message",e,t,n),this}_sendPacket(e,t,n,r){if("function"==typeof t&&(r=t,t=void 0),"function"==typeof n&&(r=n,n=null),"closing"===this.readyState||"closed"===this.readyState)return;(n=n||{}).compress=!1!==n.compress;const s={type:e,data:t,options:n};this.emitReserved("packetCreate",s),this.writeBuffer.push(s),r&&this.once("flush",r),this.flush()}close(){const e=()=>{this._onClose("forced close"),this.transport.close()},t=()=>{this.off("upgrade",t),this.off("upgradeError",t),e()},n=()=>{this.once("upgrade",t),this.once("upgradeError",t)};return"opening"!==this.readyState&&"open"!==this.readyState||(this.readyState="closing",this.writeBuffer.length?this.once("drain",(()=>{this.upgrading?n():e()})):this.upgrading?n():e()),this}_onError(e){if(Z.priorWebsocketSuccess=!1,this.opts.tryAllTransports&&this.transports.length>1&&"opening"===this.readyState)return this.transports.shift(),this._open();this.emitReserved("error",e),this._onClose("transport error",e)}_onClose(e,t){if("opening"===this.readyState||"open"===this.readyState||"closing"===this.readyState){if(this.clearTimeoutFn(this._pingTimeoutTimer),this.transport.removeAllListeners("close"),this.transport.close(),this.transport.removeAllListeners(),G&&(this._beforeunloadEventListener&&removeEventListener("beforeunload",this._beforeunloadEventListener,!1),this._offlineEventListener)){const e=X.indexOf(this._offlineEventListener);-1!==e&&X.splice(e,1)}this.readyState="closed",this.id=null,this.emitReserved("close",e,t),this.writeBuffer=[],this._prevBufferLen=0}}}Z.protocol=4;class ee extends Z{constructor(){super(...arguments),this._upgrades=[]}onOpen(){if(super.onOpen(),"open"===this.readyState&&this.opts.upgrade)for(let e=0;e<this._upgrades.length;e++)this._probe(this._upgrades[e])}_probe(e){let t=this.createTransport(e),n=!1;Z.priorWebsocketSuccess=!1;const r=()=>{n||(t.send([{type:"ping",data:"probe"}]),t.once("packet",(e=>{if(!n)if("pong"===e.type&&"probe"===e.data){if(this.upgrading=!0,this.emitReserved("upgrading",t),!t)return;Z.priorWebsocketSuccess="websocket"===t.name,this.transport.pause((()=>{n||"closed"!==this.readyState&&(u(),this.setTransport(t),t.send([{type:"upgrade"}]),this.emitReserved("upgrade",t),t=null,this.upgrading=!1,this.flush())}))}else{const e=new Error("probe error");e.transport=t.name,this.emitReserved("upgradeError",e)}})))};function s(){n||(n=!0,u(),t.close(),t=null)}const o=e=>{const n=new Error("probe error: "+e);n.transport=t.name,s(),this.emitReserved("upgradeError",n)};function i(){o("transport closed")}function a(){o("socket closed")}function c(e){t&&e.name!==t.name&&s()}const u=()=>{t.removeListener("open",r),t.removeListener("error",o),t.removeListener("close",i),this.off("close",a),this.off("upgrading",c)};t.once("open",r),t.once("error",o),t.once("close",i),this.once("close",a),this.once("upgrading",c),-1!==this._upgrades.indexOf("webtransport")&&"webtransport"!==e?this.setTimeoutFn((()=>{n||t.open()}),200):t.open()}onHandshake(e){this._upgrades=this._filterUpgrades(e.upgrades),super.onHandshake(e)}_filterUpgrades(e){const t=[];for(let n=0;n<e.length;n++)~this.transports.indexOf(e[n])&&t.push(e[n]);return t}}class te extends ee{constructor(e,t={}){const n="object"==typeof e?e:t;(!n.transports||n.transports&&"string"==typeof n.transports[0])&&(n.transports=(n.transports||["polling","websocket","webtransport"]).map((e=>K[e])).filter((e=>!!e))),super(e,n)}}const ne="function"==typeof ArrayBuffer,re=Object.prototype.toString,se="function"==typeof Blob||"undefined"!=typeof Blob&&"[object BlobConstructor]"===re.call(Blob),oe="function"==typeof File||"undefined"!=typeof File&&"[object FileConstructor]"===re.call(File);function ie(e){return ne&&(e instanceof ArrayBuffer||(e=>"function"==typeof ArrayBuffer.isView?ArrayBuffer.isView(e):e.buffer instanceof ArrayBuffer)(e))||se&&e instanceof Blob||oe&&e instanceof File}function ae(e,t){if(!e||"object"!=typeof e)return!1;if(Array.isArray(e)){for(let t=0,n=e.length;t<n;t++)if(ae(e[t]))return!0;return!1}if(ie(e))return!0;if(e.toJSON&&"function"==typeof e.toJSON&&1===arguments.length)return ae(e.toJSON(),!0);for(const t in e)if(Object.prototype.hasOwnProperty.call(e,t)&&ae(e[t]))return!0;return!1}function ce(e){const t=[],n=e.data,r=e;return r.data=ue(n,t),r.attachments=t.length,{packet:r,buffers:t}}function ue(e,t){if(!e)return e;if(ie(e)){const n={_placeholder:!0,num:t.length};return t.push(e),n}if(Array.isArray(e)){const n=new Array(e.length);for(let r=0;r<e.length;r++)n[r]=ue(e[r],t);return n}if("object"==typeof e&&!(e instanceof Date)){const n={};for(const r in e)Object.prototype.hasOwnProperty.call(e,r)&&(n[r]=ue(e[r],t));return n}return e}function le(e,t){return e.data=de(e.data,t),delete e.attachments,e}function de(e,t){if(!e)return e;if(e&&!0===e._placeholder){if("number"==typeof e.num&&e.num>=0&&e.num<t.length)return t[e.num];throw new Error("illegal attachments")}if(Array.isArray(e))for(let n=0;n<e.length;n++)e[n]=de(e[n],t);else if("object"==typeof e)for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&(e[n]=de(e[n],t));return e}const he=["connect","connect_error","disconnect","disconnecting","newListener","removeListener"],pe=5;var me;!function(e){e[e.CONNECT=0]="CONNECT",e[e.DISCONNECT=1]="DISCONNECT",e[e.EVENT=2]="EVENT",e[e.ACK=3]="ACK",e[e.CONNECT_ERROR=4]="CONNECT_ERROR",e[e.BINARY_EVENT=5]="BINARY_EVENT",e[e.BINARY_ACK=6]="BINARY_ACK"}(me||(me={}));class fe{constructor(e){this.replacer=e}encode(e){return e.type!==me.EVENT&&e.type!==me.ACK||!ae(e)?[this.encodeAsString(e)]:this.encodeAsBinary({type:e.type===me.EVENT?me.BINARY_EVENT:me.BINARY_ACK,nsp:e.nsp,data:e.data,id:e.id})}encodeAsString(e){let t=""+e.type;return e.type!==me.BINARY_EVENT&&e.type!==me.BINARY_ACK||(t+=e.attachments+"-"),e.nsp&&"/"!==e.nsp&&(t+=e.nsp+","),null!=e.id&&(t+=e.id),null!=e.data&&(t+=JSON.stringify(e.data,this.replacer)),t}encodeAsBinary(e){const t=ce(e),n=this.encodeAsString(t.packet),r=t.buffers;return r.unshift(n),r}}function ge(e){return"[object Object]"===Object.prototype.toString.call(e)}class be extends I{constructor(e){super(),this.reviver=e}add(e){let t;if("string"==typeof e){if(this.reconstructor)throw new Error("got plaintext data when reconstructing a packet");t=this.decodeString(e);const n=t.type===me.BINARY_EVENT;n||t.type===me.BINARY_ACK?(t.type=n?me.EVENT:me.ACK,this.reconstructor=new ye(t),0===t.attachments&&super.emitReserved("decoded",t)):super.emitReserved("decoded",t)}else{if(!ie(e)&&!e.base64)throw new Error("Unknown type: "+e);if(!this.reconstructor)throw new Error("got binary data when not reconstructing a packet");t=this.reconstructor.takeBinaryData(e),t&&(this.reconstructor=null,super.emitReserved("decoded",t))}}decodeString(e){let t=0;const n={type:Number(e.charAt(0))};if(void 0===me[n.type])throw new Error("unknown packet type "+n.type);if(n.type===me.BINARY_EVENT||n.type===me.BINARY_ACK){const r=t+1;for(;"-"!==e.charAt(++t)&&t!=e.length;);const s=e.substring(r,t);if(s!=Number(s)||"-"!==e.charAt(t))throw new Error("Illegal attachments");n.attachments=Number(s)}if("/"===e.charAt(t+1)){const r=t+1;for(;++t;){if(","===e.charAt(t))break;if(t===e.length)break}n.nsp=e.substring(r,t)}else n.nsp="/";const r=e.charAt(t+1);if(""!==r&&Number(r)==r){const r=t+1;for(;++t;){const n=e.charAt(t);if(null==n||Number(n)!=n){--t;break}if(t===e.length)break}n.id=Number(e.substring(r,t+1))}if(e.charAt(++t)){const r=this.tryParse(e.substr(t));if(!be.isPayloadValid(n.type,r))throw new Error("invalid payload");n.data=r}return n}tryParse(e){try{return JSON.parse(e,this.reviver)}catch(e){return!1}}static isPayloadValid(e,t){switch(e){case me.CONNECT:return ge(t);case me.DISCONNECT:return void 0===t;case me.CONNECT_ERROR:return"string"==typeof t||ge(t);case me.EVENT:case me.BINARY_EVENT:return Array.isArray(t)&&("number"==typeof t[0]||"string"==typeof t[0]&&-1===he.indexOf(t[0]));case me.ACK:case me.BINARY_ACK:return Array.isArray(t)}}destroy(){this.reconstructor&&(this.reconstructor.finishedReconstruction(),this.reconstructor=null)}}class ye{constructor(e){this.packet=e,this.buffers=[],this.reconPack=e}takeBinaryData(e){if(this.buffers.push(e),this.buffers.length===this.reconPack.attachments){const e=le(this.reconPack,this.buffers);return this.finishedReconstruction(),e}return null}finishedReconstruction(){this.reconPack=null,this.buffers=[]}}function _e(e,t,n){return e.on(t,n),function(){e.off(t,n)}}const we=Object.freeze({connect:1,connect_error:1,disconnect:1,disconnecting:1,newListener:1,removeListener:1});class ve extends I{constructor(e,t,n){super(),this.connected=!1,this.recovered=!1,this.receiveBuffer=[],this.sendBuffer=[],this._queue=[],this._queueSeq=0,this.ids=0,this.acks={},this.flags={},this.io=e,this.nsp=t,n&&n.auth&&(this.auth=n.auth),this._opts=Object.assign({},n),this.io._autoConnect&&this.open()}get disconnected(){return!this.connected}subEvents(){if(this.subs)return;const e=this.io;this.subs=[_e(e,"open",this.onopen.bind(this)),_e(e,"packet",this.onpacket.bind(this)),_e(e,"error",this.onerror.bind(this)),_e(e,"close",this.onclose.bind(this))]}get active(){return!!this.subs}connect(){return this.connected||(this.subEvents(),this.io._reconnecting||this.io.open(),"open"===this.io._readyState&&this.onopen()),this}open(){return this.connect()}send(...e){return e.unshift("message"),this.emit.apply(this,e),this}emit(e,...t){var n,r,s;if(we.hasOwnProperty(e))throw new Error('"'+e.toString()+'" is a reserved event name');if(t.unshift(e),this._opts.retries&&!this.flags.fromQueue&&!this.flags.volatile)return this._addToQueue(t),this;const o={type:me.EVENT,data:t,options:{}};if(o.options.compress=!1!==this.flags.compress,"function"==typeof t[t.length-1]){const e=this.ids++,n=t.pop();this._registerAckCallback(e,n),o.id=e}const i=null===(r=null===(n=this.io.engine)||void 0===n?void 0:n.transport)||void 0===r?void 0:r.writable,a=this.connected&&!(null===(s=this.io.engine)||void 0===s?void 0:s._hasPingExpired());return this.flags.volatile&&!i||(a?(this.notifyOutgoingListeners(o),this.packet(o)):this.sendBuffer.push(o)),this.flags={},this}_registerAckCallback(e,t){var n;const r=null!==(n=this.flags.timeout)&&void 0!==n?n:this._opts.ackTimeout;if(void 0===r)return void(this.acks[e]=t);const s=this.io.setTimeoutFn((()=>{delete this.acks[e];for(let t=0;t<this.sendBuffer.length;t++)this.sendBuffer[t].id===e&&this.sendBuffer.splice(t,1);t.call(this,new Error("operation has timed out"))}),r),o=(...e)=>{this.io.clearTimeoutFn(s),t.apply(this,e)};o.withError=!0,this.acks[e]=o}emitWithAck(e,...t){return new Promise(((n,r)=>{const s=(e,t)=>e?r(e):n(t);s.withError=!0,t.push(s),this.emit(e,...t)}))}_addToQueue(e){let t;"function"==typeof e[e.length-1]&&(t=e.pop());const n={id:this._queueSeq++,tryCount:0,pending:!1,args:e,flags:Object.assign({fromQueue:!0},this.flags)};e.push(((e,...r)=>{if(n!==this._queue[0])return;return null!==e?n.tryCount>this._opts.retries&&(this._queue.shift(),t&&t(e)):(this._queue.shift(),t&&t(null,...r)),n.pending=!1,this._drainQueue()})),this._queue.push(n),this._drainQueue()}_drainQueue(e=!1){if(!this.connected||0===this._queue.length)return;const t=this._queue[0];t.pending&&!e||(t.pending=!0,t.tryCount++,this.flags=t.flags,this.emit.apply(this,t.args))}packet(e){e.nsp=this.nsp,this.io._packet(e)}onopen(){"function"==typeof this.auth?this.auth((e=>{this._sendConnectPacket(e)})):this._sendConnectPacket(this.auth)}_sendConnectPacket(e){this.packet({type:me.CONNECT,data:this._pid?Object.assign({pid:this._pid,offset:this._lastOffset},e):e})}onerror(e){this.connected||this.emitReserved("connect_error",e)}onclose(e,t){this.connected=!1,delete this.id,this.emitReserved("disconnect",e,t),this._clearAcks()}_clearAcks(){Object.keys(this.acks).forEach((e=>{if(!this.sendBuffer.some((t=>String(t.id)===e))){const t=this.acks[e];delete this.acks[e],t.withError&&t.call(this,new Error("socket has been disconnected"))}}))}onpacket(e){if(e.nsp===this.nsp)switch(e.type){case me.CONNECT:e.data&&e.data.sid?this.onconnect(e.data.sid,e.data.pid):this.emitReserved("connect_error",new Error("It seems you are trying to reach a Socket.IO server in v2.x with a v3.x client, but they are not compatible (more information here: https://socket.io/docs/v3/migrating-from-2-x-to-3-0/)"));break;case me.EVENT:case me.BINARY_EVENT:this.onevent(e);break;case me.ACK:case me.BINARY_ACK:this.onack(e);break;case me.DISCONNECT:this.ondisconnect();break;case me.CONNECT_ERROR:this.destroy();const t=new Error(e.data.message);t.data=e.data.data,this.emitReserved("connect_error",t)}}onevent(e){const t=e.data||[];null!=e.id&&t.push(this.ack(e.id)),this.connected?this.emitEvent(t):this.receiveBuffer.push(Object.freeze(t))}emitEvent(e){if(this._anyListeners&&this._anyListeners.length){const t=this._anyListeners.slice();for(const n of t)n.apply(this,e)}super.emit.apply(this,e),this._pid&&e.length&&"string"==typeof e[e.length-1]&&(this._lastOffset=e[e.length-1])}ack(e){const t=this;let n=!1;return function(...r){n||(n=!0,t.packet({type:me.ACK,id:e,data:r}))}}onack(e){const t=this.acks[e.id];"function"==typeof t&&(delete this.acks[e.id],t.withError&&e.data.unshift(null),t.apply(this,e.data))}onconnect(e,t){this.id=e,this.recovered=t&&this._pid===t,this._pid=t,this.connected=!0,this.emitBuffered(),this.emitReserved("connect"),this._drainQueue(!0)}emitBuffered(){this.receiveBuffer.forEach((e=>this.emitEvent(e))),this.receiveBuffer=[],this.sendBuffer.forEach((e=>{this.notifyOutgoingListeners(e),this.packet(e)})),this.sendBuffer=[]}ondisconnect(){this.destroy(),this.onclose("io server disconnect")}destroy(){this.subs&&(this.subs.forEach((e=>e())),this.subs=void 0),this.io._destroy(this)}disconnect(){return this.connected&&this.packet({type:me.DISCONNECT}),this.destroy(),this.connected&&this.onclose("io client disconnect"),this}close(){return this.disconnect()}compress(e){return this.flags.compress=e,this}get volatile(){return this.flags.volatile=!0,this}timeout(e){return this.flags.timeout=e,this}onAny(e){return this._anyListeners=this._anyListeners||[],this._anyListeners.push(e),this}prependAny(e){return this._anyListeners=this._anyListeners||[],this._anyListeners.unshift(e),this}offAny(e){if(!this._anyListeners)return this;if(e){const t=this._anyListeners;for(let n=0;n<t.length;n++)if(e===t[n])return t.splice(n,1),this}else this._anyListeners=[];return this}listenersAny(){return this._anyListeners||[]}onAnyOutgoing(e){return this._anyOutgoingListeners=this._anyOutgoingListeners||[],this._anyOutgoingListeners.push(e),this}prependAnyOutgoing(e){return this._anyOutgoingListeners=this._anyOutgoingListeners||[],this._anyOutgoingListeners.unshift(e),this}offAnyOutgoing(e){if(!this._anyOutgoingListeners)return this;if(e){const t=this._anyOutgoingListeners;for(let n=0;n<t.length;n++)if(e===t[n])return t.splice(n,1),this}else this._anyOutgoingListeners=[];return this}listenersAnyOutgoing(){return this._anyOutgoingListeners||[]}notifyOutgoingListeners(e){if(this._anyOutgoingListeners&&this._anyOutgoingListeners.length){const t=this._anyOutgoingListeners.slice();for(const n of t)n.apply(this,e.data)}}}function ke(e){e=e||{},this.ms=e.min||100,this.max=e.max||1e4,this.factor=e.factor||2,this.jitter=e.jitter>0&&e.jitter<=1?e.jitter:0,this.attempts=0}ke.prototype.duration=function(){var e=this.ms*Math.pow(this.factor,this.attempts++);if(this.jitter){var t=Math.random(),n=Math.floor(t*this.jitter*e);e=1&Math.floor(10*t)?e+n:e-n}return 0|Math.min(e,this.max)},ke.prototype.reset=function(){this.attempts=0},ke.prototype.setMin=function(e){this.ms=e},ke.prototype.setMax=function(e){this.max=e},ke.prototype.setJitter=function(e){this.jitter=e};class Ee extends I{constructor(e,t){var n;super(),this.nsps={},this.subs=[],e&&"object"==typeof e&&(t=e,e=void 0),(t=t||{}).path=t.path||"/socket.io",this.opts=t,N(this,t),this.reconnection(!1!==t.reconnection),this.reconnectionAttempts(t.reconnectionAttempts||1/0),this.reconnectionDelay(t.reconnectionDelay||1e3),this.reconnectionDelayMax(t.reconnectionDelayMax||5e3),this.randomizationFactor(null!==(n=t.randomizationFactor)&&void 0!==n?n:.5),this.backoff=new ke({min:this.reconnectionDelay(),max:this.reconnectionDelayMax(),jitter:this.randomizationFactor()}),this.timeout(null==t.timeout?2e4:t.timeout),this._readyState="closed",this.uri=e;const s=t.parser||r;this.encoder=new s.Encoder,this.decoder=new s.Decoder,this._autoConnect=!1!==t.autoConnect,this._autoConnect&&this.open()}reconnection(e){return arguments.length?(this._reconnection=!!e,e||(this.skipReconnect=!0),this):this._reconnection}reconnectionAttempts(e){return void 0===e?this._reconnectionAttempts:(this._reconnectionAttempts=e,this)}reconnectionDelay(e){var t;return void 0===e?this._reconnectionDelay:(this._reconnectionDelay=e,null===(t=this.backoff)||void 0===t||t.setMin(e),this)}randomizationFactor(e){var t;return void 0===e?this._randomizationFactor:(this._randomizationFactor=e,null===(t=this.backoff)||void 0===t||t.setJitter(e),this)}reconnectionDelayMax(e){var t;return void 0===e?this._reconnectionDelayMax:(this._reconnectionDelayMax=e,null===(t=this.backoff)||void 0===t||t.setMax(e),this)}timeout(e){return arguments.length?(this._timeout=e,this):this._timeout}maybeReconnectOnOpen(){!this._reconnecting&&this._reconnection&&0===this.backoff.attempts&&this.reconnect()}open(e){if(~this._readyState.indexOf("open"))return this;this.engine=new te(this.uri,this.opts);const t=this.engine,n=this;this._readyState="opening",this.skipReconnect=!1;const r=_e(t,"open",(function(){n.onopen(),e&&e()})),s=t=>{this.cleanup(),this._readyState="closed",this.emitReserved("error",t),e?e(t):this.maybeReconnectOnOpen()},o=_e(t,"error",s);if(!1!==this._timeout){const e=this._timeout,n=this.setTimeoutFn((()=>{r(),s(new Error("timeout")),t.close()}),e);this.opts.autoUnref&&n.unref(),this.subs.push((()=>{this.clearTimeoutFn(n)}))}return this.subs.push(r),this.subs.push(o),this}connect(e){return this.open(e)}onopen(){this.cleanup(),this._readyState="open",this.emitReserved("open");const e=this.engine;this.subs.push(_e(e,"ping",this.onping.bind(this)),_e(e,"data",this.ondata.bind(this)),_e(e,"error",this.onerror.bind(this)),_e(e,"close",this.onclose.bind(this)),_e(this.decoder,"decoded",this.ondecoded.bind(this)))}onping(){this.emitReserved("ping")}ondata(e){try{this.decoder.add(e)}catch(e){this.onclose("parse error",e)}}ondecoded(e){T((()=>{this.emitReserved("packet",e)}),this.setTimeoutFn)}onerror(e){this.emitReserved("error",e)}socket(e,t){let n=this.nsps[e];return n?this._autoConnect&&!n.active&&n.connect():(n=new ve(this,e,t),this.nsps[e]=n),n}_destroy(e){const t=Object.keys(this.nsps);for(const e of t){if(this.nsps[e].active)return}this._close()}_packet(e){const t=this.encoder.encode(e);for(let n=0;n<t.length;n++)this.engine.write(t[n],e.options)}cleanup(){this.subs.forEach((e=>e())),this.subs.length=0,this.decoder.destroy()}_close(){this.skipReconnect=!0,this._reconnecting=!1,this.onclose("forced close")}disconnect(){return this._close()}onclose(e,t){var n;this.cleanup(),null===(n=this.engine)||void 0===n||n.close(),this.backoff.reset(),this._readyState="closed",this.emitReserved("close",e,t),this._reconnection&&!this.skipReconnect&&this.reconnect()}reconnect(){if(this._reconnecting||this.skipReconnect)return this;const e=this;if(this.backoff.attempts>=this._reconnectionAttempts)this.backoff.reset(),this.emitReserved("reconnect_failed"),this._reconnecting=!1;else{const t=this.backoff.duration();this._reconnecting=!0;const n=this.setTimeoutFn((()=>{e.skipReconnect||(this.emitReserved("reconnect_attempt",e.backoff.attempts),e.skipReconnect||e.open((t=>{t?(e._reconnecting=!1,e.reconnect(),this.emitReserved("reconnect_error",t)):e.onreconnect()})))}),t);this.opts.autoUnref&&n.unref(),this.subs.push((()=>{this.clearTimeoutFn(n)}))}}onreconnect(){const e=this.backoff.attempts;this._reconnecting=!1,this.backoff.reset(),this.emitReserved("reconnect",e)}}const xe={};function Ie(e,t){"object"==typeof e&&(t=e,e=void 0);const n=function(e,t="",n){let r=e;n=n||"undefined"!=typeof location&&location,null==e&&(e=n.protocol+"//"+n.host),"string"==typeof e&&("/"===e.charAt(0)&&(e="/"===e.charAt(1)?n.protocol+e:n.host+e),/^(https?|wss?):\/\//.test(e)||(e=void 0!==n?n.protocol+"//"+e:"https://"+e),r=Q(e)),r.port||(/^(http|ws)$/.test(r.protocol)?r.port="80":/^(http|ws)s$/.test(r.protocol)&&(r.port="443")),r.path=r.path||"/";const s=-1!==r.host.indexOf(":")?"["+r.host+"]":r.host;return r.id=r.protocol+"://"+s+":"+r.port+t,r.href=r.protocol+"://"+s+(n&&n.port===r.port?"":":"+r.port),r}(e,(t=t||{}).path||"/socket.io"),r=n.source,s=n.id,o=n.path,i=xe[s]&&o in xe[s].nsps;let a;return t.forceNew||t["force new connection"]||!1===t.multiplex||i?a=new Ee(r,t):(xe[s]||(xe[s]=new Ee(r,t)),a=xe[s]),n.query&&!t.query&&(t.query=n.queryKey),a.socket(n.path,t)}Object.assign(Ie,{Manager:Ee,Socket:ve,io:Ie,connect:Ie});var Te=n(413),Se=n(384),Pe=n(573),Oe=n(206);let Ae=null,Ne=null,Re=`wss://${Se.J.replace("https://","")}`,Ce="/sio/socket.io",$e=0,qe=!1,Le=new Map,Me=null;function je(){Ae&&(Ae.removeAllListeners(),Ae.disconnect(),Ae=null,qe=!1,Ne=null),(0,Te.bQ)("bgptLicenseKey",(e=>{e&&(Ae=Ie(Re,{path:Ce,transports:["websocket"],auth:{clientId:e},autoConnect:!0,binaryType:"arraybuffer",reconnection:!0,reconnectionAttempts:1/0,reconnectionDelay:1e3,timeout:2e4}),Ae.on("connect",(()=>{Me=Ae.id,qe=!0,Ne=new Pe.A(Ae),De(e)})),Ae.on("reconnect",(t=>{Me=Ae.id,De(e)})),Ae.on("disconnect",(e=>{qe=!1,Le.forEach((e=>{e(new Error("Socket disconnected"))})),Le.clear()})),Ae.on("connect_error",(e=>{qe=!1,Le.forEach((t=>{t(new Error("Socket connection error: "+e.message))})),Le.clear()})),Ae.on("error",(e=>{})),Ae.on("tts_response",(e=>{e.audio&&"Buffer"===e.audio.type&&(e.audio=new Uint8Array(e.audio.data))})))}))}function De(e){Ae&&qe&&Ae.emit("listen_for_task",{channel_id:e})}function Ue(e){switch(e){case 400:return"Bad Request";case 401:return"Unauthorized";case 403:return"Forbidden";case 404:return"Not Found";case 408:return"Request Timeout";case 429:return"Too Many Requests";case 500:return"Internal Server Error";case 502:return"Bad Gateway";case 503:return"Service Unavailable";default:return"Error"}}function Be(){const e=globalThis.fetch;globalThis.fetch=async function(t,n={}){const r=n.signal;let s;const o=["/check_browser_task_complete","/handle_browser_tasks","/handle_browser","/handle_browser_annotated","/navigate_tab","/tts","/voice_prompt","/text_prompt","/voice_to_text","/process_image_profile","/get_relevant_profile","/determine_intent","/index_conversations","/stream_voice_prompt","/get_image_description"].find((e=>t.endsWith(e)));if(!(null!=o)||!o)return e(t,n);s=o.substring(1);try{await new Promise(((e,t)=>{if(Ae&&qe)return void e(Ae);je();let n=0;const r=setInterval((()=>{if(Ae&&qe)return clearInterval(r),void e(Ae);n++,n>=10&&(clearInterval(r),t(new Error("Socket connection failed")))}),1e3)}))}catch(e){return{ok:!1,status:503,statusText:"Service Unavailable",json:async()=>({error:"Socket connection failed: "+e.message}),headers:new Headers({"Content-Type":"application/json"})}}let i={};if(n.body)try{i="string"==typeof n.body?JSON.parse(n.body):n.body instanceof FormData?await async function(e,t){if(!(t.body instanceof FormData))return t.body;const n={};for(let[r,s]of t.body.entries())"voice_prompt"===e&&"audio"===r&&(s instanceof Blob||s instanceof File)?(n.audio=await s.arrayBuffer(),n.mime_type=s.type,n.filename=s.name):n[r]=s;return n}(s,n):n.body}catch(e){i=n.body}const a=n.headers||{},c={...i,bgpt_license_key:a["bgpt-license-key"]||a["Bgpt-License-Key"],authorization:a.authorization||a.Authorization};return new Promise((async(e,t)=>{const n=($e=($e+1)%Number.MAX_SAFE_INTEGER,`${Date.now()}_${$e}`),o=`${s}_response_${n}`,i=`error_${n}`;Le.set(n,t),(0,Oe.iB)(n);const a=()=>{Ae.off(o),Ae.off(i),Ae.off(`${s}_chunk_${n}`),Ae.emit("abort_request",{requestId:n}),(0,Oe.Bl)(n),t(new Error("Operation cancelled by user"))};r&&r.addEventListener("abort",a),(0,Oe.BH)().addEventListener("abort",a);if("stream_voice_prompt"===s){const t={ok:!0,status:200,statusText:"OK",body:new ReadableStream({start(e){r?.aborted?e.error(new Error("Operation cancelled by user")):(Ae.on(`stream_voice_prompt_chunk_${n}`,(t=>{t.chunk&&"Buffer"===t.chunk.type&&(t=new Uint8Array(t.chunk.data)),e.enqueue(t)})),Ae.on(`stream_voice_prompt_response_${n}`,(t=>{"completed"===t.status&&e.close()})),Ae.on(i,(t=>{e.error(t)})))}}),headers:new Headers({"Content-Type":"audio/mpeg"})};Ae.emit(s,{...c,requestId:n}),e(t)}else{const t=t=>{let n;n=Array.isArray(t)&&2===t.length?t[1].detail||t[1].error||"Unknown error occurred":t.error||"Unknown error occurred";const r=function(e){try{if(!e)return 500;const t="string"==typeof e?e:String(e);if(t.includes("license key invalid")||t.includes("Invalid or expired license key")||t.includes("Bgpt license key invalid"))return 403;if(t.includes("unauthorized")||t.includes("authentication failed"))return 401;if(t.includes("not found"))return 404;if(t.includes("invalid request")||t.includes("validation error"))return 400}catch(e){}return 500}(n),s={ok:!1,status:r,statusText:Ue(r),json:async()=>({error:n}),blob:async()=>new Blob([JSON.stringify({error:n})]),headers:new Headers({"Content-Type":"application/json"})};e(s)};Ae.once(o,(o=>{if(clearTimeout(u),r&&r.removeEventListener("abort",a),(0,Oe.BH)().removeEventListener("abort",a),(0,Oe.Bl)(n),Le.delete(n),r?.aborted)return;Ae.off("error",t),Ae.off(i,t);const c=function(e,t){return"tts"!==e?t:t.audio?t.audio instanceof Uint8Array?new Blob([t.audio.buffer],{type:t.content_type}):"Buffer"===t.audio.type?new Blob([new Uint8Array(t.audio.data)],{type:t.content_type}):new Blob([t.audio],{type:t.content_type}):void 0}(s,o),l={ok:!o.error,status:o.error?o.status_code||400:200,statusText:o.error?Ue(o.status_code||400):"OK",json:async()=>{if(c instanceof Blob)return{audio:c};if("object"==typeof c)return c;try{return JSON.parse(c)}catch{return{data:c}}},blob:async()=>c instanceof Blob?c:new Blob([JSON.stringify(c)]),headers:new Headers({"Content-Type":c instanceof Blob?c.type:"application/json"})};e(l)})),Ae.once("error",t),Ae.once(i,t),c.bgpt_license_key,Ae.emit(s,{...c,requestId:n,abortable:!0});const u=setTimeout((()=>{r?.aborted||(Ae.off(o),Ae.off("error",t),Ae.off(i,t),e({ok:!1,status:408,statusText:"Request Timeout",json:async()=>({error:"Socket request timeout"}),blob:async()=>new Blob([JSON.stringify({error:"Socket request timeout"})]),headers:new Headers({"Content-Type":"application/json"})}))}),2e5)}}))}}globalThis.socket=Ae},985:(e,t,n)=>{n.d(t,{f:()=>d});var r=n(413),s=n(565);let o=null,i=null,a=null,c=null,u=null,l=null;function d(e,t,n,r,s){return new Promise(((d,p)=>{let m,f=!1;function g(){clearTimeout(m),function(){c&&(chrome.webNavigation.onErrorOccurred.removeListener(c),c=null);u&&(chrome.webRequest.onHeadersReceived.removeListener(u),u=null);l&&(chrome.tabs.onUpdated.removeListener(l),l=null);o=null,i=null,a=null}()}o=e,i=t,c=function(o){o.tabId===e&&o.url===i&&(f=!0,g(),h(n.tab.id,"failed_task","Navigation error occurred on the webpage I was trying to navigate to. Most likely, the webpage is not available or has been removed.",r,s,e,t),p(new Error(`Navigation error: ${o.error}`)))},u=function(o){if(o.tabId===e&&o.url===i){const i=o.statusCode;i>=400&&(f=!0,g(),h(n.tab.id,"failed_task",`HTTP error ${i} on the webpage I was trying to navigate to`,r,s,e,t),p(new Error(`HTTP error: ${i}`)))}},l=function(o,a,c){o===e&&"complete"===a.status&&c.url===i&&c.url.startsWith("chrome-error://")&&(f=!0,g(),h(n.tab.id,"failed_task","Failed to load URL",r,s,e,t),p(new Error("Chrome error page")))},chrome.webNavigation.onErrorOccurred.addListener(c,{url:[{urlEquals:t}]}),chrome.webRequest.onHeadersReceived.addListener(u,{urls:[t]},["responseHeaders"]),chrome.tabs.onUpdated.addListener(l),m=setTimeout((()=>{g(),f||d("No errors detected within timeout period")}),2e3)}))}function h(e,t,n,o,i,a,c,u=!0){e&&(setTimeout((()=>{(0,r.j2)(e,!1).then((()=>{"failed_task"===t&&setTimeout((()=>{(0,s.uk)(e,"from service worker",o),a&&e!==a&&(0,s.Em)(a,o)}),5e3)}))}),5e3),chrome.tabs.sendMessage(e,{action:"sendMessagetoUser",status:t,message:n,bgptIndex:i,playSpeech:u,stateId:o},(t=>{chrome.runtime.lastError||chrome.tabs.sendMessage(e,{action:"sendMessagetoUser",status:"info_message",message:"Unable to load this URL: ("+c+") You must try another valid URL moving forward",bgptIndex:i,playSpeech:!1,stateId:o},(e=>{chrome.runtime.lastError}))})))}},413:(e,t,n)=>{n.d(t,{AN:()=>f,FN:()=>y,Hr:()=>i,Iu:()=>d,J2:()=>w,VS:()=>g,XO:()=>s,Y7:()=>h,YL:()=>u,bQ:()=>o,id:()=>p,j2:()=>c,lz:()=>_,s4:()=>b,u3:()=>l,vH:()=>a,xo:()=>m});var r=n(384);function s(e,t,n){let r={};if(r[e]=t,!n||"function"!=typeof n)return new Promise(((e,t)=>{chrome.storage.local.set(r,(()=>{chrome.runtime.lastError?t(new Error(chrome.runtime.lastError.message)):e()}))}));chrome.storage.local.set(r,(()=>{chrome.runtime.lastError?n(new Error(chrome.runtime.lastError.message)):n(null)}))}function o(e,t){if(!t||"function"!=typeof t)return new Promise(((t,n)=>{chrome.storage.local.get([e],(r=>{chrome.runtime.lastError?n(new Error(chrome.runtime.lastError.message)):t(void 0===r[e]?null:r[e])}))}));chrome.storage.local.get([e],(n=>{chrome.runtime.lastError?t(null):t(void 0===n[e]?null:n[e])}))}function i(e){const t={task:e,timestamp:Date.now()};chrome.storage.sync.set({currentTask:t},(()=>{chrome.runtime.lastError}))}function a(){return new Promise((e=>{chrome.storage.sync.get(["currentTask"],(t=>{if(chrome.runtime.lastError)e(null);else{const n=t?.currentTask;if(n&&n.timestamp){const t=12e4;Date.now()-n.timestamp>t?e(null):e(n)}else e(null)}}))}))}function c(e,t=!1,n=null){return new Promise(((r,s)=>{chrome.tabs.query({active:!0,currentWindow:!0},(o=>{if(chrome.runtime.lastError)s(chrome.runtime.lastError);else{const i=o[0];i&&i.id===e?chrome.windows.getCurrent((e=>{chrome.runtime.lastError?s(chrome.runtime.lastError):e.focused?t?d(i,n).then(r).catch(s):r():chrome.windows.update(e.id,{focused:!0},(()=>{chrome.runtime.lastError?s(chrome.runtime.lastError):t?d(i,n).then(r).catch(s):r()}))})):chrome.tabs.get(e,(o=>{chrome.runtime.lastError?s(chrome.runtime.lastError):chrome.tabs.update(e,{active:!0},(e=>{chrome.runtime.lastError?s(chrome.runtime.lastError):chrome.windows.update(e.windowId,{focused:!0},(()=>{chrome.runtime.lastError?s(chrome.runtime.lastError):t?d(e,n).then(r).catch(s):r()}))}))}))}}))}))}function u(e,t=null){return new Promise(((n,r)=>{l(e,{action:"ping",stateId:t},{},t).then((e=>{n(e)})).catch((e=>{r(e)}))}))}function l(e,t,n={},r=null){return new Promise(((s,o)=>{chrome.tabs.sendMessage(e,t,n,(i=>{if(chrome.runtime.lastError){chrome.runtime.lastError.message.includes("Receiving end does not exist")?chrome.tabs.get(e,(i=>{i?d(i,r).then((()=>{setTimeout((()=>{chrome.tabs.sendMessage(e,t,n,(e=>{chrome.runtime.lastError?o("Failed on retry: "+chrome.runtime.lastError.message):s(e)}))}),1e3)})).catch((e=>{o("Failed to inject content script: "+e)})):o("No tab with id: "+e)})):s(i)}else s(i)}))}))}function d(e,t=null){return new Promise(((n,r)=>{function s(){const s=["content.js","offscreen.js","socket.io.min.js"];e.url.includes("browser.civai.co")||e.url.includes("browsergpt.co")||s.push("script.js"),chrome.scripting.executeScript({target:{tabId:e.id},files:s}).then((()=>{null!==t?setTimeout((()=>{chrome.tabs.sendMessage(e.id,{action:"setStateId",stateId:t},(e=>{chrome.runtime.lastError,n(e)}))}),4e3):n()})).catch((e=>{r(e)}))}null!==t?chrome.tabs.sendMessage(e.id,{action:"ping",stateId:t},(function(e){chrome.runtime.lastError||!e?s():n(e)})):s()}))}function h(e,t,n,r){return new Promise(((s,o)=>{chrome.tabs.sendMessage(n,{action:"sendMessagetoUser",status:"broadcast",message:{key:e,value:t},bgptIndex:!1,stateId:r,playSpeech:!1},(e=>!chrome.runtime.lastError))}))}function p(e){return new Promise((t=>{chrome.tabs.get(e,(e=>{chrome.runtime.lastError?t(null):t(e)}))}))}function m(e,t=!1){return new Promise(((t,n)=>{chrome.tabs.query({},(r=>{const s=r.find((t=>t.url&&t.url.includes(e)));s?chrome.tabs.update(s.id,{active:!0,url:e},(e=>{chrome.runtime.lastError?n(chrome.runtime.lastError):(chrome.windows.update(s.windowId,{focused:!0}),y(e.id).then((r=>{r?t(e):chrome.tabs.reload(e.id,{bypassCache:!0},(()=>{chrome.runtime.lastError?n(chrome.runtime.lastError):setTimeout((()=>{t(e)}),2e3)}))})))})):chrome.tabs.create({url:e},(e=>{chrome.runtime.lastError?n(chrome.runtime.lastError):t(e)}))}))}))}async function f(e){try{const t=await fetch("https://gist.githubusercontent.com/mrkeyiano/e2d760c8059c779a330933d8509a045a/raw");if(!t.ok)return!1;const n=await t.text();return n.split("\n").map((e=>e.trim())).filter((e=>e)).includes(e)}catch(e){return!1}}function g(e,t=null){return new Promise(((r,s)=>{e?chrome.tabs.get(e,(e=>{!chrome.runtime.lastError&&e?chrome.windows.getCurrent((o=>{const i=o.id,a=e.windowId;a===i&&o.focused?n(e,t,r,s):chrome.windows.update(a,{focused:!0},(o=>{chrome.runtime.lastError,n(e,t,r,s)}))})):s(new Error(chrome.runtime.lastError?.message||"Tab not found"))})):s(new Error("Invalid tab ID"))}));function n(e,t,n,s){e.active?r(e.windowId,n,s):chrome.tabs.query({active:!0,currentWindow:!0},(o=>{chrome.tabs.update(e.id,{active:!0},(()=>{chrome.runtime.lastError?s(new Error(chrome.runtime.lastError.message)):setTimeout((()=>{r(e.windowId,(r=>{t&&t!==e.id?chrome.tabs.get(t,(s=>{if(chrome.runtime.lastError)return void n(r);const o=s.windowId;o!==e.windowId?chrome.windows.update(o,{focused:!0},(()=>{chrome.runtime.lastError,chrome.tabs.update(t,{active:!0},(()=>{chrome.runtime.lastError,n(r)}))})):chrome.tabs.update(t,{active:!0},(()=>{chrome.runtime.lastError,n(r)}))})):n(r)}),s)}),500)}))}))}function r(e,t,n){chrome.tabs.captureVisibleTab(e,{format:"png"},(e=>{!chrome.runtime.lastError&&e?t(e.split(",")[1]):n(new Error(chrome.runtime.lastError?.message||"Failed to capture tab"))}))}}async function b(e){try{const t=await o("bgptLicenseKey"),n=await fetch(`${r.J}/get_image_description`,{method:"POST",headers:{"Content-Type":"application/json","bgpt-license-key":t},body:JSON.stringify({image:e})});if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);return(await n.json()).description}catch(e){return"Failed to get image description"}}function y(e){return new Promise((t=>{o("stateId").then((n=>{chrome.tabs.sendMessage(e,{action:"ping",stateId:n},(e=>{chrome.runtime.lastError||!e?t(!1):t(!0)}))}))}))}function _(e,t="click"){return new Promise(((n,r)=>{o("stateId").then((s=>{chrome.tabs.sendMessage(e,{action:"getElements",type:t,stateId:s},(e=>{chrome.runtime.lastError?r(chrome.runtime.lastError):n(e.elements)}))}))}))}function w(){return o("activeTabId")}}},t={};function n(r){var s=t[r];if(void 0!==s)return s.exports;var o=t[r]={exports:{}};return e[r](o,o.exports,n),o.exports}n.d=(e,t)=>{for(var r in t)n.o(t,r)&&!n.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var r=n(413),s=n(851),o=n(206),i=n(31),a=n(565),c=n(985),u=n(285),l=n(506);const d="undefined"==typeof __SENTRY_DEBUG__||__SENTRY_DEBUG__,h="undefined"==typeof __SENTRY_DEBUG__||__SENTRY_DEBUG__,p="8.52.0",m=globalThis;function f(e,t,n){const r=n||m,s=r.__SENTRY__=r.__SENTRY__||{},o=s[p]=s[p]||{};return o[e]||(o[e]=t())}const g=["debug","info","warn","error","log","assert","trace"],b={};function y(e){if(!("console"in m))return e();const t=m.console,n={},r=Object.keys(b);r.forEach((e=>{const r=b[e];n[e]=t[e],t[e]=r}));try{return e()}finally{r.forEach((e=>{t[e]=n[e]}))}}const _=f("logger",(function(){let e=!1;const t={enable:()=>{e=!0},disable:()=>{e=!1},isEnabled:()=>e};return h?g.forEach((n=>{t[n]=(...t)=>{e&&y((()=>{m.console[n](`Sentry Logger [${n}]:`,...t)}))}})):g.forEach((e=>{t[e]=()=>{}})),t})),w=[];function v(e){const t=e.defaultIntegrations||[],n=e.integrations;let r;if(t.forEach((e=>{e.isDefaultInstance=!0})),Array.isArray(n))r=[...t,...n];else if("function"==typeof n){const e=n(t);r=Array.isArray(e)?e:[e]}else r=t;const s=function(e){const t={};return e.forEach((e=>{const{name:n}=e,r=t[n];r&&!r.isDefaultInstance&&e.isDefaultInstance||(t[n]=e)})),Object.values(t)}(r),o=s.findIndex((e=>"Debug"===e.name));if(o>-1){const[e]=s.splice(o,1);s.push(e)}return s}function k(e,t){for(const n of t)n&&n.afterAllSetup&&n.afterAllSetup(e)}function E(e,t,n){if(n[t.name])d&&_.log(`Integration skipped because it was already installed: ${t.name}`);else{if(n[t.name]=t,-1===w.indexOf(t.name)&&"function"==typeof t.setupOnce&&(t.setupOnce(),w.push(t.name)),t.setup&&"function"==typeof t.setup&&t.setup(e),"function"==typeof t.preprocessEvent){const n=t.preprocessEvent.bind(t);e.on("preprocessEvent",((t,r)=>n(t,r,e)))}if("function"==typeof t.processEvent){const n=t.processEvent.bind(t),r=Object.assign(((t,r)=>n(t,r,e)),{id:t.name});e.addEventProcessor(r)}d&&_.log(`Integration installed: ${t.name}`)}}const x=Object.prototype.toString;function I(e){switch(x.call(e)){case"[object Error]":case"[object Exception]":case"[object DOMException]":case"[object WebAssembly.Exception]":return!0;default:return q(e,Error)}}function T(e,t){return x.call(e)===`[object ${t}]`}function S(e){return T(e,"ErrorEvent")}function P(e){return T(e,"DOMError")}function O(e){return T(e,"String")}function A(e){return"object"==typeof e&&null!==e&&"__sentry_template_string__"in e&&"__sentry_template_values__"in e}function N(e){return null===e||A(e)||"object"!=typeof e&&"function"!=typeof e}function R(e){return T(e,"Object")}function C(e){return"undefined"!=typeof Event&&q(e,Event)}function $(e){return Boolean(e&&e.then&&"function"==typeof e.then)}function q(e,t){try{return e instanceof t}catch(e){return!1}}function L(e){return!("object"!=typeof e||null===e||!e.__isVue&&!e._isVue)}const M=m;function j(e,t={}){if(!e)return"<unknown>";try{let n=e;const r=5,s=[];let o=0,i=0;const a=" > ",c=a.length;let u;const l=Array.isArray(t)?t:t.keyAttrs,d=!Array.isArray(t)&&t.maxStringLength||80;for(;n&&o++<r&&(u=D(n,l),!("html"===u||o>1&&i+s.length*c+u.length>=d));)s.push(u),i+=u.length,n=n.parentNode;return s.reverse().join(a)}catch(e){return"<unknown>"}}function D(e,t){const n=e,r=[];if(!n||!n.tagName)return"";if(M.HTMLElement&&n instanceof HTMLElement&&n.dataset){if(n.dataset.sentryComponent)return n.dataset.sentryComponent;if(n.dataset.sentryElement)return n.dataset.sentryElement}r.push(n.tagName.toLowerCase());const s=t&&t.length?t.filter((e=>n.getAttribute(e))).map((e=>[e,n.getAttribute(e)])):null;if(s&&s.length)s.forEach((e=>{r.push(`[${e[0]}="${e[1]}"]`)}));else{n.id&&r.push(`#${n.id}`);const e=n.className;if(e&&O(e)){const t=e.split(/\s+/);for(const e of t)r.push(`.${e}`)}}const o=["aria-label","type","name","title","alt"];for(const e of o){const t=n.getAttribute(e);t&&r.push(`[${e}="${t}"]`)}return r.join("")}function U(e,t=0){return"string"!=typeof e||0===t||e.length<=t?e:`${e.slice(0,t)}...`}function B(e,t){if(!Array.isArray(e))return"";const n=[];for(let t=0;t<e.length;t++){const r=e[t];try{L(r)?n.push("[VueViewModel]"):n.push(String(r))}catch(e){n.push("[value cannot be serialized]")}}return n.join(t)}function F(e,t,n=!1){return!!O(e)&&(T(t,"RegExp")?t.test(e):!!O(t)&&(n?e===t:e.includes(t)))}function H(e,t=[],n=!1){return t.some((t=>F(e,t,n)))}function z(e,t,n){if(!(t in e))return;const r=e[t],s=n(r);"function"==typeof s&&W(s,r);try{e[t]=s}catch(n){h&&_.log(`Failed to replace method "${t}" in object`,e)}}function Y(e,t,n){try{Object.defineProperty(e,t,{value:n,writable:!0,configurable:!0})}catch(n){h&&_.log(`Failed to add non-enumerable property "${t}" to object`,e)}}function W(e,t){try{const n=t.prototype||{};e.prototype=t.prototype=n,Y(e,"__sentry_original__",t)}catch(e){}}function K(e){return e.__sentry_original__}function V(e){if(I(e))return{message:e.message,name:e.name,stack:e.stack,...Q(e)};if(C(e)){const t={type:e.type,target:J(e.target),currentTarget:J(e.currentTarget),...Q(e)};return"undefined"!=typeof CustomEvent&&q(e,CustomEvent)&&(t.detail=e.detail),t}return e}function J(e){try{return t=e,"undefined"!=typeof Element&&q(t,Element)?j(e):Object.prototype.toString.call(e)}catch(e){return"<unknown>"}var t}function Q(e){if("object"==typeof e&&null!==e){const t={};for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t}return{}}function G(e){return X(e,new Map)}function X(e,t){if(function(e){if(!R(e))return!1;try{const t=Object.getPrototypeOf(e).constructor.name;return!t||"Object"===t}catch(e){return!0}}(e)){const n=t.get(e);if(void 0!==n)return n;const r={};t.set(e,r);for(const n of Object.getOwnPropertyNames(e))void 0!==e[n]&&(r[n]=X(e[n],t));return r}if(Array.isArray(e)){const n=t.get(e);if(void 0!==n)return n;const r=[];return t.set(e,r),e.forEach((e=>{r.push(X(e,t))})),r}return e}function Z(){const e=m,t=e.crypto||e.msCrypto;let n=()=>16*Math.random();try{if(t&&t.randomUUID)return t.randomUUID().replace(/-/g,"");t&&t.getRandomValues&&(n=()=>{const e=new Uint8Array(1);return t.getRandomValues(e),e[0]})}catch(e){}return([1e7]+1e3+4e3+8e3+1e11).replace(/[018]/g,(e=>(e^(15&n())>>e/4).toString(16)))}function ee(e){return e.exception&&e.exception.values?e.exception.values[0]:void 0}function te(e){const{message:t,event_id:n}=e;if(t)return t;const r=ee(e);return r?r.type&&r.value?`${r.type}: ${r.value}`:r.type||r.value||n||"<unknown>":n||"<unknown>"}function ne(e,t,n){const r=e.exception=e.exception||{},s=r.values=r.values||[],o=s[0]=s[0]||{};o.value||(o.value=t||""),o.type||(o.type=n||"Error")}function re(e,t){const n=ee(e);if(!n)return;const r=n.mechanism;if(n.mechanism={type:"generic",handled:!0,...r,...t},t&&"data"in t){const e={...r&&r.data,...t.data};n.mechanism.data=e}}function se(e){if(function(e){try{return e.__sentry_captured__}catch(e){}}(e))return!0;try{Y(e,"__sentry_captured__",!0)}catch(e){}return!1}const oe=[/^Script error\.?$/,/^Javascript error: Script error\.? on line 0$/,/^ResizeObserver loop completed with undelivered notifications.$/,/^Cannot redefine property: googletag$/,"undefined is not an object (evaluating 'a.L')",'can\'t redefine non-configurable property "solana"',"vv().getRestrictions is not a function. (In 'vv().getRestrictions(1,a)', 'vv().getRestrictions' is undefined)","Can't find variable: _AutofillCallbackHandler",/^Non-Error promise rejection captured with value: Object Not Found Matching Id:\d+, MethodName:simulateEvent, ParamCount:\d+$/],ie=(e={})=>({name:"InboundFilters",processEvent(t,n,r){const s=r.getOptions(),o=function(e={},t={}){return{allowUrls:[...e.allowUrls||[],...t.allowUrls||[]],denyUrls:[...e.denyUrls||[],...t.denyUrls||[]],ignoreErrors:[...e.ignoreErrors||[],...t.ignoreErrors||[],...e.disableErrorDefaults?[]:oe],ignoreTransactions:[...e.ignoreTransactions||[],...t.ignoreTransactions||[]],ignoreInternal:void 0===e.ignoreInternal||e.ignoreInternal}}(e,s);return function(e,t){if(t.ignoreInternal&&function(e){try{return"SentryError"===e.exception.values[0].type}catch(e){}return!1}(e))return d&&_.warn(`Event dropped due to being internal Sentry Error.\nEvent: ${te(e)}`),!0;if(function(e,t){if(e.type||!t||!t.length)return!1;return function(e){const t=[];e.message&&t.push(e.message);let n;try{n=e.exception.values[e.exception.values.length-1]}catch(e){}n&&n.value&&(t.push(n.value),n.type&&t.push(`${n.type}: ${n.value}`));return t}(e).some((e=>H(e,t)))}(e,t.ignoreErrors))return d&&_.warn(`Event dropped due to being matched by \`ignoreErrors\` option.\nEvent: ${te(e)}`),!0;if(function(e){if(e.type)return!1;if(!e.exception||!e.exception.values||0===e.exception.values.length)return!1;return!e.message&&!e.exception.values.some((e=>e.stacktrace||e.type&&"Error"!==e.type||e.value))}(e))return d&&_.warn(`Event dropped due to not having an error message, error type or stacktrace.\nEvent: ${te(e)}`),!0;if(function(e,t){if("transaction"!==e.type||!t||!t.length)return!1;const n=e.transaction;return!!n&&H(n,t)}(e,t.ignoreTransactions))return d&&_.warn(`Event dropped due to being matched by \`ignoreTransactions\` option.\nEvent: ${te(e)}`),!0;if(function(e,t){if(!t||!t.length)return!1;const n=ae(e);return!!n&&H(n,t)}(e,t.denyUrls))return d&&_.warn(`Event dropped due to being matched by \`denyUrls\` option.\nEvent: ${te(e)}.\nUrl: ${ae(e)}`),!0;if(!function(e,t){if(!t||!t.length)return!0;const n=ae(e);return!n||H(n,t)}(e,t.allowUrls))return d&&_.warn(`Event dropped due to not being matched by \`allowUrls\` option.\nEvent: ${te(e)}.\nUrl: ${ae(e)}`),!0;return!1}(t,o)?null:t}});function ae(e){try{let t;try{t=e.exception.values[0].stacktrace.frames}catch(e){}return t?function(e=[]){for(let t=e.length-1;t>=0;t--){const n=e[t];if(n&&"<anonymous>"!==n.filename&&"[native code]"!==n.filename)return n.filename||null}return null}(t):null}catch(t){return d&&_.error(`Cannot extract url for event ${te(e)}`),null}}function ce(){return ue(m),m}function ue(e){const t=e.__SENTRY__=e.__SENTRY__||{};return t.version=t.version||p,t[p]=t[p]||{}}function le(){return Date.now()/1e3}const de=function(){const{performance:e}=m;if(!e||!e.now)return le;const t=Date.now()-e.now(),n=null==e.timeOrigin?t:e.timeOrigin;return()=>(n+e.now())/1e3}();let he;(()=>{const{performance:e}=m;if(!e||!e.now)return void(he="none");const t=36e5,n=e.now(),r=Date.now(),s=e.timeOrigin?Math.abs(e.timeOrigin+n-r):t,o=s<t,i=e.timing&&e.timing.navigationStart,a="number"==typeof i?Math.abs(i+n-r):t;o||a<t?s<=a?(he="timeOrigin",e.timeOrigin):he="navigationStart":he="dateNow"})();function pe(e){const t=de(),n={sid:Z(),init:!0,timestamp:t,started:t,duration:0,status:"ok",errors:0,ignoreDuration:!1,toJSON:()=>function(e){return G({sid:`${e.sid}`,init:e.init,started:new Date(1e3*e.started).toISOString(),timestamp:new Date(1e3*e.timestamp).toISOString(),status:e.status,errors:e.errors,did:"number"==typeof e.did||"string"==typeof e.did?`${e.did}`:void 0,duration:e.duration,abnormal_mechanism:e.abnormal_mechanism,attrs:{release:e.release,environment:e.environment,ip_address:e.ipAddress,user_agent:e.userAgent}})}(n)};return e&&me(n,e),n}function me(e,t={}){if(t.user&&(!e.ipAddress&&t.user.ip_address&&(e.ipAddress=t.user.ip_address),e.did||t.did||(e.did=t.user.id||t.user.email||t.user.username)),e.timestamp=t.timestamp||de(),t.abnormal_mechanism&&(e.abnormal_mechanism=t.abnormal_mechanism),t.ignoreDuration&&(e.ignoreDuration=t.ignoreDuration),t.sid&&(e.sid=32===t.sid.length?t.sid:Z()),void 0!==t.init&&(e.init=t.init),!e.did&&t.did&&(e.did=`${t.did}`),"number"==typeof t.started&&(e.started=t.started),e.ignoreDuration)e.duration=void 0;else if("number"==typeof t.duration)e.duration=t.duration;else{const t=e.timestamp-e.started;e.duration=t>=0?t:0}t.release&&(e.release=t.release),t.environment&&(e.environment=t.environment),!e.ipAddress&&t.ipAddress&&(e.ipAddress=t.ipAddress),!e.userAgent&&t.userAgent&&(e.userAgent=t.userAgent),"number"==typeof t.errors&&(e.errors=t.errors),t.status&&(e.status=t.status)}function fe(){return Z()}function ge(){return Z().substring(16)}function be(e,t,n=2){if(!t||"object"!=typeof t||n<=0)return t;if(e&&t&&0===Object.keys(t).length)return e;const r={...e};for(const e in t)Object.prototype.hasOwnProperty.call(t,e)&&(r[e]=be(r[e],t[e],n-1));return r}const ye="_sentrySpan";function _e(e,t){t?Y(e,ye,t):delete e[ye]}function we(e){return e[ye]}class ve{constructor(){this._notifyingListeners=!1,this._scopeListeners=[],this._eventProcessors=[],this._breadcrumbs=[],this._attachments=[],this._user={},this._tags={},this._extra={},this._contexts={},this._sdkProcessingMetadata={},this._propagationContext={traceId:fe(),spanId:ge()}}clone(){const e=new ve;return e._breadcrumbs=[...this._breadcrumbs],e._tags={...this._tags},e._extra={...this._extra},e._contexts={...this._contexts},this._contexts.flags&&(e._contexts.flags={values:[...this._contexts.flags.values]}),e._user=this._user,e._level=this._level,e._session=this._session,e._transactionName=this._transactionName,e._fingerprint=this._fingerprint,e._eventProcessors=[...this._eventProcessors],e._requestSession=this._requestSession,e._attachments=[...this._attachments],e._sdkProcessingMetadata={...this._sdkProcessingMetadata},e._propagationContext={...this._propagationContext},e._client=this._client,e._lastEventId=this._lastEventId,_e(e,we(this)),e}setClient(e){this._client=e}setLastEventId(e){this._lastEventId=e}getClient(){return this._client}lastEventId(){return this._lastEventId}addScopeListener(e){this._scopeListeners.push(e)}addEventProcessor(e){return this._eventProcessors.push(e),this}setUser(e){return this._user=e||{email:void 0,id:void 0,ip_address:void 0,username:void 0},this._session&&me(this._session,{user:e}),this._notifyScopeListeners(),this}getUser(){return this._user}getRequestSession(){return this._requestSession}setRequestSession(e){return this._requestSession=e,this}setTags(e){return this._tags={...this._tags,...e},this._notifyScopeListeners(),this}setTag(e,t){return this._tags={...this._tags,[e]:t},this._notifyScopeListeners(),this}setExtras(e){return this._extra={...this._extra,...e},this._notifyScopeListeners(),this}setExtra(e,t){return this._extra={...this._extra,[e]:t},this._notifyScopeListeners(),this}setFingerprint(e){return this._fingerprint=e,this._notifyScopeListeners(),this}setLevel(e){return this._level=e,this._notifyScopeListeners(),this}setTransactionName(e){return this._transactionName=e,this._notifyScopeListeners(),this}setContext(e,t){return null===t?delete this._contexts[e]:this._contexts[e]=t,this._notifyScopeListeners(),this}setSession(e){return e?this._session=e:delete this._session,this._notifyScopeListeners(),this}getSession(){return this._session}update(e){if(!e)return this;const t="function"==typeof e?e(this):e,[n,r]=t instanceof ke?[t.getScopeData(),t.getRequestSession()]:R(t)?[e,e.requestSession]:[],{tags:s,extra:o,user:i,contexts:a,level:c,fingerprint:u=[],propagationContext:l}=n||{};return this._tags={...this._tags,...s},this._extra={...this._extra,...o},this._contexts={...this._contexts,...a},i&&Object.keys(i).length&&(this._user=i),c&&(this._level=c),u.length&&(this._fingerprint=u),l&&(this._propagationContext=l),r&&(this._requestSession=r),this}clear(){return this._breadcrumbs=[],this._tags={},this._extra={},this._user={},this._contexts={},this._level=void 0,this._transactionName=void 0,this._fingerprint=void 0,this._requestSession=void 0,this._session=void 0,_e(this,void 0),this._attachments=[],this.setPropagationContext({traceId:fe()}),this._notifyScopeListeners(),this}addBreadcrumb(e,t){const n="number"==typeof t?t:100;if(n<=0)return this;const r={timestamp:le(),...e};return this._breadcrumbs.push(r),this._breadcrumbs.length>n&&(this._breadcrumbs=this._breadcrumbs.slice(-n),this._client&&this._client.recordDroppedEvent("buffer_overflow","log_item")),this._notifyScopeListeners(),this}getLastBreadcrumb(){return this._breadcrumbs[this._breadcrumbs.length-1]}clearBreadcrumbs(){return this._breadcrumbs=[],this._notifyScopeListeners(),this}addAttachment(e){return this._attachments.push(e),this}clearAttachments(){return this._attachments=[],this}getScopeData(){return{breadcrumbs:this._breadcrumbs,attachments:this._attachments,contexts:this._contexts,tags:this._tags,extra:this._extra,user:this._user,level:this._level,fingerprint:this._fingerprint||[],eventProcessors:this._eventProcessors,propagationContext:this._propagationContext,sdkProcessingMetadata:this._sdkProcessingMetadata,transactionName:this._transactionName,span:we(this)}}setSDKProcessingMetadata(e){return this._sdkProcessingMetadata=be(this._sdkProcessingMetadata,e,2),this}setPropagationContext(e){return this._propagationContext={spanId:ge(),...e},this}getPropagationContext(){return this._propagationContext}captureException(e,t){const n=t&&t.event_id?t.event_id:Z();if(!this._client)return _.warn("No client configured on scope - will not capture exception!"),n;const r=new Error("Sentry syntheticException");return this._client.captureException(e,{originalException:e,syntheticException:r,...t,event_id:n},this),n}captureMessage(e,t,n){const r=n&&n.event_id?n.event_id:Z();if(!this._client)return _.warn("No client configured on scope - will not capture message!"),r;const s=new Error(e);return this._client.captureMessage(e,t,{originalException:e,syntheticException:s,...n,event_id:r},this),r}captureEvent(e,t){const n=t&&t.event_id?t.event_id:Z();return this._client?(this._client.captureEvent(e,{...t,event_id:n},this),n):(_.warn("No client configured on scope - will not capture event!"),n)}_notifyScopeListeners(){this._notifyingListeners||(this._notifyingListeners=!0,this._scopeListeners.forEach((e=>{e(this)})),this._notifyingListeners=!1)}}const ke=ve;class Ee{constructor(e,t){let n,r;n=e||new ke,r=t||new ke,this._stack=[{scope:n}],this._isolationScope=r}withScope(e){const t=this._pushScope();let n;try{n=e(t)}catch(e){throw this._popScope(),e}return $(n)?n.then((e=>(this._popScope(),e)),(e=>{throw this._popScope(),e})):(this._popScope(),n)}getClient(){return this.getStackTop().client}getScope(){return this.getStackTop().scope}getIsolationScope(){return this._isolationScope}getStackTop(){return this._stack[this._stack.length-1]}_pushScope(){const e=this.getScope().clone();return this._stack.push({client:this.getClient(),scope:e}),e}_popScope(){return!(this._stack.length<=1)&&!!this._stack.pop()}}function xe(){const e=ue(ce());return e.stack=e.stack||new Ee(f("defaultCurrentScope",(()=>new ke)),f("defaultIsolationScope",(()=>new ke)))}function Ie(e){return xe().withScope(e)}function Te(e,t){const n=xe();return n.withScope((()=>(n.getStackTop().scope=e,t(e))))}function Se(e){return xe().withScope((()=>e(xe().getIsolationScope())))}function Pe(e){const t=ue(e);return t.acs?t.acs:{withIsolationScope:Se,withScope:Ie,withSetScope:Te,withSetIsolationScope:(e,t)=>Se(t),getCurrentScope:()=>xe().getScope(),getIsolationScope:()=>xe().getIsolationScope()}}function Oe(){return Pe(ce()).getCurrentScope()}function Ae(){return Pe(ce()).getIsolationScope()}function Ne(){return Oe().getClient()}function Re(e){const t=e.getPropagationContext(),{traceId:n,spanId:r,parentSpanId:s}=t;return G({trace_id:n,span_id:r,parent_span_id:s})}let Ce;const $e=new WeakMap,qe=()=>({name:"FunctionToString",setupOnce(){Ce=Function.prototype.toString;try{Function.prototype.toString=function(...e){const t=K(this),n=$e.has(Ne())&&void 0!==t?t:this;return Ce.apply(n,e)}}catch(e){}},setup(e){$e.set(e,!0)}}),Le="?",Me=/\(error: (.*)\)/,je=/captureMessage|captureException/;function De(...e){const t=e.sort(((e,t)=>e[0]-t[0])).map((e=>e[1]));return(e,n=0,r=0)=>{const s=[],o=e.split("\n");for(let e=n;e<o.length;e++){const n=o[e];if(n.length>1024)continue;const i=Me.test(n)?n.replace(Me,"$1"):n;if(!i.match(/\S*Error: /)){for(const e of t){const t=e(i);if(t){s.push(t);break}}if(s.length>=50+r)break}}return function(e){if(!e.length)return[];const t=Array.from(e);/sentryWrapped/.test(Ue(t).function||"")&&t.pop();t.reverse(),je.test(Ue(t).function||"")&&(t.pop(),je.test(Ue(t).function||"")&&t.pop());return t.slice(0,50).map((e=>({...e,filename:e.filename||Ue(t).filename,function:e.function||Le})))}(s.slice(r))}}function Ue(e){return e[e.length-1]||{}}const Be="<anonymous>";function Fe(e){try{return e&&"function"==typeof e&&e.name||Be}catch(e){return Be}}function He(e){const t=e.exception;if(t){const e=[];try{return t.values.forEach((t=>{t.stacktrace.frames&&e.push(...t.stacktrace.frames)})),e}catch(e){return}}}const ze=()=>{let e;return{name:"Dedupe",processEvent(t){if(t.type)return t;try{if(function(e,t){if(!t)return!1;if(function(e,t){const n=e.message,r=t.message;if(!n&&!r)return!1;if(n&&!r||!n&&r)return!1;if(n!==r)return!1;if(!We(e,t))return!1;if(!Ye(e,t))return!1;return!0}(e,t))return!0;if(function(e,t){const n=Ke(t),r=Ke(e);if(!n||!r)return!1;if(n.type!==r.type||n.value!==r.value)return!1;if(!We(e,t))return!1;if(!Ye(e,t))return!1;return!0}(e,t))return!0;return!1}(t,e))return d&&_.warn("Event dropped due to being a duplicate of previously captured event."),null}catch(e){}return e=t}}};function Ye(e,t){let n=He(e),r=He(t);if(!n&&!r)return!0;if(n&&!r||!n&&r)return!1;if(r.length!==n.length)return!1;for(let e=0;e<r.length;e++){const t=r[e],s=n[e];if(t.filename!==s.filename||t.lineno!==s.lineno||t.colno!==s.colno||t.function!==s.function)return!1}return!0}function We(e,t){let n=e.fingerprint,r=t.fingerprint;if(!n&&!r)return!0;if(n&&!r||!n&&r)return!1;try{return!(n.join("")!==r.join(""))}catch(e){return!1}}function Ke(e){return e.exception&&e.exception.values&&e.exception.values[0]}const Ve=m;function Je(){if(!("fetch"in Ve))return!1;try{return new Headers,new Request("http://www.example.com"),new Response,!0}catch(e){return!1}}function Qe(e){return e&&/^function\s+\w+\(\)\s+\{\s+\[native code\]\s+\}$/.test(e.toString())}function Ge(e,t){!0===t.debug&&(d?_.enable():y((()=>{})));Oe().update(t.initialScope);const n=new e(t);return function(e){Oe().setClient(e)}(n),n.init(),n}function Xe(e){const t=e.protocol?`${e.protocol}:`:"",n=e.port?`:${e.port}`:"";return`${t}//${e.host}${n}${e.path?`/${e.path}`:""}/api/`}function Ze(e,t,n){return t||`${function(e){return`${Xe(e)}${e.projectId}/envelope/`}(e)}?${function(e,t){const n={sentry_version:"7"};return e.publicKey&&(n.sentry_key=e.publicKey),t&&(n.sentry_client=`${t.name}/${t.version}`),new URLSearchParams(n).toString()}(e,n)}`}const et=/^(?:(\w+):)\/\/(?:(\w+)(?::(\w+)?)?@)([\w.-]+)(?::(\d+))?\/(.+)/;function tt(e,t=!1){const{host:n,path:r,pass:s,port:o,projectId:i,protocol:a,publicKey:c}=e;return`${a}://${c}${t&&s?`:${s}`:""}@${n}${o?`:${o}`:""}/${r?`${r}/`:r}${i}`}function nt(e){return{protocol:e.protocol,publicKey:e.publicKey||"",pass:e.pass||"",host:e.host,port:e.port||"",path:e.path||"",projectId:e.projectId}}function rt(e){const t="string"==typeof e?function(e){const t=et.exec(e);if(!t)return void y((()=>{}));const[n,r,s="",o="",i="",a=""]=t.slice(1);let c="",u=a;const l=u.split("/");if(l.length>1&&(c=l.slice(0,-1).join("/"),u=l.pop()),u){const e=u.match(/^\d+/);e&&(u=e[0])}return nt({host:o,pass:s,path:c,projectId:u,port:i,protocol:n,publicKey:r})}(e):nt(e);if(t&&function(e){if(!h)return!0;const{port:t,projectId:n,protocol:r}=e;return!(["protocol","publicKey","host","projectId"].find((t=>!e[t]&&(_.error(`Invalid Sentry Dsn: ${t} missing`),!0)))||(n.match(/^\d+$/)?function(e){return"http"===e||"https"===e}(r)?t&&isNaN(parseInt(t,10))&&(_.error(`Invalid Sentry Dsn: Invalid port ${t}`),1):(_.error(`Invalid Sentry Dsn: Invalid protocol ${r}`),1):(_.error(`Invalid Sentry Dsn: Invalid projectId ${n}`),1)))}(t))return t}function st(e,t=100,n=1/0){try{return it("",e,t,n)}catch(e){return{ERROR:`**non-serializable** (${e})`}}}function ot(e,t=3,n=102400){const r=st(e,t);return s=r,function(e){return~-encodeURI(e).split(/%..|./).length}(JSON.stringify(s))>n?ot(e,t-1,n):r;var s}function it(e,t,n=1/0,r=1/0,s=function(){const e="function"==typeof WeakSet,t=e?new WeakSet:[];return[function(n){if(e)return!!t.has(n)||(t.add(n),!1);for(let e=0;e<t.length;e++)if(t[e]===n)return!0;return t.push(n),!1},function(n){if(e)t.delete(n);else for(let e=0;e<t.length;e++)if(t[e]===n){t.splice(e,1);break}}]}()){const[o,i]=s;if(null==t||["boolean","string"].includes(typeof t)||"number"==typeof t&&Number.isFinite(t))return t;const a=function(e,t){try{if("domain"===e&&t&&"object"==typeof t&&t._events)return"[Domain]";if("domainEmitter"===e)return"[DomainEmitter]";if("undefined"!=typeof global&&t===global)return"[Global]";if("undefined"!=typeof window&&t===window)return"[Window]";if("undefined"!=typeof document&&t===document)return"[Document]";if(L(t))return"[VueViewModel]";if(R(n=t)&&"nativeEvent"in n&&"preventDefault"in n&&"stopPropagation"in n)return"[SyntheticEvent]";if("number"==typeof t&&!Number.isFinite(t))return`[${t}]`;if("function"==typeof t)return`[Function: ${Fe(t)}]`;if("symbol"==typeof t)return`[${String(t)}]`;if("bigint"==typeof t)return`[BigInt: ${String(t)}]`;const r=function(e){const t=Object.getPrototypeOf(e);return t?t.constructor.name:"null prototype"}(t);return/^HTML(\w*)Element$/.test(r)?`[HTMLElement: ${r}]`:`[object ${r}]`}catch(e){return`**non-serializable** (${e})`}var n}(e,t);if(!a.startsWith("[object "))return a;if(t.__sentry_skip_normalization__)return t;const c="number"==typeof t.__sentry_override_normalization_depth__?t.__sentry_override_normalization_depth__:n;if(0===c)return a.replace("object ","");if(o(t))return"[Circular ~]";const u=t;if(u&&"function"==typeof u.toJSON)try{return it("",u.toJSON(),c-1,r,s)}catch(e){}const l=Array.isArray(t)?[]:{};let d=0;const h=V(t);for(const e in h){if(!Object.prototype.hasOwnProperty.call(h,e))continue;if(d>=r){l[e]="[MaxProperties ~]";break}const t=h[e];l[e]=it(e,t,c-1,r,s),d++}return i(t),l}function at(e,t=[]){return[e,t]}function ct(e,t){const[n,r]=e;return[n,[...r,t]]}function ut(e,t){const n=e[1];for(const e of n){if(t(e,e[0].type))return!0}return!1}function lt(e){return m.__SENTRY__&&m.__SENTRY__.encodePolyfill?m.__SENTRY__.encodePolyfill(e):(new TextEncoder).encode(e)}function dt(e){const[t,n]=e;let r=JSON.stringify(t);function s(e){"string"==typeof r?r="string"==typeof e?r+e:[lt(r),e]:r.push("string"==typeof e?lt(e):e)}for(const e of n){const[t,n]=e;if(s(`\n${JSON.stringify(t)}\n`),"string"==typeof n||n instanceof Uint8Array)s(n);else{let e;try{e=JSON.stringify(n)}catch(t){e=JSON.stringify(st(n))}s(e)}}return"string"==typeof r?r:function(e){const t=e.reduce(((e,t)=>e+t.length),0),n=new Uint8Array(t);let r=0;for(const t of e)n.set(t,r),r+=t.length;return n}(r)}function ht(e){const t="string"==typeof e.data?lt(e.data):e.data;return[G({type:"attachment",length:t.length,filename:e.filename,content_type:e.contentType,attachment_type:e.attachmentType}),t]}const pt={session:"session",sessions:"session",attachment:"attachment",transaction:"transaction",event:"error",client_report:"internal",user_report:"default",profile:"profile",profile_chunk:"profile",replay_event:"replay",replay_recording:"replay",check_in:"monitor",feedback:"feedback",span:"span",statsd:"metric_bucket",raw_security:"security"};function mt(e){return pt[e]}function ft(e){if(!e||!e.sdk)return;const{name:t,version:n}=e.sdk;return{name:t,version:n}}function gt(e,t,n,r){const s=ft(n),o=e.type&&"replay_event"!==e.type?e.type:"event";!function(e,t){t&&(e.sdk=e.sdk||{},e.sdk.name=e.sdk.name||t.name,e.sdk.version=e.sdk.version||t.version,e.sdk.integrations=[...e.sdk.integrations||[],...t.integrations||[]],e.sdk.packages=[...e.sdk.packages||[],...t.packages||[]])}(e,n&&n.sdk);const i=function(e,t,n,r){const s=e.sdkProcessingMetadata&&e.sdkProcessingMetadata.dynamicSamplingContext;return{event_id:e.event_id,sent_at:(new Date).toISOString(),...t&&{sdk:t},...!!n&&r&&{dsn:tt(r)},...s&&{trace:G({...s})}}}(e,s,r,t);delete e.sdkProcessingMetadata;return at(i,[[{type:o},e]])}const bt="production",yt=/^sentry-/;function _t(e){const t=function(e){if(!e||!O(e)&&!Array.isArray(e))return;if(Array.isArray(e))return e.reduce(((e,t)=>{const n=wt(t);return Object.entries(n).forEach((([t,n])=>{e[t]=n})),e}),{});return wt(e)}(e);if(!t)return;const n=Object.entries(t).reduce(((e,[t,n])=>{if(t.match(yt)){e[t.slice(7)]=n}return e}),{});return Object.keys(n).length>0?n:void 0}function wt(e){return e.split(",").map((e=>e.split("=").map((e=>decodeURIComponent(e.trim()))))).reduce(((e,[t,n])=>(t&&n&&(e[t]=n),e)),{})}const vt="_sentryMetrics";function kt(e){const t=e[vt];if(!t)return;const n={};for(const[,[e,r]]of t){(n[e]||(n[e]=[])).push(G(r))}return n}let Et=!1;function xt(e){const{spanId:t,traceId:n,isRemote:r}=e.spanContext();return G({parent_span_id:r?t:St(e).parent_span_id,span_id:r?ge():t,trace_id:n})}function It(e){return"number"==typeof e?Tt(e):Array.isArray(e)?e[0]+e[1]/1e9:e instanceof Date?Tt(e.getTime()):de()}function Tt(e){return e>9999999999?e/1e3:e}function St(e){if(function(e){return"function"==typeof e.getSpanJSON}(e))return e.getSpanJSON();try{const{spanId:t,traceId:n}=e.spanContext();if(function(e){const t=e;return!!(t.attributes&&t.startTime&&t.name&&t.endTime&&t.status)}(e)){const{attributes:r,startTime:s,name:o,endTime:i,parentSpanId:a,status:c}=e;return G({span_id:t,trace_id:n,data:r,description:o,parent_span_id:a,start_timestamp:It(s),timestamp:It(i)||void 0,status:Ot(c),op:r["sentry.op"],origin:r["sentry.origin"],_metrics_summary:kt(e)})}return{span_id:t,trace_id:n}}catch(e){return{}}}function Pt(e){const{traceFlags:t}=e.spanContext();return 1===t}function Ot(e){if(e&&0!==e.code)return 1===e.code?"ok":e.message||"unknown_error"}const At="_sentryRootSpan";function Nt(e){return e[At]||e}function Rt(){Et||(y((()=>{})),Et=!0)}const Ct="_frozenDsc";function $t(e,t){const n=t.getOptions(),{publicKey:r}=t.getDsn()||{},s=G({environment:n.environment||bt,release:n.release,public_key:r,trace_id:e});return t.emit("createDsc",s),s}function qt(e){const t=Ne();if(!t)return{};const n=Nt(e),r=n[Ct];if(r)return r;const s=n.spanContext().traceState,o=s&&s.get("sentry.dsc"),i=o&&_t(o);if(i)return i;const a=$t(e.spanContext().traceId,t),c=St(n),u=c.data||{},l=u["sentry.sample_rate"];null!=l&&(a.sample_rate=`${l}`);const d=u["sentry.source"],h=c.description;return"url"!==d&&h&&(a.transaction=h),function(e){if("boolean"==typeof __SENTRY_TRACING__&&!__SENTRY_TRACING__)return!1;const t=Ne(),n=e||t&&t.getOptions();return!!n&&(n.enableTracing||"tracesSampleRate"in n||"tracesSampler"in n)}()&&(a.sampled=String(Pt(n))),t.emit("createDsc",a,n),a}class Lt extends Error{constructor(e,t="warn"){super(e),this.message=e,this.name=new.target.prototype.constructor.name,Object.setPrototypeOf(this,new.target.prototype),this.logLevel=t}}var Mt;function jt(e){return new Ut((t=>{t(e)}))}function Dt(e){return new Ut(((t,n)=>{n(e)}))}!function(e){e[e.PENDING=0]="PENDING";e[e.RESOLVED=1]="RESOLVED";e[e.REJECTED=2]="REJECTED"}(Mt||(Mt={}));class Ut{constructor(e){Ut.prototype.__init.call(this),Ut.prototype.__init2.call(this),Ut.prototype.__init3.call(this),Ut.prototype.__init4.call(this),this._state=Mt.PENDING,this._handlers=[];try{e(this._resolve,this._reject)}catch(e){this._reject(e)}}then(e,t){return new Ut(((n,r)=>{this._handlers.push([!1,t=>{if(e)try{n(e(t))}catch(e){r(e)}else n(t)},e=>{if(t)try{n(t(e))}catch(e){r(e)}else r(e)}]),this._executeHandlers()}))}catch(e){return this.then((e=>e),e)}finally(e){return new Ut(((t,n)=>{let r,s;return this.then((t=>{s=!1,r=t,e&&e()}),(t=>{s=!0,r=t,e&&e()})).then((()=>{s?n(r):t(r)}))}))}__init(){this._resolve=e=>{this._setResult(Mt.RESOLVED,e)}}__init2(){this._reject=e=>{this._setResult(Mt.REJECTED,e)}}__init3(){this._setResult=(e,t)=>{this._state===Mt.PENDING&&($(t)?t.then(this._resolve,this._reject):(this._state=e,this._value=t,this._executeHandlers()))}}__init4(){this._executeHandlers=()=>{if(this._state===Mt.PENDING)return;const e=this._handlers.slice();this._handlers=[],e.forEach((e=>{e[0]||(this._state===Mt.RESOLVED&&e[1](this._value),this._state===Mt.REJECTED&&e[2](this._value),e[0]=!0)}))}}}function Bt(e,t,n,r=0){return new Ut(((s,o)=>{const i=e[r];if(null===t||"function"!=typeof i)s(t);else{const a=i({...t},n);d&&i.id&&null===a&&_.log(`Event processor "${i.id}" dropped event`),$(a)?a.then((t=>Bt(e,t,n,r+1).then(s))).then(null,o):Bt(e,a,n,r+1).then(s).then(null,o)}}))}let Ft,Ht,zt;function Yt(e){const t=m._sentryDebugIds;if(!t)return{};const n=Object.keys(t);return zt&&n.length===Ht||(Ht=n.length,zt=n.reduce(((n,r)=>{Ft||(Ft={});const s=Ft[r];if(s)n[s[0]]=s[1];else{const s=e(r);for(let e=s.length-1;e>=0;e--){const o=s[e],i=o&&o.filename,a=t[r];if(i&&a){n[i]=a,Ft[r]=[i,a];break}}}return n}),{})),zt}function Wt(e,t){const{fingerprint:n,span:r,breadcrumbs:s,sdkProcessingMetadata:o}=t;!function(e,t){const{extra:n,tags:r,user:s,contexts:o,level:i,transactionName:a}=t,c=G(n);c&&Object.keys(c).length&&(e.extra={...c,...e.extra});const u=G(r);u&&Object.keys(u).length&&(e.tags={...u,...e.tags});const l=G(s);l&&Object.keys(l).length&&(e.user={...l,...e.user});const d=G(o);d&&Object.keys(d).length&&(e.contexts={...d,...e.contexts});i&&(e.level=i);a&&"transaction"!==e.type&&(e.transaction=a)}(e,t),r&&function(e,t){e.contexts={trace:xt(t),...e.contexts},e.sdkProcessingMetadata={dynamicSamplingContext:qt(t),...e.sdkProcessingMetadata};const n=Nt(t),r=St(n).description;r&&!e.transaction&&"transaction"===e.type&&(e.transaction=r)}(e,r),function(e,t){e.fingerprint=e.fingerprint?Array.isArray(e.fingerprint)?e.fingerprint:[e.fingerprint]:[],t&&(e.fingerprint=e.fingerprint.concat(t));e.fingerprint&&!e.fingerprint.length&&delete e.fingerprint}(e,n),function(e,t){const n=[...e.breadcrumbs||[],...t];e.breadcrumbs=n.length?n:void 0}(e,s),function(e,t){e.sdkProcessingMetadata={...e.sdkProcessingMetadata,...t}}(e,o)}function Kt(e,t){const{extra:n,tags:r,user:s,contexts:o,level:i,sdkProcessingMetadata:a,breadcrumbs:c,fingerprint:u,eventProcessors:l,attachments:d,propagationContext:h,transactionName:p,span:m}=t;Vt(e,"extra",n),Vt(e,"tags",r),Vt(e,"user",s),Vt(e,"contexts",o),e.sdkProcessingMetadata=be(e.sdkProcessingMetadata,a,2),i&&(e.level=i),p&&(e.transactionName=p),m&&(e.span=m),c.length&&(e.breadcrumbs=[...e.breadcrumbs,...c]),u.length&&(e.fingerprint=[...e.fingerprint,...u]),l.length&&(e.eventProcessors=[...e.eventProcessors,...l]),d.length&&(e.attachments=[...e.attachments,...d]),e.propagationContext={...e.propagationContext,...h}}function Vt(e,t,n){e[t]=be(e[t],n,1)}function Jt(e,t,n,r,s,o){const{normalizeDepth:i=3,normalizeMaxBreadth:a=1e3}=e,c={...t,event_id:t.event_id||n.event_id||Z(),timestamp:t.timestamp||le()},u=n.integrations||e.integrations.map((e=>e.name));!function(e,t){const{environment:n,release:r,dist:s,maxValueLength:o=250}=t;e.environment=e.environment||n||bt,!e.release&&r&&(e.release=r);!e.dist&&s&&(e.dist=s);e.message&&(e.message=U(e.message,o));const i=e.exception&&e.exception.values&&e.exception.values[0];i&&i.value&&(i.value=U(i.value,o));const a=e.request;a&&a.url&&(a.url=U(a.url,o))}(c,e),function(e,t){t.length>0&&(e.sdk=e.sdk||{},e.sdk.integrations=[...e.sdk.integrations||[],...t])}(c,u),s&&s.emit("applyFrameMetadata",t),void 0===t.type&&function(e,t){const n=Yt(t);try{e.exception.values.forEach((e=>{e.stacktrace.frames.forEach((e=>{n&&e.filename&&(e.debug_id=n[e.filename])}))}))}catch(e){}}(c,e.stackParser);const l=function(e,t){if(!t)return e;const n=e?e.clone():new ke;return n.update(t),n}(r,n.captureContext);n.mechanism&&re(c,n.mechanism);const d=s?s.getEventProcessors():[],h=f("globalScope",(()=>new ke)).getScopeData();if(o){Kt(h,o.getScopeData())}if(l){Kt(h,l.getScopeData())}const p=[...n.attachments||[],...h.attachments];p.length&&(n.attachments=p),Wt(c,h);return Bt([...d,...h.eventProcessors],c,n).then((e=>(e&&function(e){const t={};try{e.exception.values.forEach((e=>{e.stacktrace.frames.forEach((e=>{e.debug_id&&(e.abs_path?t[e.abs_path]=e.debug_id:e.filename&&(t[e.filename]=e.debug_id),delete e.debug_id)}))}))}catch(e){}if(0===Object.keys(t).length)return;e.debug_meta=e.debug_meta||{},e.debug_meta.images=e.debug_meta.images||[];const n=e.debug_meta.images;Object.entries(t).forEach((([e,t])=>{n.push({type:"sourcemap",code_file:e,debug_id:t})}))}(e),"number"==typeof i&&i>0?function(e,t,n){if(!e)return null;const r={...e,...e.breadcrumbs&&{breadcrumbs:e.breadcrumbs.map((e=>({...e,...e.data&&{data:st(e.data,t,n)}})))},...e.user&&{user:st(e.user,t,n)},...e.contexts&&{contexts:st(e.contexts,t,n)},...e.extra&&{extra:st(e.extra,t,n)}};e.contexts&&e.contexts.trace&&r.contexts&&(r.contexts.trace=e.contexts.trace,e.contexts.trace.data&&(r.contexts.trace.data=st(e.contexts.trace.data,t,n)));e.spans&&(r.spans=e.spans.map((e=>({...e,...e.data&&{data:st(e.data,t,n)}}))));e.contexts&&e.contexts.flags&&r.contexts&&(r.contexts.flags=st(e.contexts.flags,3,n));return r}(e,i,a):e)))}function Qt(e){if(e)return function(e){return e instanceof ke||"function"==typeof e}(e)||function(e){return Object.keys(e).some((e=>Gt.includes(e)))}(e)?{captureContext:e}:e}const Gt=["user","level","extra","contexts","tags","fingerprint","requestSession","propagationContext"];const Xt="Not capturing exception because it's already been captured.";class Zt{constructor(e){if(this._options=e,this._integrations={},this._numProcessing=0,this._outcomes={},this._hooks={},this._eventProcessors=[],e.dsn?this._dsn=rt(e.dsn):d&&_.warn("No DSN provided, client will not send events."),this._dsn){const t=Ze(this._dsn,e.tunnel,e._metadata?e._metadata.sdk:void 0);this._transport=e.transport({tunnel:this._options.tunnel,recordDroppedEvent:this.recordDroppedEvent.bind(this),...e.transportOptions,url:t})}["enableTracing","tracesSampleRate","tracesSampler"].find((t=>t in e&&null==e[t]))&&y((()=>{}))}captureException(e,t,n){const r=Z();if(se(e))return d&&_.log(Xt),r;const s={event_id:r,...t};return this._process(this.eventFromException(e,s).then((e=>this._captureEvent(e,s,n)))),s.event_id}captureMessage(e,t,n,r){const s={event_id:Z(),...n},o=A(e)?e:String(e),i=N(e)?this.eventFromMessage(o,t,s):this.eventFromException(e,s);return this._process(i.then((e=>this._captureEvent(e,s,r)))),s.event_id}captureEvent(e,t,n){const r=Z();if(t&&t.originalException&&se(t.originalException))return d&&_.log(Xt),r;const s={event_id:r,...t},o=(e.sdkProcessingMetadata||{}).capturedSpanScope;return this._process(this._captureEvent(e,s,o||n)),s.event_id}captureSession(e){"string"!=typeof e.release?d&&_.warn("Discarded session because of missing or non-string release"):(this.sendSession(e),me(e,{init:!1}))}getDsn(){return this._dsn}getOptions(){return this._options}getSdkMetadata(){return this._options._metadata}getTransport(){return this._transport}flush(e){const t=this._transport;return t?(this.emit("flush"),this._isClientDoneProcessing(e).then((n=>t.flush(e).then((e=>n&&e))))):jt(!0)}close(e){return this.flush(e).then((e=>(this.getOptions().enabled=!1,this.emit("close"),e)))}getEventProcessors(){return this._eventProcessors}addEventProcessor(e){this._eventProcessors.push(e)}init(){(this._isEnabled()||this._options.integrations.some((({name:e})=>e.startsWith("Spotlight"))))&&this._setupIntegrations()}getIntegrationByName(e){return this._integrations[e]}addIntegration(e){const t=this._integrations[e.name];E(this,e,this._integrations),t||k(this,[e])}sendEvent(e,t={}){this.emit("beforeSendEvent",e,t);let n=gt(e,this._dsn,this._options._metadata,this._options.tunnel);for(const e of t.attachments||[])n=ct(n,ht(e));const r=this.sendEnvelope(n);r&&r.then((t=>this.emit("afterSendEvent",e,t)),null)}sendSession(e){const t=function(e,t,n,r){const s=ft(n);return at({sent_at:(new Date).toISOString(),...s&&{sdk:s},...!!r&&t&&{dsn:tt(t)}},["aggregates"in e?[{type:"sessions"},e]:[{type:"session"},e.toJSON()]])}(e,this._dsn,this._options._metadata,this._options.tunnel);this.sendEnvelope(t)}recordDroppedEvent(e,t,n){if(this._options.sendClientReports){const r="number"==typeof n?n:1,s=`${e}:${t}`;d&&_.log(`Recording outcome: "${s}"${r>1?` (${r} times)`:""}`),this._outcomes[s]=(this._outcomes[s]||0)+r}}on(e,t){const n=this._hooks[e]=this._hooks[e]||[];return n.push(t),()=>{const e=n.indexOf(t);e>-1&&n.splice(e,1)}}emit(e,...t){const n=this._hooks[e];n&&n.forEach((e=>e(...t)))}sendEnvelope(e){return this.emit("beforeEnvelope",e),this._isEnabled()&&this._transport?this._transport.send(e).then(null,(e=>(d&&_.error("Error while sending envelope:",e),e))):(d&&_.error("Transport disabled"),jt({}))}_setupIntegrations(){const{integrations:e}=this._options;this._integrations=function(e,t){const n={};return t.forEach((t=>{t&&E(e,t,n)})),n}(this,e),k(this,e)}_updateSessionFromEvent(e,t){let n="fatal"===t.level,r=!1;const s=t.exception&&t.exception.values;if(s){r=!0;for(const e of s){const t=e.mechanism;if(t&&!1===t.handled){n=!0;break}}}const o="ok"===e.status;(o&&0===e.errors||o&&n)&&(me(e,{...n&&{status:"crashed"},errors:e.errors||Number(r||n)}),this.captureSession(e))}_isClientDoneProcessing(e){return new Ut((t=>{let n=0;const r=setInterval((()=>{0==this._numProcessing?(clearInterval(r),t(!0)):(n+=1,e&&n>=e&&(clearInterval(r),t(!1)))}),1)}))}_isEnabled(){return!1!==this.getOptions().enabled&&void 0!==this._transport}_prepareEvent(e,t,n=Oe(),r=Ae()){const s=this.getOptions(),o=Object.keys(this._integrations);return!t.integrations&&o.length>0&&(t.integrations=o),this.emit("preprocessEvent",e,t),e.type||r.setLastEventId(e.event_id||t.event_id),Jt(s,e,t,n,this,r).then((e=>{if(null===e)return e;e.contexts={trace:Re(n),...e.contexts};const t=function(e,t){const n=t.getPropagationContext();return n.dsc||$t(n.traceId,e)}(this,n);return e.sdkProcessingMetadata={dynamicSamplingContext:t,...e.sdkProcessingMetadata},e}))}_captureEvent(e,t={},n){return this._processEvent(e,t,n).then((e=>e.event_id),(e=>{if(d){const t=e;"log"===t.logLevel?_.log(t.message):_.warn(t)}}))}_processEvent(e,t,n){const r=this.getOptions(),{sampleRate:s}=r,o=tn(e),i=en(e),a=e.type||"error",c=`before send for type \`${a}\``,u=void 0===s?void 0:function(e){if("boolean"==typeof e)return Number(e);const t="string"==typeof e?parseFloat(e):e;if(!("number"!=typeof t||isNaN(t)||t<0||t>1))return t;d&&_.warn(`[Tracing] Given sample rate is invalid. Sample rate must be a boolean or a number between 0 and 1. Got ${JSON.stringify(e)} of type ${JSON.stringify(typeof e)}.`)}(s);if(i&&"number"==typeof u&&Math.random()>u)return this.recordDroppedEvent("sample_rate","error",e),Dt(new Lt(`Discarding event because it's not included in the random sample (sampling rate = ${s})`,"log"));const l="replay_event"===a?"replay":a,h=(e.sdkProcessingMetadata||{}).capturedSpanIsolationScope;return this._prepareEvent(e,t,n,h).then((n=>{if(null===n)throw this.recordDroppedEvent("event_processor",l,e),new Lt("An event processor returned `null`, will not send event.","log");if(t.data&&!0===t.data.__sentry__)return n;const s=function(e,t,n,r){const{beforeSend:s,beforeSendTransaction:o,beforeSendSpan:i}=t;if(en(n)&&s)return s(n,r);if(tn(n)){if(n.spans&&i){const t=[];for(const r of n.spans){const n=i(r);n?t.push(n):(Rt(),e.recordDroppedEvent("before_send","span"))}n.spans=t}if(o){if(n.spans){const e=n.spans.length;n.sdkProcessingMetadata={...n.sdkProcessingMetadata,spanCountBeforeProcessing:e}}return o(n,r)}}return n}(this,r,n,t);return function(e,t){const n=`${t} must return \`null\` or a valid event.`;if($(e))return e.then((e=>{if(!R(e)&&null!==e)throw new Lt(n);return e}),(e=>{throw new Lt(`${t} rejected with ${e}`)}));if(!R(e)&&null!==e)throw new Lt(n);return e}(s,c)})).then((r=>{if(null===r){if(this.recordDroppedEvent("before_send",l,e),o){const t=1+(e.spans||[]).length;this.recordDroppedEvent("before_send","span",t)}throw new Lt(`${c} returned \`null\`, will not send event.`,"log")}const s=n&&n.getSession();if(!o&&s&&this._updateSessionFromEvent(s,r),o){const e=(r.sdkProcessingMetadata&&r.sdkProcessingMetadata.spanCountBeforeProcessing||0)-(r.spans?r.spans.length:0);e>0&&this.recordDroppedEvent("before_send","span",e)}const i=r.transaction_info;if(o&&i&&r.transaction!==e.transaction){const e="custom";r.transaction_info={...i,source:e}}return this.sendEvent(r,t),r})).then(null,(e=>{if(e instanceof Lt)throw e;throw this.captureException(e,{data:{__sentry__:!0},originalException:e}),new Lt(`Event processing pipeline threw an error, original event will not be sent. Details have been sent as a new event.\nReason: ${e}`)}))}_process(e){this._numProcessing++,e.then((e=>(this._numProcessing--,e)),(e=>(this._numProcessing--,e)))}_clearOutcomes(){const e=this._outcomes;return this._outcomes={},Object.entries(e).map((([e,t])=>{const[n,r]=e.split(":");return{reason:n,category:r,quantity:t}}))}_flushOutcomes(){d&&_.log("Flushing outcomes...");const e=this._clearOutcomes();if(0===e.length)return void(d&&_.log("No outcomes to send"));if(!this._dsn)return void(d&&_.log("No dsn provided, will not send outcomes"));d&&_.log("Sending outcomes:",e);const t=(n=e,at((r=this._options.tunnel&&tt(this._dsn))?{dsn:r}:{},[[{type:"client_report"},{timestamp:s||le(),discarded_events:n}]]));var n,r,s;this.sendEnvelope(t)}}function en(e){return void 0===e.type}function tn(e){return"transaction"===e.type}const nn="undefined"==typeof __SENTRY_DEBUG__||__SENTRY_DEBUG__;function rn(e,t){const n=an(e,t),r={type:ln(t),value:dn(t)};return n.length&&(r.stacktrace={frames:n}),void 0===r.type&&""===r.value&&(r.value="Unrecoverable error caught"),r}function sn(e,t,n,r){const s=Ne(),o=s&&s.getOptions().normalizeDepth,i=function(e){for(const t in e)if(Object.prototype.hasOwnProperty.call(e,t)){const n=e[t];if(n instanceof Error)return n}return}(t),a={__serialized__:ot(t,o)};if(i)return{exception:{values:[rn(e,i)]},extra:a};const c={exception:{values:[{type:C(t)?t.constructor.name:r?"UnhandledRejection":"Error",value:mn(t,{isUnhandledRejection:r})}]},extra:a};if(n){const t=an(e,n);t.length&&(c.exception.values[0].stacktrace={frames:t})}return c}function on(e,t){return{exception:{values:[rn(e,t)]}}}function an(e,t){const n=t.stacktrace||t.stack||"",r=function(e){if(e&&cn.test(e.message))return 1;return 0}(t),s=function(e){if("number"==typeof e.framesToPop)return e.framesToPop;return 0}(t);try{return e(n,r,s)}catch(e){}return[]}const cn=/Minified React error #\d+;/i;function un(e){return"undefined"!=typeof WebAssembly&&void 0!==WebAssembly.Exception&&e instanceof WebAssembly.Exception}function ln(e){const t=e&&e.name;if(!t&&un(e)){return e.message&&Array.isArray(e.message)&&2==e.message.length?e.message[0]:"WebAssembly.Exception"}return t}function dn(e){const t=e&&e.message;return t?t.error&&"string"==typeof t.error.message?t.error.message:un(e)&&Array.isArray(e.message)&&2==e.message.length?e.message[1]:t:"No error message"}function hn(e,t,n,r,s){let o;if(S(t)&&t.error){return on(e,t.error)}if(P(t)||T(t,"DOMException")){const s=t;if("stack"in t)o=on(e,t);else{const t=s.name||(P(s)?"DOMError":"DOMException"),i=s.message?`${t}: ${s.message}`:t;o=pn(e,i,n,r),ne(o,i)}return"code"in s&&(o.tags={...o.tags,"DOMException.code":`${s.code}`}),o}if(I(t))return on(e,t);if(R(t)||C(t)){return o=sn(e,t,n,s),re(o,{synthetic:!0}),o}return o=pn(e,t,n,r),ne(o,`${t}`,void 0),re(o,{synthetic:!0}),o}function pn(e,t,n,r){const s={};if(r&&n){const r=an(e,n);r.length&&(s.exception={values:[{value:t,stacktrace:{frames:r}}]}),re(s,{synthetic:!0})}if(A(t)){const{__sentry_template_string__:e,__sentry_template_values__:n}=t;return s.logentry={message:e,params:n},s}return s.message=t,s}function mn(e,{isUnhandledRejection:t}){const n=function(e,t=40){const n=Object.keys(V(e));n.sort();const r=n[0];if(!r)return"[object has no keys]";if(r.length>=t)return U(r,t);for(let e=n.length;e>0;e--){const r=n.slice(0,e).join(", ");if(!(r.length>t))return e===n.length?r:U(r,t)}return""}(e),r=t?"promise rejection":"exception";if(S(e))return`Event \`ErrorEvent\` captured as ${r} with message \`${e.message}\``;if(C(e)){return`Event \`${function(e){try{const t=Object.getPrototypeOf(e);return t?t.constructor.name:void 0}catch(e){}}(e)}\` (type=${e.type}) captured as ${r}`}return`Object captured as ${r} with keys: ${n}`}function fn(e,t){return Oe().captureEvent(e,t)}function gn(e){const t=Ne(),n=Ae(),r=Oe(),{release:s,environment:o=bt}=t&&t.getOptions()||{},{userAgent:i}=m.navigator||{},a=pe({release:s,environment:o,user:r.getUser()||n.getUser(),...i&&{userAgent:i},...e}),c=n.getSession();return c&&"ok"===c.status&&me(c,{status:"exited"}),bn(),n.setSession(a),r.setSession(a),a}function bn(){const e=Ae(),t=Oe(),n=t.getSession()||e.getSession();n&&function(e,t){let n={};t?n={status:t}:"ok"===e.status&&(n={status:"exited"}),me(e,n)}(n),yn(),e.setSession(),t.setSession()}function yn(){const e=Ae(),t=Oe(),n=Ne(),r=t.getSession()||e.getSession();r&&n&&n.captureSession(r)}function _n(e=!1){e?bn():yn()}const wn=m;let vn=0;function kn(){return vn>0}function En(e,t={}){if(!function(e){return"function"==typeof e}(e))return e;try{const t=e.__sentry_wrapped__;if(t)return"function"==typeof t?t:e;if(K(e))return e}catch(t){return e}const n=function(...n){try{const r=n.map((e=>En(e,t)));return e.apply(this,r)}catch(e){throw vn++,setTimeout((()=>{vn--})),function(...e){const t=Pe(ce());if(2===e.length){const[n,r]=e;return n?t.withSetScope(n,r):t.withScope(r)}t.withScope(e[0])}((r=>{var s,o;r.addEventProcessor((e=>(t.mechanism&&(ne(e,void 0,void 0),re(e,t.mechanism)),e.extra={...e.extra,arguments:n},e))),s=e,Oe().captureException(s,Qt(o))})),e}};try{for(const t in e)Object.prototype.hasOwnProperty.call(e,t)&&(n[t]=e[t])}catch(e){}W(n,e),Y(e,"__sentry_wrapped__",n);try{Object.getOwnPropertyDescriptor(n,"name").configurable&&Object.defineProperty(n,"name",{get:()=>e.name})}catch(e){}return n}class xn extends Zt{constructor(e){const t={parentSpanIsAlwaysRootSpan:!0,...e};!function(e,t,n=[t],r="npm"){const s=e._metadata||{};s.sdk||(s.sdk={name:`sentry.javascript.${t}`,packages:n.map((e=>({name:`${r}:@sentry/${e}`,version:p}))),version:p}),e._metadata=s}(t,"browser",["browser"],wn.SENTRY_SDK_SOURCE||"npm"),super(t),t.sendClientReports&&wn.document&&wn.document.addEventListener("visibilitychange",(()=>{"hidden"===wn.document.visibilityState&&this._flushOutcomes()}))}eventFromException(e,t){return function(e,t,n,r){const s=hn(e,t,n&&n.syntheticException||void 0,r);return re(s),s.level="error",n&&n.event_id&&(s.event_id=n.event_id),jt(s)}(this._options.stackParser,e,t,this._options.attachStacktrace)}eventFromMessage(e,t="info",n){return function(e,t,n="info",r,s){const o=pn(e,t,r&&r.syntheticException||void 0,s);return o.level=n,r&&r.event_id&&(o.event_id=r.event_id),jt(o)}(this._options.stackParser,e,t,n,this._options.attachStacktrace)}captureUserFeedback(e){if(!this._isEnabled())return void(nn&&_.warn("SDK not enabled, will not capture user feedback."));const t=function(e,{metadata:t,tunnel:n,dsn:r}){const s={event_id:e.event_id,sent_at:(new Date).toISOString(),...t&&t.sdk&&{sdk:{name:t.sdk.name,version:t.sdk.version}},...!!n&&!!r&&{dsn:tt(r)}},o=function(e){return[{type:"user_report"},e]}(e);return at(s,[o])}(e,{metadata:this.getSdkMetadata(),dsn:this.getDsn(),tunnel:this.getOptions().tunnel});this.sendEnvelope(t)}_prepareEvent(e,t,n){return e.platform=e.platform||"javascript",super._prepareEvent(e,t,n)}}const In={},Tn={};function Sn(e,t){In[e]=In[e]||[],In[e].push(t)}function Pn(e,t){if(!Tn[e]){Tn[e]=!0;try{t()}catch(t){h&&_.error(`Error while instrumenting ${e}`,t)}}}function On(e,t){const n=e&&In[e];if(n)for(const r of n)try{r(t)}catch(t){h&&_.error(`Error while triggering instrumentation handler.\nType: ${e}\nName: ${Fe(r)}\nError:`,t)}}const An=m;let Nn,Rn,Cn;function $n(){if(!An.document)return;const e=On.bind(null,"dom"),t=qn(e,!0);An.document.addEventListener("click",t,!1),An.document.addEventListener("keypress",t,!1),["EventTarget","Node"].forEach((t=>{const n=An[t],r=n&&n.prototype;r&&r.hasOwnProperty&&r.hasOwnProperty("addEventListener")&&(z(r,"addEventListener",(function(t){return function(n,r,s){if("click"===n||"keypress"==n)try{const r=this.__sentry_instrumentation_handlers__=this.__sentry_instrumentation_handlers__||{},o=r[n]=r[n]||{refCount:0};if(!o.handler){const r=qn(e);o.handler=r,t.call(this,n,r,s)}o.refCount++}catch(e){}return t.call(this,n,r,s)}})),z(r,"removeEventListener",(function(e){return function(t,n,r){if("click"===t||"keypress"==t)try{const n=this.__sentry_instrumentation_handlers__||{},s=n[t];s&&(s.refCount--,s.refCount<=0&&(e.call(this,t,s.handler,r),s.handler=void 0,delete n[t]),0===Object.keys(n).length&&delete this.__sentry_instrumentation_handlers__)}catch(e){}return e.call(this,t,n,r)}})))}))}function qn(e,t=!1){return n=>{if(!n||n._sentryCaptured)return;const r=function(e){try{return e.target}catch(e){return null}}(n);if(function(e,t){return"keypress"===e&&(!t||!t.tagName||"INPUT"!==t.tagName&&"TEXTAREA"!==t.tagName&&!t.isContentEditable)}(n.type,r))return;Y(n,"_sentryCaptured",!0),r&&!r._sentryId&&Y(r,"_sentryId",Z());const s="keypress"===n.type?"input":n.type;if(!function(e){if(e.type!==Rn)return!1;try{if(!e.target||e.target._sentryId!==Cn)return!1}catch(e){}return!0}(n)){e({event:n,name:s,global:t}),Rn=n.type,Cn=r?r._sentryId:void 0}clearTimeout(Nn),Nn=An.setTimeout((()=>{Cn=void 0,Rn=void 0}),1e3)}}const Ln="__sentry_xhr_v3__";function Mn(){if(!An.XMLHttpRequest)return;const e=XMLHttpRequest.prototype;e.open=new Proxy(e.open,{apply(e,t,n){const r=new Error,s=1e3*de(),o=O(n[0])?n[0].toUpperCase():void 0,i=function(e){if(O(e))return e;try{return e.toString()}catch(e){}return}(n[1]);if(!o||!i)return e.apply(t,n);t[Ln]={method:o,url:i,request_headers:{}},"POST"===o&&i.match(/sentry_key/)&&(t.__sentry_own_request__=!0);const a=()=>{const e=t[Ln];if(e&&4===t.readyState){try{e.status_code=t.status}catch(e){}On("xhr",{endTimestamp:1e3*de(),startTimestamp:s,xhr:t,virtualError:r})}};return"onreadystatechange"in t&&"function"==typeof t.onreadystatechange?t.onreadystatechange=new Proxy(t.onreadystatechange,{apply:(e,t,n)=>(a(),e.apply(t,n))}):t.addEventListener("readystatechange",a),t.setRequestHeader=new Proxy(t.setRequestHeader,{apply(e,t,n){const[r,s]=n,o=t[Ln];return o&&O(r)&&O(s)&&(o.request_headers[r.toLowerCase()]=s),e.apply(t,n)}}),e.apply(t,n)}}),e.send=new Proxy(e.send,{apply(e,t,n){const r=t[Ln];if(!r)return e.apply(t,n);void 0!==n[0]&&(r.body=n[0]);return On("xhr",{startTimestamp:1e3*de(),xhr:t}),e.apply(t,n)}})}const jn=m;let Dn;function Un(e){const t="history";Sn(t,e),Pn(t,Bn)}function Bn(){if(!function(){const e=jn.chrome,t=e&&e.app&&e.app.runtime,n="history"in jn&&!!jn.history.pushState&&!!jn.history.replaceState;return!t&&n}())return;const e=An.onpopstate;function t(e){return function(...t){const n=t.length>2?t[2]:void 0;if(n){const e=Dn,t=String(n);Dn=t;On("history",{from:e,to:t})}return e.apply(this,t)}}An.onpopstate=function(...t){const n=An.location.href,r=Dn;Dn=n;if(On("history",{from:r,to:n}),e)try{return e.apply(this,t)}catch(e){}},z(An.history,"pushState",t),z(An.history,"replaceState",t)}function Fn(){"console"in m&&g.forEach((function(e){e in m.console&&z(m.console,e,(function(t){return b[e]=t,function(...t){On("console",{args:t,level:e});const n=b[e];n&&n.apply(m.console,t)}}))}))}function Hn(e,t=!1){t&&!function(){if("string"==typeof EdgeRuntime)return!0;if(!Je())return!1;if(Qe(Ve.fetch))return!0;let e=!1;const t=Ve.document;if(t&&"function"==typeof t.createElement)try{const n=t.createElement("iframe");n.hidden=!0,t.head.appendChild(n),n.contentWindow&&n.contentWindow.fetch&&(e=Qe(n.contentWindow.fetch)),t.head.removeChild(n)}catch(e){h&&_.warn("Could not create sandbox iframe for pure fetch check, bailing to window.fetch: ",e)}return e}()||z(m,"fetch",(function(t){return function(...n){const r=new Error,{method:s,url:o}=function(e){if(0===e.length)return{method:"GET",url:""};if(2===e.length){const[t,n]=e;return{url:Yn(t),method:zn(n,"method")?String(n.method).toUpperCase():"GET"}}const t=e[0];return{url:Yn(t),method:zn(t,"method")?String(t.method).toUpperCase():"GET"}}(n),i={args:n,fetchData:{method:s,url:o},startTimestamp:1e3*de(),virtualError:r};return e||On("fetch",{...i}),t.apply(m,n).then((async t=>(e?e(t):On("fetch",{...i,endTimestamp:1e3*de(),response:t}),t)),(e=>{throw On("fetch",{...i,endTimestamp:1e3*de(),error:e}),I(e)&&void 0===e.stack&&(e.stack=r.stack,Y(e,"framesToPop",1)),e}))}}))}function zn(e,t){return!!e&&"object"==typeof e&&!!e[t]}function Yn(e){return"string"==typeof e?e:e?zn(e,"url")?e.url:e.toString?e.toString():"":""}const Wn=100;function Kn(e,t){const n=Ne(),r=Ae();if(!n)return;const{beforeBreadcrumb:s=null,maxBreadcrumbs:o=Wn}=n.getOptions();if(o<=0)return;const i={timestamp:le(),...e},a=s?y((()=>s(i,t))):i;null!==a&&(n.emit&&n.emit("beforeAddBreadcrumb",a,t),r.addBreadcrumb(a,o))}function Vn(e){return"warn"===e?"warning":["fatal","error","warning","log","info","debug"].includes(e)?e:"log"}function Jn(e){return void 0===e?void 0:e>=400&&e<500?"warning":e>=500?"error":void 0}function Qn(e){if(!e)return{};const t=e.match(/^(([^:/?#]+):)?(\/\/([^/?#]*))?([^?#]*)(\?([^#]*))?(#(.*))?$/);if(!t)return{};const n=t[6]||"",r=t[8]||"";return{host:t[4],path:t[5],protocol:t[2],search:n,hash:r,relative:t[5]+n+r}}const Gn=1024,Xn=(e={})=>{const t={console:!0,dom:!0,fetch:!0,history:!0,sentry:!0,xhr:!0,...e};return{name:"Breadcrumbs",setup(e){var n;t.console&&function(e){const t="console";Sn(t,e),Pn(t,Fn)}(function(e){return function(t){if(Ne()!==e)return;const n={category:"console",data:{arguments:t.args,logger:"console"},level:Vn(t.level),message:B(t.args," ")};if("assert"===t.level){if(!1!==t.args[0])return;n.message=`Assertion failed: ${B(t.args.slice(1)," ")||"console.assert"}`,n.data.arguments=t.args.slice(1)}Kn(n,{input:t.args,level:t.level})}}(e)),t.dom&&(n=function(e,t){return function(n){if(Ne()!==e)return;let r,s,o="object"==typeof t?t.serializeAttribute:void 0,i="object"==typeof t&&"number"==typeof t.maxStringLength?t.maxStringLength:void 0;i&&i>Gn&&(nn&&_.warn(`\`dom.maxStringLength\` cannot exceed 1024, but a value of ${i} was configured. Sentry will use 1024 instead.`),i=Gn),"string"==typeof o&&(o=[o]);try{const e=n.event,t=function(e){return!!e&&!!e.target}(e)?e.target:e;r=j(t,{keyAttrs:o,maxStringLength:i}),s=function(e){if(!M.HTMLElement)return null;let t=e;for(let e=0;e<5;e++){if(!t)return null;if(t instanceof HTMLElement){if(t.dataset.sentryComponent)return t.dataset.sentryComponent;if(t.dataset.sentryElement)return t.dataset.sentryElement}t=t.parentNode}return null}(t)}catch(e){r="<unknown>"}if(0===r.length)return;const a={category:`ui.${n.name}`,message:r};s&&(a.data={"ui.component_name":s}),Kn(a,{event:n.event,name:n.name,global:n.global})}}(e,t.dom),Sn("dom",n),Pn("dom",$n)),t.xhr&&function(e){Sn("xhr",e),Pn("xhr",Mn)}(function(e){return function(t){if(Ne()!==e)return;const{startTimestamp:n,endTimestamp:r}=t,s=t.xhr[Ln];if(!n||!r||!s)return;const{method:o,url:i,status_code:a,body:c}=s,u={method:o,url:i,status_code:a},l={xhr:t.xhr,input:c,startTimestamp:n,endTimestamp:r};Kn({category:"xhr",data:u,type:"http",level:Jn(a)},l)}}(e)),t.fetch&&function(e,t){const n="fetch";Sn(n,e),Pn(n,(()=>Hn(void 0,t)))}(function(e){return function(t){if(Ne()!==e)return;const{startTimestamp:n,endTimestamp:r}=t;if(r&&(!t.fetchData.url.match(/sentry_key/)||"POST"!==t.fetchData.method))if(t.error){Kn({category:"fetch",data:t.fetchData,level:"error",type:"http"},{data:t.error,input:t.args,startTimestamp:n,endTimestamp:r})}else{const e=t.response,s={...t.fetchData,status_code:e&&e.status},o={input:t.args,response:e,startTimestamp:n,endTimestamp:r};Kn({category:"fetch",data:s,type:"http",level:Jn(s.status_code)},o)}}}(e)),t.history&&Un(function(e){return function(t){if(Ne()!==e)return;let n=t.from,r=t.to;const s=Qn(wn.location.href);let o=n?Qn(n):void 0;const i=Qn(r);o&&o.path||(o=s),s.protocol===i.protocol&&s.host===i.host&&(r=i.relative),s.protocol===o.protocol&&s.host===o.host&&(n=o.relative),Kn({category:"navigation",data:{from:n,to:r}})}}(e)),t.sentry&&e.on("beforeSendEvent",function(e){return function(t){Ne()===e&&Kn({category:"sentry."+("transaction"===t.type?"transaction":"event"),event_id:t.event_id,level:t.level,message:te(t)},{event:t})}}(e))}}};const Zn=["EventTarget","Window","Node","ApplicationCache","AudioTrackList","BroadcastChannel","ChannelMergerNode","CryptoOperation","EventSource","FileReader","HTMLUnknownElement","IDBDatabase","IDBRequest","IDBTransaction","KeyOperation","MediaController","MessagePort","ModalWindow","Notification","SVGElementInstance","Screen","SharedWorker","TextTrack","TextTrackCue","TextTrackList","WebSocket","WebSocketWorker","Worker","XMLHttpRequest","XMLHttpRequestEventTarget","XMLHttpRequestUpload"],er=(e={})=>{const t={XMLHttpRequest:!0,eventTarget:!0,requestAnimationFrame:!0,setInterval:!0,setTimeout:!0,...e};return{name:"BrowserApiErrors",setupOnce(){t.setTimeout&&z(wn,"setTimeout",tr),t.setInterval&&z(wn,"setInterval",tr),t.requestAnimationFrame&&z(wn,"requestAnimationFrame",nr),t.XMLHttpRequest&&"XMLHttpRequest"in wn&&z(XMLHttpRequest.prototype,"send",rr);const e=t.eventTarget;if(e){(Array.isArray(e)?e:Zn).forEach(sr)}}}};function tr(e){return function(...t){const n=t[0];return t[0]=En(n,{mechanism:{data:{function:Fe(e)},handled:!1,type:"instrument"}}),e.apply(this,t)}}function nr(e){return function(t){return e.apply(this,[En(t,{mechanism:{data:{function:"requestAnimationFrame",handler:Fe(e)},handled:!1,type:"instrument"}})])}}function rr(e){return function(...t){const n=this;return["onload","onerror","onprogress","onreadystatechange"].forEach((e=>{e in n&&"function"==typeof n[e]&&z(n,e,(function(t){const n={mechanism:{data:{function:e,handler:Fe(t)},handled:!1,type:"instrument"}},r=K(t);return r&&(n.mechanism.data.handler=Fe(r)),En(t,n)}))})),e.apply(this,t)}}function sr(e){const t=wn[e],n=t&&t.prototype;n&&n.hasOwnProperty&&n.hasOwnProperty("addEventListener")&&(z(n,"addEventListener",(function(t){return function(n,r,s){try{"function"==typeof r.handleEvent&&(r.handleEvent=En(r.handleEvent,{mechanism:{data:{function:"handleEvent",handler:Fe(r),target:e},handled:!1,type:"instrument"}}))}catch(e){}return t.apply(this,[n,En(r,{mechanism:{data:{function:"addEventListener",handler:Fe(r),target:e},handled:!1,type:"instrument"}}),s])}})),z(n,"removeEventListener",(function(e){return function(t,n,r){try{const s=n.__sentry_wrapped__;s&&e.call(this,t,s,r)}catch(e){}return e.call(this,t,n,r)}})))}const or=()=>({name:"BrowserSession",setupOnce(){void 0!==wn.document?(gn({ignoreDuration:!0}),_n(),Un((({from:e,to:t})=>{void 0!==e&&e!==t&&(gn({ignoreDuration:!0}),_n())}))):nn&&_.warn("Using the `browserSessionIntegration` in non-browser environments is not supported.")}});let ir=null;function ar(){ir=m.onerror,m.onerror=function(e,t,n,r,s){return On("error",{column:r,error:s,line:n,msg:e,url:t}),!!ir&&ir.apply(this,arguments)},m.onerror.__SENTRY_INSTRUMENTED__=!0}let cr=null;function ur(){cr=m.onunhandledrejection,m.onunhandledrejection=function(e){return On("unhandledrejection",e),!cr||cr.apply(this,arguments)},m.onunhandledrejection.__SENTRY_INSTRUMENTED__=!0}const lr=(e={})=>{const t={onerror:!0,onunhandledrejection:!0,...e};return{name:"GlobalHandlers",setupOnce(){Error.stackTraceLimit=50},setup(e){t.onerror&&(!function(e){!function(e){const t="error";Sn(t,e),Pn(t,ar)}((t=>{const{stackParser:n,attachStacktrace:r}=hr();if(Ne()!==e||kn())return;const{msg:s,url:o,line:i,column:a,error:c}=t,u=function(e,t,n,r){const s=e.exception=e.exception||{},o=s.values=s.values||[],i=o[0]=o[0]||{},a=i.stacktrace=i.stacktrace||{},c=a.frames=a.frames||[],u=r,l=n,d=O(t)&&t.length>0?t:function(){try{return M.document.location.href}catch(e){return""}}();0===c.length&&c.push({colno:u,filename:d,function:Le,in_app:!0,lineno:l});return e}(hn(n,c||s,void 0,r,!1),o,i,a);u.level="error",fn(u,{originalException:c,mechanism:{handled:!1,type:"onerror"}})}))}(e),dr("onerror")),t.onunhandledrejection&&(!function(e){!function(e){const t="unhandledrejection";Sn(t,e),Pn(t,ur)}((t=>{const{stackParser:n,attachStacktrace:r}=hr();if(Ne()!==e||kn())return;const s=function(e){if(N(e))return e;try{if("reason"in e)return e.reason;if("detail"in e&&"reason"in e.detail)return e.detail.reason}catch(e){}return e}(t),o=N(s)?{exception:{values:[{type:"UnhandledRejection",value:`Non-Error promise rejection captured with value: ${String(s)}`}]}}:hn(n,s,void 0,r,!0);o.level="error",fn(o,{originalException:s,mechanism:{handled:!1,type:"onunhandledrejection"}})}))}(e),dr("onunhandledrejection"))}}};function dr(e){nn&&_.log(`Global Handler attached: ${e}`)}function hr(){const e=Ne();return e&&e.getOptions()||{stackParser:()=>[],attachStacktrace:!1}}const pr=()=>({name:"HttpContext",preprocessEvent(e){if(!wn.navigator&&!wn.location&&!wn.document)return;const t=e.request&&e.request.url||wn.location&&wn.location.href,{referrer:n}=wn.document||{},{userAgent:r}=wn.navigator||{},s={...e.request&&e.request.headers,...n&&{Referer:n},...r&&{"User-Agent":r}},o={...e.request,...t&&{url:t},headers:s};e.request=o}});function mr(e,t,n=250,r,s,o,i){if(!(o.exception&&o.exception.values&&i&&q(i.originalException,Error)))return;const a=o.exception.values.length>0?o.exception.values[o.exception.values.length-1]:void 0;var c,u;a&&(o.exception.values=(c=fr(e,t,s,i.originalException,r,o.exception.values,a,0),u=n,c.map((e=>(e.value&&(e.value=U(e.value,u)),e)))))}function fr(e,t,n,r,s,o,i,a){if(o.length>=n+1)return o;let c=[...o];if(q(r[s],Error)){gr(i,a);const o=e(t,r[s]),u=c.length;br(o,s,u,a),c=fr(e,t,n,r[s],s,[o,...c],o,u)}return Array.isArray(r.errors)&&r.errors.forEach(((r,o)=>{if(q(r,Error)){gr(i,a);const u=e(t,r),l=c.length;br(u,`errors[${o}]`,l,a),c=fr(e,t,n,r,s,[u,...c],u,l)}})),c}function gr(e,t){e.mechanism=e.mechanism||{type:"generic",handled:!0},e.mechanism={...e.mechanism,..."AggregateError"===e.type&&{is_exception_group:!0},exception_id:t}}function br(e,t,n,r){e.mechanism=e.mechanism||{type:"generic",handled:!0},e.mechanism={...e.mechanism,type:"chained",source:t,exception_id:n,parent_id:r}}const yr=(e={})=>{const t=e.limit||5,n=e.key||"cause";return{name:"LinkedErrors",preprocessEvent(e,r,s){const o=s.getOptions();mr(rn,o.stackParser,o.maxValueLength,n,t,e,r)}}};function _r(e,t,n,r){const s={filename:e,function:"<anonymous>"===t?Le:t,in_app:!0};return void 0!==n&&(s.lineno=n),void 0!==r&&(s.colno=r),s}const wr=/^\s*at (\S+?)(?::(\d+))(?::(\d+))\s*$/i,vr=/^\s*at (?:(.+?\)(?: \[.+\])?|.*?) ?\((?:address at )?)?(?:async )?((?:<anonymous>|[-a-z]+:|.*bundle|\/)?.*?)(?::(\d+))?(?::(\d+))?\)?\s*$/i,kr=/\((\S*)(?::(\d+))(?::(\d+))\)/,Er=/^\s*(.*?)(?:\((.*?)\))?(?:^|@)?((?:[-a-z]+)?:\/.*?|\[native code\]|[^@]*(?:bundle|\d+\.js)|\/[\w\-. /=]+)(?::(\d+))?(?::(\d+))?\s*$/i,xr=/(\S+) line (\d+)(?: > eval line \d+)* > eval/i,Ir=De(...[[30,e=>{const t=wr.exec(e);if(t){const[,e,n,r]=t;return _r(e,Le,+n,+r)}const n=vr.exec(e);if(n){if(n[2]&&0===n[2].indexOf("eval")){const e=kr.exec(n[2]);e&&(n[2]=e[1],n[3]=e[2],n[4]=e[3])}const[e,t]=Tr(n[1]||Le,n[2]);return _r(t,e,n[3]?+n[3]:void 0,n[4]?+n[4]:void 0)}}],[50,e=>{const t=Er.exec(e);if(t){if(t[3]&&t[3].indexOf(" > eval")>-1){const e=xr.exec(t[3]);e&&(t[1]=t[1]||"eval",t[3]=e[1],t[4]=e[2],t[5]="")}let e=t[3],n=t[1]||Le;return[n,e]=Tr(n,e),_r(e,n,t[4]?+t[4]:void 0,t[5]?+t[5]:void 0)}}]]),Tr=(e,t)=>{const n=-1!==e.indexOf("safari-extension"),r=-1!==e.indexOf("safari-web-extension");return n||r?[-1!==e.indexOf("@")?e.split("@")[0]:Le,n?`safari-extension:${t}`:`safari-web-extension:${t}`]:[e,t]},Sr="undefined"==typeof __SENTRY_DEBUG__||__SENTRY_DEBUG__,Pr={};function Or(e){const t=Pr[e];if(t)return t;let n=An[e];if(Qe(n))return Pr[e]=n.bind(An);const r=An.document;if(r&&"function"==typeof r.createElement)try{const t=r.createElement("iframe");t.hidden=!0,r.head.appendChild(t);const s=t.contentWindow;s&&s[e]&&(n=s[e]),r.head.removeChild(t)}catch(t){Sr&&_.warn(`Could not create sandbox iframe for ${e} check, bailing to window.${e}: `,t)}return n?Pr[e]=n.bind(An):n}function Ar(e){Pr[e]=void 0}function Nr(e){const t=[];function n(e){return t.splice(t.indexOf(e),1)[0]||Promise.resolve(void 0)}return{$:t,add:function(r){if(!(void 0===e||t.length<e))return Dt(new Lt("Not adding Promise because buffer limit was reached."));const s=r();return-1===t.indexOf(s)&&t.push(s),s.then((()=>n(s))).then(null,(()=>n(s).then(null,(()=>{})))),s},drain:function(e){return new Ut(((n,r)=>{let s=t.length;if(!s)return n(!0);const o=setTimeout((()=>{e&&e>0&&n(!1)}),e);t.forEach((e=>{jt(e).then((()=>{--s||(clearTimeout(o),n(!0))}),r)}))}))}}}function Rr(e,{statusCode:t,headers:n},r=Date.now()){const s={...e},o=n&&n["x-sentry-rate-limits"],i=n&&n["retry-after"];if(o)for(const e of o.trim().split(",")){const[t,n,,,o]=e.split(":",5),i=parseInt(t,10),a=1e3*(isNaN(i)?60:i);if(n)for(const e of n.split(";"))"metric_bucket"===e&&o&&!o.split(";").includes("custom")||(s[e]=r+a);else s.all=r+a}else i?s.all=r+function(e,t=Date.now()){const n=parseInt(`${e}`,10);if(!isNaN(n))return 1e3*n;const r=Date.parse(`${e}`);return isNaN(r)?6e4:r-t}(i,r):429===t&&(s.all=r+6e4);return s}function Cr(e,t,n=Nr(e.bufferSize||64)){let r={};return{send:function(s){const o=[];if(ut(s,((t,n)=>{const s=mt(n);if(function(e,t,n=Date.now()){return function(e,t){return e[t]||e.all||0}(e,t)>n}(r,s)){const r=$r(t,n);e.recordDroppedEvent("ratelimit_backoff",s,r)}else o.push(t)})),0===o.length)return jt({});const i=at(s[0],o),a=t=>{ut(i,((n,r)=>{const s=$r(n,r);e.recordDroppedEvent(t,mt(r),s)}))};return n.add((()=>t({body:dt(i)}).then((e=>(void 0!==e.statusCode&&(e.statusCode<200||e.statusCode>=300)&&d&&_.warn(`Sentry responded with status code ${e.statusCode} to sent event.`),r=Rr(r,e),e)),(e=>{throw a("network_error"),e})))).then((e=>e),(e=>{if(e instanceof Lt)return d&&_.error("Skipped sending event because buffer is full."),a("queue_overflow"),jt({});throw e}))},flush:e=>n.drain(e)}}function $r(e,t){if("event"===t||"transaction"===t)return Array.isArray(e)?e[1]:void 0}function qr(e,t=Or("fetch")){let n=0,r=0;return Cr(e,(function(s){const o=s.body.length;n+=o,r++;const i={body:s.body,method:"POST",referrerPolicy:"origin",headers:e.headers,keepalive:n<=6e4&&r<15,...e.fetchOptions};if(!t)return Ar("fetch"),Dt("No fetch implementation available");try{return t(e.url,i).then((e=>(n-=o,r--,{statusCode:e.status,headers:{"x-sentry-rate-limits":e.headers.get("X-Sentry-Rate-Limits"),"retry-after":e.headers.get("Retry-After")}})))}catch(e){return Ar("fetch"),n-=o,r--,Dt(e)}}))}function Lr(e){const t=[ie(),qe(),er(),Xn(),lr(),yr(),ze(),pr()];return!1!==e.autoSessionTracking&&t.push(or()),t}function Mr(e={}){const t=function(e={}){const t={defaultIntegrations:Lr(e),release:"string"==typeof __SENTRY_RELEASE__?__SENTRY_RELEASE__:wn.SENTRY_RELEASE&&wn.SENTRY_RELEASE.id?wn.SENTRY_RELEASE.id:void 0,autoSessionTracking:!0,sendClientReports:!0};return null==e.defaultIntegrations&&delete e.defaultIntegrations,{...t,...e}}(e);if(!t.skipBrowserExtensionCheck&&function(){const e=void 0!==wn.window&&wn;if(!e)return!1;const t=e[e.chrome?"chrome":"browser"],n=t&&t.runtime&&t.runtime.id,r=wn.location&&wn.location.href||"",s=!!n&&wn===wn.top&&["chrome-extension:","moz-extension:","ms-browser-extension:","safari-web-extension:"].some((e=>r.startsWith(`${e}//`))),o=void 0!==e.nw;return!!n&&!s&&!o}())return void y((()=>{}));nn&&(Je()||_.warn("No Fetch API detected. The Sentry SDK requires a Fetch API compatible environment to send events. Please add a Fetch API polyfill."));const n={...t,stackParser:(r=t.stackParser||Ir,Array.isArray(r)?De(...r):r),integrations:v(t),transport:t.transport||qr};var r;return Ge(xn,n)}const jr={},Dr={};let Ur=!1;const Br=chrome.runtime.getManifest().version,Fr="https://api.browser.civai.co";let Hr=!1,zr=null,Yr=null,Wr=null,Kr=null,Vr=null,Jr=!1,Qr=[],Gr=[],Xr=[],Zr=!1,es=!0,ts=!1,ns={},rs=null,ss=null,os=!1,is=function(){let e=function(e){let t=5381;for(let n=0;n<e.length;n++)t=33*t^e.charCodeAt(n);return t>>>0}(Br);return(0,r.XO)("stateId",e),e}(),as=null,cs=[],us=[];const ls=["bulk_input"],ds={sendTts:{interval:100,lastRequest:0,pending:!1},novaOpenWeb:{interval:10,lastRequest:0,pending:!1},novaCurrentTab:{interval:10,lastRequest:0,pending:!1},captureTab:{interval:10,lastRequest:0,pending:!1},sendQuestion:{interval:100,lastRequest:0,pending:!1},sendAudio:{interval:100,lastRequest:0,pending:!1}};function hs(e){return new Promise((async(t,n)=>{try{const n=await(0,r.bQ)("novaWebRequest");if(n){const r=Date.now(),s=n.timestamp,o=r-s;if(e.instructionId===n.instructionId)return void t({status:"duplicate",tab_id:Kr});if(o<2e4||s===r)return n.requestPrompt===e.prompt?void t({status:"duplicate",tab_id:Kr}):void t({status:"new"});t({status:"new"})}else t({status:"new"})}catch(e){n(e)}}))}function ps(e){const t=Date.now(),n=ds[e];if(!n)return!1;const r=t-n.lastRequest;if(r<n.interval||n.pending){if(r<n.interval){Math.ceil((n.interval-r)/100)}return!0}return n.pending=!0,n.lastRequest=t,setTimeout((()=>{n.pending=!1}),n.interval),!1}function ms(e){return new Promise((async(t,n)=>{try{const n=await new Promise(((e,t)=>{chrome.tabs.query({},(n=>{if(chrome.runtime.lastError)t(chrome.runtime.lastError);else{const t=n.map((e=>({id:e.id,title:e.title,url:e.url})));e(t)}}))})),s={tabs:n,instruction:e.prompt};let o=await(0,r.bQ)("bgptLicenseKey");const i=await fetch(`${Fr}/navigate_tab`,{method:"POST",headers:{"Content-Type":"application/json","bgpt-license-key":o},body:JSON.stringify(s)}),a=await i.json();"success"===a.status&&a.tab_id?t(a.tab_id):t(!1)}catch(e){t(!1)}}))}async function fs(e,t,n){await eo(t.tab.id,e.bgptIndex,!1),rs=Date.now(),Us(rs),Gr.length=0,Qr.length=0,Xr.length=0,cs.length=0,us.length=0,e.enable_realtime_mode&&(Ur=!0),ss=e.apikey;const s=await(0,r.bQ)("bgptLicenseKey");var o;ns[rs]={tabId:n,mainTabId:t.tab.id,prompt:e.prompt||e.action||"",enable_realtime_mode:e.enable_realtime_mode||!1,directExecution:e.directExecution||!1,notifiedStopProcessing:!1,enforceUserConfirmation:e.enforceUserConfirmation||!1,bgptIndex:e.bgptIndex||!1,apiKey:s,aborted:!1},t.tab&&t.tab.id&&(zr=t.tab.id,e.novaUrl&&(Yr=e.novaUrl,Yr&&(o=Yr,new Promise(((e,t)=>{chrome.tabs.query({},(t=>{for(const n of t)if(n.url===o)return void e(n.id);e(!1)}))}))).then((e=>{Kr=e||zr})).catch((e=>{Kr=zr}))),Dr[zr]=!1,Dr[zr]=e.bgptIndex||!1),(0,r.Hr)(e.prompt)}async function gs(e,t,n,s=!1){await fs(t,n,e);let o=rs;e&&(jr[e]=t.prompt,s&&(Wr=e));Date.now();let i="Lets see what we have here...";t.enable_realtime_mode&&(i="Currently navigating to the page to execute your request..."),await(0,r.FN)(e)?Cs(n.tab.id,"info_message",i,o).then((()=>{bs(e,2e3,o).then((()=>(chrome.tabs.sendMessage(e,{...t,action:"takeScreenshot",stateId:is,requestId:o}).then((t=>chrome.runtime.lastError?(Cs(e,"failed_task","Error occurred while taking screenshot, should i try again?",o),!1):"error"!==t.status||(Cs(e,"failed_task",t.error,o,!1,!1),!1))).catch((e=>!1)),!0))).catch((r=>{r.message.includes("maximum")?(Cs(n.tab.id,"failed_task","Exceeded maximum waiting time for page to finish loading, should i try again?",o),chrome.tabs.sendMessage(e,{action:"takeScreenshot",...t,stateId:is})):Cs(n.tab.id,"failed_task","Error occurred while waiting for page to finish loading, should i try again?",o)}))})):Cs(n.tab.id,"failed_task","Error occured while attempting your request labelled: "+t.prompt+", should i try again?",o)}function bs(e,t,n=rs){let r=!1,s="Waiting for page to finish loading...";return new Promise(((o,i)=>{let a=0,c=null;Date.now();let u=setTimeout((()=>{m(),clearTimeout(c),o()}),1e4);function l(e){if("xmlhttprequest"!==e.type)return!1;if(!e.responseHeaders)return!1;const t=e.responseHeaders.find((e=>"content-type"===e.name.toLowerCase()));if(!t)return!1;return["video/mp4","video/webm","video/ogg","application/x-mpegURL"].some((e=>t.value.includes(e)))}const d=()=>{clearTimeout(c),Ds(n,"waitForNetworkIdle").then((e=>{if(!e)return clearTimeout(c),clearTimeout(u),m(),i(new Error("outdated request id detected!")),!1})).catch((e=>{clearTimeout(c),clearTimeout(u),m(),i(e)})),c=setTimeout((()=>{m(),clearTimeout(u),o()}),t)},h=t=>{n!==rs?i(new Error("outdated request id detected!")):t.tabId!==e||l(t)||(c&&clearTimeout(c),a++,a>10&&!r&&(Cs(e,"info_message",s,n,!1,!1),r=!0),a<2&&r&&(r=!1,s="Still Waiting for page to finish loading..."))},p=t=>{t.tabId!==e||l(t)||(a>0&&a--,0===a&&d())};function m(){chrome.webRequest.onBeforeRequest.removeListener(h),chrome.webRequest.onCompleted.removeListener(p),chrome.webRequest.onErrorOccurred.removeListener(p)}d(),chrome.webRequest.onBeforeRequest.addListener(h,{urls:["<all_urls>"],types:["sub_frame","stylesheet","script","image","font","object","xmlhttprequest","media","websocket","other"]}),chrome.webRequest.onCompleted.addListener(p,{urls:["<all_urls>"],types:["sub_frame","stylesheet","script","image","font","object","xmlhttprequest","media","websocket","other"]}),chrome.webRequest.onErrorOccurred.addListener(p,{urls:["<all_urls>"],types:["sub_frame","stylesheet","script","image","font","object","xmlhttprequest","media","websocket","other"]})}))}function ys(e=null,t=null,n=null){null==e&&(e=cs),null==t&&(t=us),null==n&&(n=Xr);let r="Task Report:\n";return e.length>0?(r+="\nSuccessful Tasks:\n",e.forEach(((e,t)=>{r+=`- Task ${t+1}: ${e}\n`}))):r+="\nNo successful tasks.\n",t.length>0?(r+="\nFailed Tasks:\n",t.forEach(((e,t)=>{const{taskName:n,reason:s}=e;r+=`- Task ${t+1}: ${n} | Reason: ${s}\n`}))):r+="\nNo failed tasks.\n",n&&n.length>0?(r+="\nUnattempted Tasks:\n",n.forEach(((e,t)=>{r+=`- Task ${t+1}: ${e.task_name} | Action: ${e.action}\n`}))):r+="\nNo unattempted tasks.\n",r}async function _s(e,t="click"){try{const n=await chrome.tabs.sendMessage(e,{action:"annotateElements",show:!0,type:t,stateId:is}),s=await(0,r.VS)(e),o=(n.overlay,n.mapping);await async function(e){try{await(0,r.XO)("annotationMapping",e)}catch(e){}}(o);const i=await(0,r.lz)(e,t);return chrome.tabs.sendMessage(e,{action:"annotateElements",show:!1,type:t,stateId:is}),{elements:i,screenshot:s}}catch(t){throw await chrome.tabs.sendMessage(e,{action:"annotateElements",show:!1,stateId:is}),t}}async function ws(e,t,n,s){if(ns[s].aborted)return Promise.reject(new Error("outdated request id detected"));if(Xs(ns[s].tabId,!0,s),"success"!==t.status||"task_list"!==t.action)return Promise.reject(new Error("Invalid task data or action"));if(0==t.tasks.length)return Promise.reject(new Error("nofurtheractions"));if(!await Ds(s,"processTasks"))return Promise.reject(new Error("outdated request id detected! in waitForUserConfirmation"));let o=t.tasks.map((e=>e.task_name)).join(", ");to(ns[s].tabId,`I will ${o}`,"checkmark","do_nothing");const i=t.tasks;let a=1e3,c=["summarize","narrate","analyze","ask_question","ask_for_user_input","converse","break","speak_to_user","reload_page","enter_key","back_button","scroll_up","scroll_down","open_url","switch_to_tab","scroll_to_nearest_input_field","wait_for_5_seconds","wait_for_20_seconds"];async function u(e,t=0,o=!1){let l=null,d=null;const h=i[e];let p=["scroll_to_element"];p.includes(h.action)&&(o=!1);try{if(!o&&!ls.includes(h.action)||p.includes(h.action))d=await(0,r.VS)(ns[s].tabId),l=await(0,r.lz)(ns[s].tabId,h.action),await m();else{const f=await _s(ns[s].tabId,h.action);l=f.elements,d=f.screenshot,await m()}async function m(){if(to(ns[s].tabId,`I am attempting to perform the ${h.action} action`,"checkmark","do_nothing"),c.includes(h.action)){let e={taskName:h.task_name,action:h.action,clickable_element:l,objective:n,status:"success",reason:"success"};const t=await ks(e,ns[s].tabId,s);let r=`${h.task_name}\nTask Result: performed a ${h.action} successfully with feedback:\n${t}`;ns[s].enable_realtime_mode&&Cs(ns[s].tabId,"info_message",`BrowserGPT has performed the ${h.action} action successfully`,s,!1),Qr.push(r),cs.push(r),await new Promise((e=>setTimeout(e,a)))}else{if(!l||!d){if(o){const e=await _s(ns[s].tabId,h.action);l=e.elements,d=e.screenshot}else{await(0,r.VS)(ns[s].tabId);l=await(0,r.lz)(ns[s].tabId,h.action)}if(t<1)return await new Promise((e=>setTimeout(e,a))),u(e,t+1,!o);throw new Error("No clickable elements found on page now, i recommend you to try again")}await function(e,t,n,r,s,o,i,a=1){const c=t.action,u=t.task_name,l=t.input_data;let d=0;Xs(ns[o].tabId,!0,o);const h=ls.includes(c)||i;return new Promise(((t,i)=>{function p(){d++;let m=setTimeout((()=>{Cs(s,"info_message",`BrowserGPT is attempting to perform the ${c} action on the webpage, please wait...`,o,!1),Xs(s,!0,o)}),ns[o].enable_realtime_mode?1e3:1e4);Qs(u).then((f=>{Ys(ns[o].tabId).then((g=>{fetch(Fr+(h?"/handle_browser_annotated":"/handle_browser"),{method:"POST",headers:{"Content-Type":"application/json","bgpt-license-key":ns[o].apiKey},body:JSON.stringify({image:e,prompt:`taskName: ${u}\n\nRelevant Information:\n${f}`,action:c,current_url:g,input_data:l||null,elements:JSON.stringify(r),performed_tasks:ys(),objective:`Main objective: ${ns[o].prompt}\n\nCurrent Task:${n}`})}).then((e=>(clearTimeout(m),e.json()))).then((e=>{if(("failed"===e.status||void 0===e.status)&&d<a)setTimeout(p,1e3);else if("notfound"===e.status)oo(s,{status:"notfound",action:c,taskName:u,objective:n,clickable_element:null,reason:`Element needed to perform the ${c} action was not found`},o).then((e=>{let n=`${u}\nTask Result: manually performed by user after element not found`;Qr.push(n),cs.push(n),t(e)})).catch((e=>{i(new Error(`Task to ${u} failed because the element needed to perform the ${c} action was not found, please try another element`))}));else{if("failed"!==e.status&&void 0!==e.status||!(d>=a))return e.taskName=u,e.objective=n,ks(e,s,o).then((e=>{let n=`${u}\nTask Result: performed a ${c} successfully with feedback:\n${"object"==typeof e?JSON.stringify(e,null,2):e}`;Qr.push(n),cs.push(n),t(e)})).catch((r=>{Gr.push({taskName:u,reason:r.message}),us.push({taskName:u,reason:r.message}),oo(s,{status:"failed",action:e.action||c,taskName:u,objective:n,clickable_element:e.clickable_element},o).then((e=>{let n=`${u}\nTask Result: manually performed by user`;Qr.push(n),cs.push(n),t(e)})).catch((e=>{i(e)}))}));oo(s,{status:"failed",action:c,taskName:u,objective:n,clickable_element:e.clickable_element,reason:e.reason||"unknown"},o).then((e=>{let n=`${u}\nTask Result: manually performed by user after failure`;Qr.push(n),cs.push(n),t(e)})).catch((t=>{i(new Error(`Task to ${u} failed with reason: ${e.reason||"unknown"} after max attempts`))}))}})).catch((e=>{Xs(s,!0,o),e.message?.includes("Socket disconnected")&&Cs(ns[o].mainTabId,"info_message","Network error occured, during task execution...",o,!1),clearTimeout(m),o!==rs?(ns[o].aborted=!0,i(new Error("outdated request id detected!"))):d<a?setTimeout(p,1e3):oo(s,{status:"failed",action:c,taskName:u,objective:n,clickable_element:null,reason:e.message||"Error during task execution"},o).then((e=>{let n=`${u}\nTask Result: manually performed by user after execution error`;Qr.push(n),cs.push(n),t(e)})).catch((e=>{i(e)}))}))})).catch((e=>{i(e)}))})).catch((e=>{i(e)}))}ns[o].aborted?i(new Error("outdated request id detected")):(Ds(o,"sendToHandleBrowser").then((e=>{e||i(new Error("outdated request id detected!"))})).catch((e=>{i(e)})),p())}))}(d,h,n,l,ns[s].tabId,s,o),await bs(ns[s].tabId,a,s),e===i.length-1&&(a=0),await new Promise((e=>setTimeout(e,a)))}}}catch(g){if(t<1&&"not found"!==g.message&&!g.message.includes("Socket disconnected"))return Gr.push({taskName:h.task_name,reason:g.message}),us.push({taskName:h.task_name,reason:g.message}),d=null,l=null,await new Promise((e=>setTimeout(e,a))),u(e,t+1,!o);if(g.message.includes("outdated request id detected"))throw Gr.push({taskName:h.task_name,reason:g.message}),us.push({taskName:h.task_name,reason:g.message}),g;if(await Cs(ns[s].tabId,"failed_execution",`I ran into an issue while trying to perform the ${h.action} action on the webpage after a few attempts`,s,!1,!1),Gr.push({taskName:h.task_name,reason:g.message}),us.push({taskName:h.task_name,reason:g.message}),g.message.includes("not found")){if(t<1)return u(e,t+1,!o);throw new Error(g.message)}throw new Error(`Max retries reached for task ${e}: ${g.message}`)}}cs=[],us=[];for(let e=0;e<i.length;e++)try{if(!await Ds(s,"executeTask"))throw new Error("outdated request id detected! in executeTask lOOP");if(await u(e),i.length>3&&e>0&&(e+1)%3==0&&e<i.length-1){let t=ys(cs.slice(0,e+1),us);try{await vs(`\n\t\t\t\t\t\tObjective: Verify if the following tasks have been successfully completed so far, based on the current screenshot of the webpage.\n\n\t\t\t\t\t\tThe following tasks were performed in order:\n\n\t\t\t\t\t\t${t}\n\n\t\t\t\t\t\tPlease analyze the screenshot and confirm that the expected results from these tasks are visible.\n\t\t\t\t\t\t`,ns[s].tabId,!1,s)}catch(e){throw new Error("Intermediate task completion check failed")}}}catch(e){const t=[...cs.map((e=>e.split("\n")[0])),...us.map((e=>e.taskName))];return Xr=i.filter((e=>!t.includes(e.task_name))).map((e=>({task_name:e.task_name,action:e.action}))),Promise.reject(new Error("Error in processTasks loop: "+e))}const l=[...cs.map((e=>e.split("\n")[0])),...us.map((e=>e.taskName))];Xr=i.filter((e=>!l.includes(e.task_name))).map((e=>({task_name:e.task_name,action:e.action}))),Xr.length;let d=ys(cs,us);try{return i.length>1&&await vs(`\n            Objective: Verify if all the tasks listed below have been successfully completed, based on the current screenshot of the webpage.\n\n            The following tasks were performed in order:\n\n            ${d}\n\n            Please analyze the screenshot of the current page and confirm that the image indicates the expected results from the executed tasks listed above.\n\n            Note: The task list includes the task names and actions. Ensure the screenshot matches the expected outcome for each task. You should only confirm the task as complete if it is visibly reflected on the page.\n\n            For example:\n\n            On google.com, the following tasks were performed:\n\n            [Task 1]: Input the text "who is elon musk" | Input\n            [Task 2]: Click the button search button | Click\n\n\n            From the above tasks, the screenshot should show the search results for "who is elon musk" on the page.\n\n            `,ns[s].tabId,!1,s),Promise.resolve()}catch(e){return Promise.reject(new Error("Error in checkTaskCompletion for processTasks"))}}async function vs(e,t,n=!0,s=rs,o=2){return new Promise(((i,a)=>{if(ns[s].aborted)return void a(new Error("outdated request id detected"));let c=0;!async function u(){c++;try{const o=await(0,r.VS)(t),c=await fetch(Fr+"/check_browser_task_complete",{method:"POST",headers:{"Content-Type":"application/json","bgpt-license-key":ns[s].apiKey},body:JSON.stringify({image:o,prompt:e})}),u=await c.json();if("false"===u.status)a();else if("true"===u.status){let e=ns[s].prompt;1==n?(await Ms(e,t,n,o,s),i()):i()}else a(new Error("Task completion check failed"))}catch(e){e.message?.includes("Socket disconnected")&&Cs(ns[s].mainTabId,"info_message","Network error occured, during task execution...",s,!1),c<o?setTimeout((()=>u()),1e3):a(e)}}()}))}function ks(e,t,n){return new Promise(((s,o)=>{if(Ds(n,"handleTaskResponse").then((e=>{e||o(new Error("outdated request id detected!"))})).catch((e=>{o(e)})),"success"===e.status){const i={click:()=>Ns(t,e.clickable_element,"click",n),input:()=>Ns(t,e.clickable_element,"input",n),select:()=>Ns(t,e.clickable_element,"select",n),scroll_to_element:()=>Ns(t,e.clickable_element,"scroll",n),summarize:async()=>await Ps(t,e,e.taskName,n,"Reporting/Summarizing"),analyze:async()=>await Ps(t,e,e.taskName,n,"Analyzing"),break:async()=>await Ps(t,e,e.taskName,n,"Analyzing"),narrate:async()=>await Ps(t,e,e.taskName,n,"Narrating"),converse:()=>Ss(t,e,e.taskName,n),speak_to_user:()=>Ss(t,e,e.taskName,n),ask_question:()=>Is(t,e,e.taskName,n),ask_for_user_input:()=>Is(t,e,e.taskName,n),enter_key:()=>xs(t,"enter_key",n),back_button:()=>(xs(t,"back_button",n),Promise.resolve("Back button pressed")),reload_page:()=>ns[n].mainTabId===t?Promise.reject("Cannot reload main tab due to active session!"):(xs(t,"reload_page",n),Promise.resolve("Page reload initiated")),scroll_up:()=>(xs(t,"scroll_up",n),Promise.resolve("Scroll up initiated")),scroll_down:()=>(xs(t,"scroll_down",n),Promise.resolve("Scroll down initiated")),scroll_to_nearest_input_field:()=>(xs(t,"scroll_to_nearest_input_field",n),Promise.resolve("Scroll down to input initiated")),scroll_on_element_up:()=>Ns(t,e.clickable_element,"scroll_on_element_up",n),scroll_on_element_down:()=>Ns(t,e.clickable_element,"scroll_on_element_down",n),click_annotated:async()=>Os(t,e,n),input_annotated:async()=>Os(t,e,n),select_annotated:async()=>Os(t,e,n),scroll_to_element_annotated:async()=>Os(t,e,n),bulk_input_annotated:async()=>Os(t,e,n),bulk_input:async()=>Os(t,e,n),open_url:()=>Es(t,e.taskName,n),switch_to_tab:()=>function(e,t,n){return new Promise(((s,o)=>{Ds(n,"switchToUrlTab").then((i=>{if(!i)return void o(new Error("outdated request id detected!"));ms({prompt:t}).then((i=>{try{if(!i)return Es(e,t,n);(0,r.j2)(i,!0,is).then((()=>{ns[n].mainTabId=e,ns[n].tabId=i,s({status:"success",message:"Switched to tab successfully",tab:i})})).catch((e=>{throw e}))}catch(e){o(new Error(`Failed to switch tab: ${e.message}`))}})).catch((e=>{o(new Error(`Failed to switch tab: ${e.message}`))}))})).catch(o)}))}(t,e.taskName,n),wait_for_5_seconds:()=>(Cs(t,"info_message","Waiting for 5 seconds before continuing...",n,!0,!1),new Promise((e=>{setTimeout((()=>{Cs(t,"info_message","Continuing operation after 5 seconds.",n,!0,!1),e("Waited 5 seconds")}),5e3)}))),wait_for_20_seconds:()=>(Cs(t,"info_message","Waiting for 20 seconds before continuing...",n,!0,!1),new Promise((e=>{setTimeout((()=>{Cs(t,"info_message","Continuing operation after 20 seconds.",n,!0,!1),e("Waited 20 seconds")}),2e4)}))),scroll_on_element_up_annotated:async()=>Os(t,e,n),scroll_on_element_down_annotated:async()=>Os(t,e,n)},a=i[e.action];a?a().then((e=>{s(e)})).catch((e=>{o(e)})):oo(t,e,n).then((e=>{s(e)})).catch((e=>{o(e)}))}else"bulk_input"===e.action?o(new Error("Failed to generate bulk input values, retrying...")):oo(t,e,n).then((e=>{s(e)})).catch((e=>{o(e)}))}))}function Es(e,t,n){return new Promise(((r,s)=>{Ds(n,"openUrlInNewTab").then((async o=>{if(o)try{let o=null;const i=/(https?:\/\/[^\s,]+)/g,a=t.match(i);if(a&&a.length>0&&(o=a[0]),!o){const e=`\n\t\t\t\t\t\t\n\t\t\t\t\t\tFomulate a valid url for the request: "${t}", Do not provide fillers or additional comments, response url param should only be a valid url format.\n\t\t\t\t\t\t\n\t\t\t\t\t\tNOTE: your response url param will be directly inputted in browser url\n\t\t\t\t\t\t\n\t\t\t\t\t\tURL param field is required and must not be null\n\t\t\t\t\t\n\t\t\t\t\t\t`;o=(await Rs(e,{is_converse_only:!0},!1)).url}let u;try{if(u=new URL(o.trim()),!u.protocol.startsWith("http"))throw new Error("Invalid protocol")}catch(e){throw new Error(`Invalid URL format: ${o}`)}chrome.tabs.create({url:u.href,active:!0},(t=>{if(chrome.runtime.lastError)s(new Error(chrome.runtime.lastError.message));else if(t){let o={tab:{id:t.id}};(0,c.f)(t.id,u.href,o,is,ns[n].bgptIndex).then((()=>{ns[n].tabId=t.id,ns[n].mainTabId=e,r({status:"success",message:`Opened URL: ${u.href}`,tab:t.id})})).catch((e=>{s(new Error("Error occured on page load: "+e.message))}))}else s(new Error("Failed to create new tab"))}))}catch(e){s(new Error(`Failed to open URL: ${e.message}`))}else s(new Error("outdated request id detected!"))})).catch((e=>{s(new Error(`Failed to open URL: ${e.message}`))}))}))}function xs(e,t,n){return new Promise(((r,s)=>{Ds(n,"simulateBrowserAction").then((e=>{e||s(new Error("outdated request id detected!"))})).catch((e=>{s(e)})),chrome.tabs.sendMessage(e,{action:t,stateId:is},(e=>{chrome.runtime.lastError?s(new Error(chrome.runtime.lastError.message)):e&&"success"===e.status?r(e):s(new Error(e?.error||`Failed to perform ${t}`))}))}))}function Is(e,t,n,s){let o=t.objective;t.clickable_element;return new Promise(((t,i)=>{Ds(s,"askQuestion").then((a=>{if(!a)throw new Error("outdated request id detected!");Rs(`\n\t\t\t\t\t\tMain objective: ${o}\n\t\t\t\t\t\tAction Request: ${n}\n\n\t\t\t\t\t\tYou are a question asking agent.\n\t\t\t\t\t\tYou need to ask the user a question.\n\n\t\t\t\t\t\tRespond with the question only\n\n\t\t\t\t\t\tNo fillers or additional text needed.\n\t\t\t\t\t`,{is_converse_only:!0}).then((o=>{var a;(a=[(e,t)=>{ns[s].mainTabId&&ns[s].tabId!==ns[s].mainTabId&&Cs(ns[s].mainTabId,"info_message",o+"\n\n"+(ns[s].enable_realtime_mode?"\n---":""),s,!1,!1),e()},(e,t)=>{(0,r.j2)(ns[s].tabId),Cs(ns[s].tabId,"input_request",o,s,!1,!0).then(e).catch(t)},(t,r)=>{Ts(e,s).then((e=>{t(`Asked the user the question: ${n}\nUser's response: ${e}`)})).catch(r)}],Promise.all(a.map((e=>new Promise(((t,n)=>{try{e(t,n)}catch(e){n(e)}})))))).then((([e,n])=>{t(n)})).catch((e=>{i(e)}))})).catch((e=>{i(e)}))})).catch((e=>{i(e)}))}))}function Ts(e,t=null){return new Promise(((n,r)=>{function s(){function t(r,o,i){return o.tab&&o.tab.id===e&&"questionResponse"===r.action&&(chrome.runtime.onMessage.removeListener(t),clearTimeout(s),n(r.response),i({status:"success"})),!0}chrome.runtime.onMessage.addListener(t);let s=setTimeout((()=>{chrome.runtime.onMessage.removeListener(t),r(new Error("User did not respond to the question within time limit"))}),6e4)}t?Ds(t,"waitForQuestionResponse").then((e=>{if(!e)throw new Error("outdated request id detected!");s()})).catch((e=>{r(e)})):s()}))}function Ss(e,t,n,r){let s=t.objective;return new Promise(((t,o)=>{Ds(r,"converseWithUser").then((i=>{if(i){Rs(`\n\t\t\t\t\t\tMain objective: ${s}\n\t\t\t\t\t\tAction Request: ${n}\n\t\t\t\t\t\tProgress report: ${ys()}\n\n\t\t\t\t\t\tYou are a reporting/summarizing agent.\n\n\t\t\t\t\t\tYou need to converse with the user about the main objective and current progress to gain insights and better proceed with next steps.\n\n\t\t\t\t\t\tYou need to ask the user for clarification if needed.\n\n\t\t\t\t\t\tRespond with the conversation only\n\n\t\t\t\t\t\tNo fillers or additional text needed.\n\t\t\t\t\t`,{is_converse_only:!0}).then((n=>{Cs(e,"info_message",n,r,!1,!0).then((e=>{t("User notified with message to have a conversation")})).catch((e=>{o(e)}))})).catch((e=>{o(e)}))}else o(new Error("outdated request id detected!"))})).catch((e=>{o(e)}))}))}async function Ps(e,t,n,s,o="Reporting/Summarizing"){let i=t.objective;try{if(!await Ds(s,"summarizeContent"))throw new Error("outdated request id detected!");const t=await(0,r.VS)(e),a=await(0,r.lz)(e,n);let c;"Reporting/Summarizing"===o?c="summarize":"Analyzing"===o?c="analyze":"Narrating"===o&&(c="narrate");const u=`\n            Main objective: ${i}\n            Action: ${n}\n\n            You are a ${o} agent.\n\n            You are currently on a webpage and you need to perform a ${n} action.\n\n            Return the result of the ${n} action that meets the main objective.\n\n            HTML Elements on the webpage: ${JSON.stringify(a)}\n\n            The output must be you responding to the user objective given the context provided by the content of the webpage.\n\n            Response should be a response to the Action and the main objective.\n\n            NOTE:\n            - Do not describe the structure or design elements of the webpage.\n            - Do not ${c} word for word code snippets, just give a brief ${c} of what the code does\n            - Only perform a ${n} on the main content of the webpage based on the main objective.\n        `,l=await new Promise((e=>(0,r.bQ)("bgptLicenseKey",e))),d=await fetch(Fr+"/text_prompt",{method:"POST",headers:{"Content-Type":"application/json","bgpt-license-key":l},body:JSON.stringify({instruction:u,is_converse_only:!0,image:t})});if(!d.ok){if(403===d.status)throw new Error("Access forbidden: Invalid license key or insufficient permissions.");throw new Error("HTTP error: "+d.status)}const h=await d.json();return await Cs(e,"info_message",h.prompt,s,!1,!0),"Summarized content successfully"}catch(t){if(t.message?.includes("Socket disconnected")&&await Cs(ns[s].mainTabId,"info_message","Network error occurred during task execution...",s,!1),t.message.includes("outdated request id detected"))throw t;throw Ls(t,{action:"audioResponse",bgptIndex:Dr[zr]},e),new Error(t.message)}}function Os(e,t,n){return new Promise(((s,o)=>{Ds(n,"performAnnotatedAction").then((e=>{e||o(new Error("outdated request id detected!"))})).catch((e=>{o(e)})),(0,r.bQ)("annotationMapping",(r=>{if(!r)return void o(new Error("No annotation mapping found"));if("bulk_input"===t.action){if(!(t.selected_numbers&&Array.isArray(t.selected_numbers)&&t.input_values&&Array.isArray(t.input_values)))return void o(new Error("Both selected_numbers and input_values arrays are required for bulk input action"));if(t.selected_numbers.length!==t.input_values.length)return void o(new Error("Mismatch between selected_numbers and input_values lengths for bulk input action"));const n=t.selected_numbers.map(((n,s)=>{const o=t.input_values[s],i=o?.field_name||`Field ${n}`,a=r.find((e=>e.number===n))?.selector;return a?o&&o.value?new Promise((r=>{chrome.tabs.sendMessage(e,{action:"performAnnotatedAction",annotationNumber:n,selector:a,method:t.method||"auto",cmd_action:"input",inputValue:o.value,stateId:is},(e=>{chrome.runtime.lastError?r({status:"failed",field:i,number:n,error:chrome.runtime.lastError.message}):e&&"success"===e.status?r({status:"success",field:i,number:n,...e}):r({status:"failed",field:i,number:n,error:e?.error||`Failed to input value for element ${n}`})}))})):Promise.resolve({status:"failed",field:i,number:n,error:`No input value provided for input number ${n}`}):Promise.resolve({status:"failed",field:i,number:n,error:`No selector found for annotation number ${n}`})}));return void n.reduce(((e,t)=>e.then((e=>t.then((t=>[...e,t]))))),Promise.resolve([])).then((e=>{const t=e.filter((e=>"success"===e.status)).length,n=e.filter((e=>"failed"===e.status));let r="";n.length>0&&(r="\nFailed fields: "+n.map((e=>`${e.field} (#${e.number}): ${e.error}`)).join(", ")),s({status:"completed",message:`Bulk input completed with ${t} successful and ${n.length} failed inputs.${r}`,results:e,successCount:t,failureCount:n.length})})).catch((e=>{s({status:"completed_with_errors",message:`Bulk input encountered an unexpected error: ${e.message}`,error:e.message})}))}const i=r.find((e=>e.number===t.selected_number))?.selector;if(!i)return void o(new Error(`No selector found for annotation number ${t.selected_number}`));if("input_annotated"===t.action&&!t.input_value)return void o(new Error("No input value provided for input action"));const a={click_annotated:"click",input_annotated:"input",scroll_to_element_annotated:"scroll",select_annotated:"select",scroll_on_element_up_annotated:"scroll_on_element_up",scroll_on_element_down_annotated:"scroll_on_element_down"}[t.action];if(!a)return void o(new Error(`Invalid action type: ${t.action}`));let c;chrome.tabs.query({},(e=>{c=e.length})),chrome.tabs.sendMessage(e,{action:"performAnnotatedAction",annotationNumber:t.selected_number,selector:i,method:t.method,cmd_action:a,inputValue:t.input_value,stateId:is},(async r=>{if(chrome.runtime.lastError)o(new Error(chrome.runtime.lastError.message));else if(r&&"success"===r.status){if("click"===a){const{newTabId:t,tabUpdated:s}=await As(c,e,n);s&&(r.newTabId=t)}s(r)}else o(new Error(r?.error||`Failed to ${t.action} element`))}))}))}))}function As(e,t,n){return new Promise((r=>{setTimeout((()=>{chrome.tabs.query({},(s=>{s.length>e?chrome.tabs.query({active:!0,currentWindow:!0},(e=>{if(e&&e.length>0){const s=e[0].id;ns[n]&&(ns[n].mainTabId=t,ns[n].tabId=s),chrome.tabs.onUpdated.addListener((function e(t,n){t===s&&"complete"===n.status&&(chrome.tabs.onUpdated.removeListener(e),r({newTabId:s,tabUpdated:!0}))}))}else r({newTabId:null,tabUpdated:!1})})):r({newTabId:null,tabUpdated:!1})}))}),500)}))}function Ns(e,t,n,r){return new Promise(((s,o)=>{Ds(r,"simulateElementAction").then((e=>{e||o(new Error("outdated request id detected!"))})).catch((e=>{o(e)}));const i={click:"simulateClick",input:"simulateInput",scroll:"scrollToElement",select:"simulateSelect",scroll_on_element_up:"scrollOnElementUp",scroll_on_element_down:"scrollOnElementDown"}[n];if(!i)return void o(new Error(`Invalid action type: ${n}`));let a;chrome.tabs.query({},(e=>{a=e.length})),chrome.tabs.sendMessage(e,{action:i,clickable_element:t,stateId:is},(async t=>{if(chrome.runtime.lastError)o(new Error(chrome.runtime.lastError.message));else if(t&&"success"===t.status){if("click"===n){const{newTabId:n,tabUpdated:s}=await As(a,e,r);s&&(t.newTabId=n)}s(t)}else o(new Error(t.error||`Failed to ${n} element`))}))}))}function Rs(e,t={},n=!0){const{image:s=null,conv_history:o=" ",current_url:i=null,is_converse_only:a=null}=t,c="string"==typeof o?o:o?String(o):" ",u="string"==typeof i?i:i?String(i):null;return new Promise(((t,i)=>{(0,r.bQ)("bgptLicenseKey",(async l=>{const d=await(0,r.vH)(),h=Boolean(d?.task),p={instruction:e,...s&&{image:s},...c&&{conv_history:c},...u&&{current_url:u},is_follow_up:!a&&h,...a&&{is_converse_only:a}};if(o&&s&&!a){const e=c.split("\n").slice(-10).join("\n");Js(s,e,u).then((e=>{})).catch((e=>{}))}fetch(Fr+"/text_prompt",{method:"POST",headers:{"Content-Type":"application/json","bgpt-license-key":l},body:JSON.stringify(p)}).then((e=>{if(!e.ok)throw new Error(`HTTP error: ${e.status}`);return e.json()})).then((e=>{t(n?e.prompt:e)})).catch((e=>{i(new Error(e.message))}))}))}))}function Cs(e,t,n,s=null,o=!0,i=!1){return ns[s]?.enable_realtime_mode&&(o=!1,i=!1),to(e,n||"No response from BrowserGPT","checkmark","do_nothing"),new Promise(((c,u)=>{const l=()=>new Promise(((c,u)=>{if(["initiation_request","failed_task"].includes(t)){const n=s&&ns?.[s]?.mainTabId||zr;if(!n)return void u(new Error("No valid tab ID found"));(0,r.j2)(n,!1).then((()=>{"failed_task"===t&&setTimeout((()=>{(0,a.uk)(n,"from service worker",is),e!==n&&(0,a.Em)(e,is)}),5e3)})).catch((e=>{u(e)}))}else"info_message"===t||"failed_execution"===t||"input_request"===t||(0,r.j2)(e,!1);let l=e;["initiation_request","failed_task","completed_task","info_message"].includes(t)&&(l=s&&ns&&ns[s]?ns[s].mainTabId||zr||e:zr||e),chrome.tabs.get(l,(e=>{if(chrome.runtime.lastError)u(chrome.runtime.lastError);else try{chrome.tabs.sendMessage(l,{action:"sendMessagetoUser",status:t,message:n,bgptIndex:!!zr&&Dr[zr],playSpeech:o,stateId:is},(e=>{chrome.runtime.lastError?i&&!o?$s(n).then((()=>{c()})).catch((e=>{u(e)})):u(chrome.runtime.lastError):function(e){return new Promise(((t,n)=>{function r(n,o,i){return o.tab&&o.tab.id===e&&"notificationDisplayed"===n.action&&(chrome.runtime.onMessage.removeListener(r),clearTimeout(s),"displayed"===n.status?t("Notification displayed successfully"):t("Notification display failed"),i({status:"success"})),!0}chrome.runtime.onMessage.addListener(r);const s=setTimeout((()=>{chrome.runtime.onMessage.removeListener(r),t("Notification display failed")}),6e4)}))}(l).then((e=>{i&&!o?$s(n).then((()=>{c()})).catch((e=>{u(e)})):c()})).catch((e=>{i&&!o?$s(n).then((()=>{c()})).catch((e=>{u(e)})):u(e)}))}))}catch(e){i&&!o?$s(n).then((()=>{c()})).catch((e=>{u(e)})):u(e)}}))}));null!=s?Ds(s,"notifyContentScript").then((e=>{if(!e)throw new Error("outdated request id detected");return l()})).then(c).catch(c):l().then(c).catch(c)}))}function $s(e){return new Promise(((t,n)=>{(0,r.bQ)("bgptLicenseKey",(r=>{Bs(e,r).then((e=>{Hs(e).then((()=>{t()})).catch((e=>{n(e)}))})).catch((e=>{n(e)}))}))}))}function qs(e,t){return new Promise(((n,r)=>{Ds(t,"waitForUserConfirmation").then((t=>{if(!t)throw new Error("outdated request id detected!");{function s(t,o,i){return o.tab&&o.tab.id===e&&"userConfirmation"===t.action&&(chrome.runtime.onMessage.removeListener(s),"yes"===t.userResponse?n("User confirmed"):r(new Error("User declined")),i({status:"success"})),!0}chrome.runtime.onMessage.addListener(s),setTimeout((()=>{chrome.runtime.onMessage.removeListener(s),r(new Error("User confirmation timeout, proceed"))}),6e4)}})).catch((e=>{r(e)}))}))}function Ls(e,t,n){let r="failed",s=e.message;e.message.includes("Access forbidden")&&(s="Unable to process request: License verification failed.",r="invalid_key"),t.status=r,t.message={message:s,status:"failed"},t.stateId=is,t.button_id&&(t.message.button_id=t.button_id),chrome.tabs.sendMessage(n,t)}function Ms(e,t,n,o=null,i=null){return new Promise(((a,c)=>{let u="";n&&(u=`Overview of work done to complete the objective:\t${ys()}`),Rs(`\n\t\t    This is a converse action task. so you need to generate a conversational message using the converse action\n\n            The Completed objective is: ${e}\n\n            \n            ${u}\n\n            Generate a short, conversational message that implies the objective has been completed, without explicitly saying "task completed" or "successfully". \n\t\t\tThe message should sound natural and reflect the specific task. \n\t\t\tThe message should be as if you're casually updating someone on what just happened, using a tone that's informal, friendly, and to the point.\n\t\t\tSuggest to the user a few related and follow up tasks you can assist with after completing the objective\n\n            Rules & Examples:\n            - If the task is sending a message on WhatsApp, the message could be: "I've just sent the message to Beauty!"\n            - If the task is reading an email, the message could be: "Checked the email  all set!"\n            - If the task is opening a website, the message could be: "I've opened WhatsApp Web for you."\n\t\t\t- DO NOT use the navigate action\n        `,{image:o,is_converse_only:!0}).then((e=>{let r=e;n?Cs(t,"completed_task",r,i).then((e=>{a(r)})).catch((e=>{a(r)})):a(r)})).catch((r=>{let s=`I have successfully completed the task labelled: ${e}`;n?Cs(t,"completed_task",s,i,!1,!0).then((e=>{a(s)})).catch((e=>{a(s)})):a(s)})).finally((()=>{Xs(t,!1,i,null,!1),Us(0),(0,r.Hr)(null),(0,s.t)()}))}))}function js(e,t,n,o=null,i=null){return new Promise(((a,c)=>{let u="";n&&(u=`Overview of work done to meet the objective:\t${ys()}`),Rs(`\n\n\t\t\tYou are BrowserGPT, A Smart AI Assistant on the Browser\n\n\n\t\t    This is a converse action task. so you need to generate a conversational message using the converse action\n\n            The Failed task is: ${e}\n\n            Return a generic failed task message for failing to complete the above task and suggest follow up task and next step to the user\n\n\t\t\tSuggestion requirements:\n\t\t\t- Take a close look at the overview of work done to meet the objective and use it to suggest a critical follow up task\n\t\t\t- The follow up task addresses the cause of the failure, suggests a work around and is inline with the failed task\n\t\t\t- Suggest only one single follow up task suggesting what you could help with to meet the user objective \n\t\t\t  - browser actions can be: click, input, scroll up or down and summarize\n\t\t\t- Suggest a follow up task that is inline with the failed task\n\t\t\t- Suggestion could be a task that takes into account the reason for the failure and intends to try again avoiding the cause of the failure\n\t\t\t- it must be a task to perform a series of browser actions on the visible ui elements on the current tab\n\t\t\t- it must be a task that you will be able to complete without user intervention or consent\n\t\t\t- End your suggestion with a question mark\n\n\t\t\tIMPORTANT:\n\t\t\t - The critical follow must be continuation of the task: ${e}\n\t\t\t - Except this time it should include learning from the failure and trying again by taking into account the cause of the previous failure\n\n\t\t\t For example:\n\t\t\t  - if the failed task is to search on google for "how to make a website"\n\t\t\t   and the cause of failure is that the submit/search button was not found\n\t\t\t   the follow up task could be to search on google for "how to make a website" and use the enter key to submit the search\n\n\t\t\t   Notice that the follow up task is a continuation of the failed task and it includes learning from the failure\n\n\t\t\t  - Continuation must start from the current checkpoint and not from the beginning of the task\n\n            ${o}\n\n\t\t\t\n\t\t\t${u}\n\n\t\t\tRules & Examples:\n\t\t\t    - If the task is sending a message on WhatsApp, the message could be: "I was unable to send a message to Beauty"\n\t\t\t\t- If the task is reading an email, the message could be: "I was unable to read the email"\n\t\t\t\t- If the task is opening a website, the message could be: "I was unable to open the website"\n\t\t\t\t- DO NOT use the navigate action\n        `,{is_converse_only:!0}).then((e=>{let r=e;n&&Cs(t,"failed_task",r,i,!1,!0).then((e=>{})).catch((e=>{})).finally((()=>{a(r)}))})).catch((r=>{let s=`I have failed to complete the task labelled: ${e}, should i try again?`;n&&Cs(t,"failed_task",s,i,!1,!0).then((e=>{})).catch((e=>{})),a(s)})).finally((()=>{Xs(t,!1,i,null,!1),Us(0),(0,r.Hr)(null),(0,s.t)()}))}))}function Ds(e,t="unknown"){return new Promise(((t,n)=>{e?new Promise(((e,t)=>{(0,r.bQ)("requestId",(t=>{e(null===t?null:t)}))})).then((n=>{null==n?(Us(e),t(!0)):n!==e?ns[e].notifiedStopProcessing||ns[e]?.enable_realtime_mode?t(!1):(Cs(ns[e].tabId,"info_message","Will stop processing your previous request",null,!1,!1).then((e=>{t(!1)})).catch((e=>{t(!1)})),ns[e].notifiedStopProcessing=!0):t(!0)})).catch((e=>{t(!1)})):t(!0)}))}function Us(e,t){(0,r.XO)("requestId",e,(()=>{}))}function Bs(e,t){return new Promise(((n,r)=>{fetch(Fr+"/tts",{method:"POST",headers:{"Content-Type":"application/json","bgpt-license-key":t},body:JSON.stringify({text:e})}).then((e=>{if(e.ok)return e.blob();throw 403===e.status?new Error("Access forbidden: Invalid license key or insufficient permissions."):400===e.status?new Error("Rate limit exceeded"):new Error("HTTP error: "+e.status)})).then((e=>{if(!(e instanceof Blob))throw new Error("Invalid response from browserGPT");const t=new FileReader;t.onloadend=()=>{n(t.result)};try{t.readAsDataURL(e)}catch(e){r(new Error("Error reading blob as data URL: "+e.message))}})).catch((e=>{r(new Error("There has been a problem with your fetch operation: "+e.message))}))}))}async function Fs(){await chrome.offscreen.hasDocument()||await chrome.offscreen.createDocument({url:"offscreen.html",reasons:["AUDIO_PLAYBACK","USER_MEDIA"],justification:"Playback audio and record microphone input"})}async function Hs(e,t=null){return new Promise((async(n,r)=>{try{await Fs()}catch(e){}chrome.runtime.sendMessage({action:"playAudioOffscreen",url:e,senderTabId:t},(e=>{e&&"success"===e.status?n():r(new Error("Failed to play sound"))}))}))}function zs(e=!1,t=!0,n=()=>{}){fetch("https://gist.githubusercontent.com/mrkeyiano/1c0d7dd8668d9bccf0a2ffc000f94893/raw/").then((e=>e.json())).then((e=>{const r=e.version.trim(),s=e.message||"A new version is available!";Br!==r?(t&&function(e,t){chrome.notifications.create({type:"basic",iconUrl:"icon.png",title:"BrowserGPT",message:t,buttons:[{title:"See Features"}],priority:2},(function(e){function t(n,r){n===e&&0===r&&(chrome.tabs.create({url:"https://browsergpt.co"}),chrome.notifications.onButtonClicked.removeListener(t))}chrome.notifications.onButtonClicked.addListener(t)}))}(0,s),n(!1,null,s)):n(!0,null,s)})).catch((e=>{n(null,e,null)}))}function Ys(e){return new Promise(((t,n)=>{chrome.tabs.get(e,(e=>{chrome.runtime.lastError?n(chrome.runtime.lastError):t(e?.url||null)}))}))}function Ws(e,t){const{audioData:n,mimeType:o,image:i,conv_history:a=" ",current_url:c,button_id:u,bgptIndex:l}=e,d="string"==typeof a?a:a?String(a):" ",h=function(e,t){const n=atob(e),r=n.length,s=new ArrayBuffer(r),o=new Uint8Array(s);for(let e=0;e<r;e++)o[e]=n.charCodeAt(e);return new Blob([s],{type:t})}(n.split(",")[1],o),p=new FormData,m=o.split("/")[1].split(";")[0];p.append("audio",h,`recording.${m}`),p.append("conv_history",d),p.append("current_url",c),(0,r.vH)().then((e=>{const n=Boolean(e&&""!==e||!l);if(p.append("is_follow_up",n),i&&p.append("image",i),a&&i){const e=d.split("\n").slice(-10).join("\n");Js(i,e,c).then((e=>{})).catch((e=>{}))}(0,r.bQ)("bgptLicenseKey",(e=>{let n=setTimeout((()=>{Cs(t.tab.id,"info_message","This is taking longer than usual, but I'm still working on it...",null,!1),Xs(t.tab.id,!0,null,l)}),6e4);(0,r.Hr)(null),fetch(Fr+"/voice_prompt",{method:"POST",headers:{"bgpt-license-key":e},body:p}).then((e=>{if([n].forEach(clearTimeout),!e.ok)throw 403===e.status?new Error("Access forbidden: Invalid license key or insufficient permissions."):new Error("HTTP error: "+e.status);return e.json()})).then((e=>{"navigate"!==e?.action&&"task_list"!==e?.action||Xs(t.tab.id,!0,null,l),e.button_id=u,chrome.tabs.sendMessage(t.tab.id,{action:"audioResponse",status:"success",message:e,bgptIndex:l,stateId:is}),"converse"===e.action&&(0,s.t)()})).catch((e=>{[n].forEach(clearTimeout),e.message?.includes("Socket disconnected")&&Cs(t.tab.id,"info_message","Network error occured, during task execution...",l,!1),Xs(t.tab.id,!0,null,l);Ls(e,{action:"audioResponse",bgptIndex:l,button_id:u},t.tab.id)}))}))}))}fetch(chrome.runtime.getURL("sticky-button.html")).then((e=>e.text())).then((e=>{Vr=e})).catch((e=>{})),chrome.runtime.onMessage.addListener((function(e,t,n){return"getHTML"===e.action&&null!==Vr?n({html:Vr}):n({}),!0})),chrome.action.onClicked.addListener((function(e){(0,r.xo)("https://browsergpt.co").catch((e=>{}))})),chrome.runtime.onMessage.addListener(((e,t,n)=>{if("ping"===e.action)return n({status:"active"}),!0;if("getStateId"===e.action)n({stateId:is});else if("getFreshStateId"===e.action)chrome.tabs.sendMessage(t.tab.id,{action:"setStateId",stateId:is},(e=>{chrome.runtime.lastError?n({status:"error",error:chrome.runtime.lastError.message}):n({status:"success",stateId:is})}));else if(!e.stateId&&t.tab&&t.tab.id||e.stateId!==is&&t.tab&&t.tab.id)t.tab?.id&&chrome.tabs.sendMessage(t.tab.id,{action:"reset",stateId:is}),n({status:"success"});else if("novaOpenWeb"===e.action){if(ps(e.action))return n({status:"error",message:`Please wait before sending another ${e.action} request`}),!0;t.tab.id;hs(e).then((s=>{"duplicate"!==s.status?(0,r.XO)("novaWebRequest",{requestAction:e.action,requestPrompt:e.prompt,instructionId:e.instructionId,timestamp:Date.now()},(()=>(chrome.tabs.update(t.tab.id,{active:!0}).then((()=>{ms(e).then((s=>{s?(0,r.j2)(s,!0,is).then((()=>{gs(s,e,t,!0)})).catch((n=>{(0,r.xo)(e.url,!0).then((n=>{(0,r.j2)(n.id,!0,is).then((()=>{gs(n.id,e,t,!0)}))})).catch((e=>{}))})):!function(e){try{const t=new URL(e);if(!t.protocol||!["http:","https:"].includes(t.protocol))return!1;const n=t.origin.replace(/\/+$/,"");try{return new URLPattern(n),!0}catch{return!1}}catch(e){return!1}}(e.url)?n({status:"error",error:"Invalid URL provided"}):chrome.tabs.query({active:!0},(function(r){const s=r[0];s&&s.id?(jr[s.id]=e.prompt,Dr[s.id]=e.bgptIndex,zr=s.id,chrome.tabs.create({url:e.url},(function(r){chrome.runtime.lastError?n({status:"error",error:chrome.runtime.lastError.message}):r&&r.id?(0,c.f)(r.id,e.url,t,is,e.bgptIndex).then((()=>{gs(r.id,e,t)})).catch((e=>{n({status:"error",error:e.message})})):n({status:"error",error:"Failed to create tab"})}))):(Cs(t.tab.id,"info_message","Error occurred, url is not valid: "+e.url),Cs(t.tab.id,"failed_task","Error occurred, provided url is not valid, should i try again?"),n({status:"error",error:"Invalid URL provided"}))}))})).catch((e=>{n({status:"error",error:e.message})}))})).catch((e=>{Cs(t.tab.id,"failed_task","Error occurred, Unable to process your request, tab is not active, should i try again?").catch((e=>{})),n({status:"error",error:e.message})})),!0))):n({status:"duplicate"})})).catch((e=>{n({status:"error",error:e.message})}))}else if("novaCurrentTab"===e.action){if(ps(e.action))return n({status:"error",message:`Please wait before sending another ${e.action} request`}),!0;t.tab.id;hs(e).then((s=>{"duplicate"===s.status?n({status:"duplicate"}):(0,r.XO)("novaWebRequest",{requestAction:e.action,requestPrompt:e.prompt,instructionId:e.instructionId,timestamp:Date.now()},(()=>{chrome.tabs.query({active:!0,currentWindow:!0},(function(r){const s=r[0];s&&s.id?(jr[s.id]=e.prompt,Dr[s.id]=e.bgptIndex,zr=s.id,gs(s.id,e,t,!1),n({status:"success"})):(chrome.tabs.update(t.tab.id,{active:!0},(function(r){chrome.runtime.lastError?n({status:"error",error:"Could not activate tab"}):(jr[t.tab.id]=e.prompt,Dr[t.tab.id]=e.bgptIndex,zr=t.tab.id,gs(t.tab.id,e,t,!1))})),n({status:"success"}))}))}))})).catch((e=>{n({status:"error",error:e.message})}))}return!0})),chrome.runtime.onMessage.addListener(((e,t,n)=>{if("getStateId"===e.action)n({stateId:is});else if("getFreshStateId"===e.action)chrome.tabs.sendMessage(t.tab.id,{action:"setStateId",stateId:is},(e=>{chrome.runtime.lastError?n({status:"error",error:chrome.runtime.lastError.message}):n({status:"success",stateId:is})}));else if(!e.stateId&&t.tab&&t.tab.id||e.stateId!==is&&t.tab&&t.tab.id)t.tab?.id&&chrome.tabs.sendMessage(t.tab.id,{action:"reset",stateId:is}),n({status:"success"});else if("captureTab"===e.action)if(ps(e.action)&&n({status:"error",message:`Please wait before sending another ${e.action} request`}),t.tab.url.startsWith("http://")||t.tab.url.startsWith("https://")){let o=!1;ts=e.enforceUserConfirmation;let i=0,a=e.stepsLimit||20,c=0;const u=e.maxAttempts||2;let l=rs;if(e.requestId){let h=rs;Xs(t.tab.id,!0,h),d(e.data)}else o=!0,fs(e,t,t.tab.id).then((()=>{l=rs,Xs(t.tab.id,!0,l),d(e.data)}));function d(o=null){Ds(l,"initiateGPT").then((e=>{if(!e)throw new Error("outdated request id detected!")})).catch((e=>{n({status:"error",error:"Outdated request id detected"})})),i>=u?(js(e.prompt,ns[l].tabId,!0,"Failed to complete your request, maximum retries reached",l).then((()=>{Qr.length=0,Gr.length=0,Xr.length=0})),n({status:"error",error:"Max retries reached for your request"}),Zr=!1):(0,r.VS)(ns[l].tabId).then((h=>{(function(e,t,n=null,s=rs,o=!1,i=2){let a=0,c=(0,r.lz)(ns[s].tabId,"click");return new Promise(((u,l)=>{function d(){a++,Ds(s,"attemptProcessTasks").then((e=>{e||l(new Error("outdated request id detected!"))})).catch((e=>{l(e)}));let o=setTimeout((()=>{ns[s].enable_realtime_mode&&Cs(ns[s].tabId,"info_message",ns[s].enable_realtime_mode?"Initializing execution workflow for the task request, please wait...":"I'm figuring out next steps...",s,!1),Xs(ns[s].tabId,!0,s)}),7e3),p=setTimeout((()=>{Cs(ns[s].tabId,"info_message",ns[s].enable_realtime_mode?"Processing task request in execution workflow, this is taking longer than expected, please wait...":"I'm figuring out next steps...",s,!1),Xs(ns[s].tabId,!0,s)}),2e4);n&&n.tasks&&n.tasks.length>0?(h(n,s).then((()=>{u()})).catch((e=>{l(e)})),n=null):Qs(t).then((n=>{Ys(ns[s].tabId).then((m=>{fetch(Fr+"/handle_browser_tasks",{method:"POST",headers:{"Content-Type":"application/json","bgpt-license-key":ns[s].apiKey},body:JSON.stringify({image:e,prompt:`${t} \n\nMost relevant profile info:\n ${n}`,elements:JSON.stringify(c),performed_tasks:ys(),current_url:m})}).then((e=>(clearTimeout(o),clearTimeout(p),e.json()))).then((e=>{h(e,s).then((()=>{u()})).catch((e=>{l(e)}))})).catch((e=>{if(clearTimeout(o),clearTimeout(p),e.message?.includes("Socket disconnected")&&Cs(ns[s].mainTabId,"info_message","Network error occured, during task execution...",s,!1),s!==rs)ns[s].aborted=!0,l(new Error("outdated request id detected!"));else{if(!(a<i))return void l(e);(0,r.lz)(ns[s].tabId).then((e=>{c=e,d()})).catch((e=>{}))}}))}))})).catch((e=>{if(e.message?.includes("Socket disconnected")&&Cs(ns[s].mainTabId,"info_message","Network error occured, during task execution...",s,!1),clearTimeout(o),clearTimeout(p),s!==rs)l(new Error("outdated request id detected!"));else{if(!(a<i))return void l(e);(0,r.lz)(ns[s].tabId).then((e=>{c=e,d()})).catch((e=>{}))}}))}function h(e,n){return new Promise(((s,u)=>{Ds(n,"processData").then((l=>{if(l)if("failed"===e.status)!a<i?u(new Error("failed, max attempts reached")):(0,r.lz)(ns[n].tabId).then((e=>{c=e,d()})).catch((e=>{}));else{let l=e.summary;Xs(ns[n].tabId,!0,n),new Promise(((e,t)=>{(0,r.bQ)("askPermissionToPerformAction",(t=>{e(null===t||t)}))})).then((h=>{if(h&&e?.tasks?.length>0&&!["converse","speak_to_user","ask_question","ask_for_user_input"].includes(e.tasks[0].action)&&(!os||e?.tasks?.length>0&&ns[n].enforceUserConfirmation&&!ns[n].enable_realtime_mode)||ns[n].enforceUserConfirmation)os=!0,Cs(ns[n].mainTabId,"initiation_request",`${e.summary}, should i proceed?`,n,!o),qs(ns[n].mainTabId,n).then((o=>{(0,r.j2)(ns[n].tabId,!1),ws(t,e,l,n).then((()=>s())).catch((e=>{!(a<i)||e.message.includes("checkTaskCompletion")||e.message.includes("not found")||e.message.includes("nofurtheractions")||e.message.includes("outdated request id detected")||e.message.includes("Could not establish connection. Receiving end does not exist.")?u(e):(0,r.lz)(ns[n].tabId).then((e=>{c=e,d()})).catch((e=>{}))}))})).catch((e=>{os=!1,u(new Error("Process cancelled by user."))}));else{if(!e.tasks||0===e.tasks.length)return void u(new Error("nofurtheractions"));["converse","speak_to_user","ask_question","ask_for_user_input"].includes(e.tasks[0].action)?Cs(ns[n].tabId,"info_message",`${"..."==e.summary?"Still working on it...":e.summary}`,n,!1,!1):Cs(ns[n].tabId,"info_message",`${e.summary}`,n,!o).then((()=>{})).catch((e=>{})).finally((()=>{})),ws(t,e,l,n).then((()=>s())).catch((e=>{!(a<i)||e.message.includes("checkTaskCompletion")||e.message.includes("not found")||e.message.includes("nofurtheractions")||e.message.includes("outdated request id detected")||e.message.includes("Could not establish connection. Receiving end does not exist.")?u(e):(0,r.lz)(ns[n].tabId).then((e=>{c=e,d()})).catch((t=>{u(e)}))}))}})).catch((e=>{u(e)}))}else u(new Error("outdated request id detected!"))}))}))}ns[s].aborted?l(new Error("TASK_ABORTED")):d()}))})(h,e.prompt,o,l,ts).then((()=>{as=`\n\t\t\t\t\t\t\t\t\tUser objective: ${e.prompt}\n\n\t\t\t\t\t\t\t\t\t${ys()}\n\t\t\t\t\t\t\t\t`,vs(as,ns[l].tabId,!0,l).then((()=>{Qr.length=0,Gr.length=0,Xr.length=0,Zr=!1,Jr=!1,Qr.length=0,Gr.length=0,Xr.length=0,n({status:"success"})})).catch((r=>{Jr=!1,c<a&&!e.directExecution?d():e.directExecution?(js(e.prompt,t.tab.id,!0,`Failed to complete your request in ${a} steps, maximum steps reached`,l).then((()=>{Qr.length=0,Gr.length=0,Xr.length=0})),n({status:"error",error:"Max steps reached for your request"})):(Cs(t.tab.id,"initiation_request",`I've reached the limit of ${a} steps. Should I continue working on this task?`,l,!1),qs(t.tab.id,l).then((e=>{c=0,d()})).catch((r=>{js(e.prompt,t.tab.id,!0,`Stopped after reaching the limit of ${a} steps.`,l).then((()=>{Qr.length=0,Gr.length=0,Xr.length=0})),n({status:"error",error:"User declined to continue after reaching step limit"})})))}))})).catch((t=>{if(c++,t.message.includes("checkTaskCompletion"))i<u&&!e.directExecution&&Cs(ns[l].mainTabId,"failed_execution","Performed a series of actions successfully",l,!1,!1).then((()=>{i++,d()}));else if(t.message.includes("not found")&&!e.directExecution)Cs(ns[l].mainTabId,"info_message","Had issues processing your request, error: "+t.message,l,!1).then((()=>{i++,d()}));else if(t.message.includes("nofurtheractions"))Jr=!1,(0,r.VS)(ns[l].tabId).then((e=>{Ms(ns[l].prompt,ns[l].tabId,!0,e,l).then((()=>{Gr.length=0,Qr.length=0,Xr.length=0}))})).catch((e=>{})).finally((()=>{Qr.length=0,Gr.length=0,Xr.length=0,Zr=!1,n({status:"success"})}));else if(t.message.includes("cancelled"))Qr.length=0,Gr.length=0,Xr.length=0,Zr=!1,Cs(ns[l].tabId,"info_message","Operation has been cancelled as per your request.",l,!1,!1),Xs(ns[l].tabId,!1,l),(0,r.Hr)(null),Us(0),(0,s.t)(),n({status:"success"});else if(t.message.includes("outdated request id detected")||t.message.includes("TASK_ABORTED"))Zr=!1,Qr.length=0,Gr.length=0,Xr.length=0,n({status:"error",error:"Error in handleBrowserTasks"});else{t.message.includes("Could not establish connection. Receiving end does not exist.")&&(t.message="Lost connection the tab for processing the request");let r="Failed to complete your request due to an error: "+t.message;js(e.prompt,ns[l].tabId,!0,r,l).then((()=>{Zr=!1,Qr.length=0,Gr.length=0,Xr.length=0,n({status:"error",error:"Error in handleBrowserTasks"})}))}}))})).catch((t=>{Zr=!1,js(e.prompt,ns[l].tabId,!0,"Unable to capture active tab for processing your request",l).then((()=>{Qr.length=0,Gr.length=0,Xr.length=0,n({status:"error",error:"Cannot capture tab"})}))}))}}else Zr=!1,Qr.length=0,Gr.length=0,Xr.length=0,(0,r.Hr)(null),Cs(t.tab.id,"info_message","Cannot process your request, the URL is inaccessible for capturing.",null,!1),n({status:"error",error:"Inaccessible URL"});return!0})),chrome.runtime.onMessage.addListener(((e,t,n)=>{if("getStateId"===e.action)n({stateId:is});else if("getFreshStateId"===e.action)chrome.tabs.sendMessage(e.tabId||t.tab.id,{action:"setStateId",stateId:is},(e=>{chrome.runtime.lastError?n({status:"error",error:chrome.runtime.lastError.message}):n({status:"success",stateId:is})}));else if("getFreshStateId"!=e.action&&!e.stateId&&t.tab&&t.tab.id||"getFreshStateId"!=e.action&&e.stateId!==is&&t.tab&&t.tab.id)t.tab?.id&&("sendAudio"===e.action||"sendQuestion"===e.action)||!e.stateId?(chrome.tabs.sendMessage(t.tab.id,{action:"reset",stateId:is}),chrome.tabs.sendMessage(t.tab.id,{action:"resetResponse",status:"success",stateId:0}),n({status:"success"})):n({status:"success"});else if("setGlobalTask"===e.action)(0,r.Hr)(e.task),n({status:"success"});else if("instructionRequestReceived"===e.action)n({status:"success"});else if("getGlobalData"===e.action)(0,r.bQ)(e.key,(r=>{chrome.tabs.sendMessage(t.tab.id,{action:"getGlobalDataResponse",status:"success",message:r,bgptIndex:e.bgptIndex,stateId:is}),n({status:"success",data:r})}));else if("setGlobalData"===e.action)(0,r.XO)(e.key,e.data,(()=>{n({status:"success",data:e.data})}));else if("getGlobalTask"===e.action)(0,r.vH)().then((r=>{chrome.tabs.sendMessage(t.tab.id,{action:"getGlobalTaskResponse",status:"success",message:r,bgptIndex:e.bgptIndex,stateId:is}),n({status:"success",task:r})})).catch((r=>{chrome.tabs.sendMessage(t.tab.id,{action:"getGlobalTaskResponse",status:"success",message:null,bgptIndex:e.bgptIndex,stateId:is}),n({status:"error",error:r.message})}));else{if("handleChatButtonClick"===e.action)return Ys(t.tab.id).then((n=>{ro(t.tab.id,e.prompt,!0,n).then((e=>{})).catch((e=>{}))})),!0;if("logMeOut"===e.action)(0,r.Hr)(null),fs(e,t,t.tab.id),(0,r.XO)("bgptLicenseKey",null,(()=>{Cs(t.tab.id,"info_message","You have been logged out of BrowserGPT",null,!1,!1)})),n({status:"success"});else if("switchToTab"===e.action){if(ps(e.action))return n({status:"error",message:`Please wait before sending another ${e.action} request`}),!0;null==zr&&(zr=t.tab.id,Dr[zr]=e.bgptIndex),e.stateId===is&&ms(e).then((t=>{function n(){js(e.prompt,zr,!e.enable_realtime_mode)}t?(0,r.j2)(t,!0,is).then((()=>{Ms(e.prompt,t,!e.enable_realtime_mode)})).catch((e=>{n()})):n()})).catch((n=>{Cs(t.tab.id,"failed_task","Error occurred while fetching tabs, should i try again?",null,!1,!e.enable_realtime_mode)})),n({status:"success"})}else{if("reloadExtension"===e.action)return eo(t.tab.id,e.bgptIndex).then((e=>{n(e)})),!0;if("sendAudio"===e.action){if(ps(e.action))return n({status:"error",message:`Please wait before sending another ${e.action} request`}),!0;const{audio:s,mimeType:o,button_id:i,currentUrl:a,conv_history:c,bgptIndex:u}=e;chrome.tabs.query({active:!0,currentWindow:!0},(e=>{const n=e[0];n&&n.id&&(0,r.VS)(n.id).then((e=>{Ws({audioData:s,mimeType:o,image:e,conv_history:c,current_url:n.url,button_id:i,bgptIndex:u},t)})).catch((e=>{Ws({audioData:s,mimeType:o,conv_history:c,current_url:a,button_id:i,bgptIndex:u},t)}))})),n({status:"success"})}else if("requestAndPlayAudioStream"===e.action){let s={text:e.text,audio:null,fast:!0};(0,r.bQ)("bgptLicenseKey",(r=>{(async function(e,t,n){try{const r=await fetch(Fr+"/stream_voice_prompt",{method:"POST",headers:{"Content-Type":"application/json","bgpt-license-key":t},body:JSON.stringify({text:e})});if(!r.ok)throw new Error(`HTTP error: ${r.status}`);await Fs();const s=r.body.getReader();async function o(){try{const{done:e,value:t}=await s.read();if(e)return void chrome.runtime.sendMessage({action:"playAudioOffscreen",done:!0,senderTabId:n});let r;r=t&&t.chunk?new Uint8Array(t.chunk):t&&t.chunk&&"Buffer"===t.chunk.type?new Uint8Array(t.chunk.data):t instanceof Uint8Array?t:new Uint8Array(t),chrome.runtime.sendMessage({action:"playAudioOffscreen",blobData:Array.from(r),type:"audio/mpeg",senderTabId:n}),await o()}catch(e){}}await o()}catch(i){}})(e.text,r,t.tab.id).then((r=>{chrome.tabs.sendMessage(t.tab.id,{action:"ttsResponse",status:"success",message:s,bgptIndex:e.bgptIndex,stateId:is}),n(r)}))})),n({status:"success"})}else if("sendTts"===e.action){if(ps(e.action))return n({status:"error",message:`Please wait before sending another ${e.action} request`}),!0;let s=!1;(0,r.bQ)("bgptLicenseKey",(n=>{Bs(e.text,n).then((n=>{let r={text:e.text,audio:n,fast:s,played:!1};s?e.enable_realtime_mode||Hs(n).then((()=>{chrome.tabs.sendMessage(t.tab.id,{action:"ttsResponse",status:"success",message:r,bgptIndex:e.bgptIndex,stateId:is})})).catch((e=>{})):Hs(n).then((()=>{r.played=!0,chrome.tabs.sendMessage(t.tab.id,{action:"ttsResponse",status:"success",message:r,bgptIndex:e.bgptIndex,stateId:is})})).catch((e=>{}))})).catch((n=>{Ls(n,{action:"ttsResponse",bgptIndex:e.bgptIndex},t.tab.id)}))})),n({status:"success"})}else if("captureScreen"===e.action){let s=null;e.url?chrome.tabs.query({url:e.url},(o=>{o.length>1?s=o[o.length-1].id:1==o.length&&(s=o[0].id),s&&(0,r.VS)(s,t.tab.id).then((r=>{chrome.tabs.sendMessage(t.tab.id,{action:"captureScreenResponse",status:"success",message:{image:r,description:"",currentUrl:e.url},stateId:is,bgptIndex:e.bgptIndex}),n({status:"success",image:r})}))})):chrome.tabs.query({active:!0,currentWindow:!0},(s=>{const o=s[0];o&&o.id&&(0,r.VS)(o.id).then((s=>{(0,r.s4)(s).then((r=>{chrome.tabs.sendMessage(t.tab.id,{action:"captureScreenResponse",status:"success",message:{image:s,description:r,currentUrl:o.url},stateId:is,bgptIndex:e.bgptIndex}),n({status:"success",image:s})}))})).catch((e=>{n({status:"error",error:"Error capturing screen"})}))}))}else if("sendQuestion"===e.action){if(ps("sendQuestion"))return n({status:"error",message:"Please wait before sending another question"}),!0;chrome.tabs.query({active:!0,currentWindow:!0},(n=>{const o=n[0];o&&o.id?(0,r.VS)(o.id).then((n=>{Rs(e.text,{image:n,conv_history:e.conv_history,current_url:o.url,is_converse_only:e.is_converse_only||!1},!1).then((n=>{chrome.tabs.sendMessage(t.tab.id,{action:"questionResponse",status:"success",message:n,bgptIndex:e.bgptIndex,stateId:is}),"converse"===n.action&&(0,s.t)(),["navigate","task_list"].includes(n.action)&&(0,r.Hr)(null)})).catch((n=>{Ls(n,{action:"questionResponse",bgptIndex:e.bgptIndex},t.tab.id)}))})).catch((()=>{Rs(e.text,{conv_history:e.conv_history,current_url:o.url,is_converse_only:!1}).then((n=>{chrome.tabs.sendMessage(t.tab.id,{action:"questionResponse",status:"success",message:n,bgptIndex:e.bgptIndex,stateId:is})})).catch((n=>{Ls(n,{action:"questionResponse",bgptIndex:e.bgptIndex},t.tab.id)}))})):Rs(e.text,{conv_history:e.conv_history,current_url:e.current_url,is_converse_only:!1}).then((n=>{chrome.tabs.sendMessage(t.tab.id,{action:"questionResponse",status:"success",message:n,bgptIndex:e.bgptIndex,stateId:is})})).catch((n=>{Ls(n,{action:"questionResponse",bgptIndex:e.bgptIndex},t.tab.id)}))})),n({status:"success"})}else{if("savelicenseKey"===e.action)return(0,r.bQ)("bgptLicenseKey",(t=>{t!==e.licenseKey?(0,r.XO)("bgptLicenseKey",e.licenseKey,(()=>{(0,i.s)(),(0,o.J0)(),(0,i.w)(),n({status:"success"})})):n({status:"success"})})),!0;if("getLicenseKey"===e.action)(0,r.bQ)("bgptLicenseKey",(n=>{chrome.tabs.sendMessage(t.tab.id,{action:"licenseKeyResponse",status:"success",message:n,stateId:is,bgptIndex:e.bgptIndex})})),n({status:"success"});else if("recordingComplete"===e.action){const{audioData:s,button_id:o,currentUrl:i,conv_history:a,bgptIndex:c}=e;(0,r.VS)(t.tab.id).then((e=>{Ws({audioData:s,mimeType:"audio/wav",image:e,conv_history:a,current_url:i,button_id:o,bgptIndex:c},t)})).catch((e=>{Ws({audioData:s,mimeType:"audio/wav",conv_history:a,current_url:i,button_id:o,bgptIndex:c},t)})),n({status:"success"})}else if("playAudio"===e.action){let r=t.tab.id;Hs(e.url,t.tab.id).then((()=>{chrome.tabs.sendMessage(r,{action:"playAudioEnded",status:"success",stateId:is}).then((()=>{n({status:"success"})})).catch((e=>{n({status:"error",message:e.message})}))})).catch((e=>{chrome.tabs.sendMessage(r,{action:"playAudioEnded",status:"success",stateId:is}).then((()=>{n({status:"success"})})).catch((e=>{n({status:"error",message:e.message})})),n({status:"success"})}))}else if("stopAudio"===e.action)Gs().then((()=>{chrome.tabs.sendMessage(t.tab.id,{action:"playAudioEnded",status:"success",stateId:is}).then((()=>{n({status:"success"})})).catch((e=>{n({status:"error",message:e.message})}))})).catch((e=>{n({status:"error",message:e.message})}));else if("updateCheck"===e.action){zs(!1,!1,((n,r,s)=>{r||(n?chrome.tabs.sendMessage(t.tab.id,{action:"noNewUpdate",status:!0,message:s,bgptIndex:e.bgptIndex,stateId:is}):chrome.tabs.sendMessage(t.tab.id,{action:"noNewUpdate",status:!1,bgptIndex:e.bgptIndex,message:s,stateId:is}))})),n(e)}else if("askPermissionToPerformAction"===e.action)a=e.status,c=()=>{},(0,r.XO)("askPermissionToPerformAction",a,(()=>{c&&c()})),n({status:"success"});else if("toggleSmartSense"===e.action)Hr=e.status,function(e,t){(0,r.XO)("runSmartSense",e,(()=>{t&&t()}))}(e.status,(()=>{})),n({status:"success"});else if("playAudioEnded"===e.action)chrome.tabs.sendMessage(e.senderTabId,{action:"playAudioEnded",status:"success",stateId:is}),n(e);else if("debuggerInput"===e.action)(0,u.Sp)(t.tab.id,e.selector,e.text).then((e=>{n(e)})).catch((e=>{n({success:!1,error:e.message})}));else if("processImageUpdateProfileInfo"===e.action){let t=e.conv_history.split("\n").slice(-10).join("\n");t=t+"\n"+prompt,Js(e.image,t,e.current_url).then((e=>{n(e)})).catch((e=>{n({success:!1,error:e.message})}))}else if("getRelevantProfileInfo"===e.action)Qs(e.prompt).then((e=>{n(e)})).catch((e=>{n({success:!1,error:e.message})}));else if("testDebugger"===e.action)(0,u.uZ)().then((()=>n({done:!0}))),n({status:"success"});else if("generateSuggestions"===e.action)chrome.tabs.query({active:!0,currentWindow:!0},(r=>{const s=r[0];s&&s.id?(chrome.windows.get(s.windowId,(e=>{})),(0,l.pq)(t.tab.id,e.showLoading||!0,e.extraInstructions).then((e=>{n({status:e?"success":"error"})})).catch((e=>{n({status:"error",message:e.message})}))):(0,l.pq)(t.tab.id,e.showLoading||!0,e.extraInstructions).then((e=>{n({status:e?"success":"error"})})).catch((e=>{n({status:"error",message:e.message})}))}));else if("updateSuggestions"===e.action){const s=(e.suggestions||[]).filter((e=>"no_action"!==e.action)).map((e=>({text:e.instruction,icon:(0,l.Iz)(e.action),action:e.action})));s.length>0&&t.tab&&t.tab.id&&(0,r.u3)(t.tab.id,{action:"updateSuggestions",message:s,stateId:is,bgptIndex:!1}),n({status:"success"})}}}}var a,c;return!0})),chrome.runtime.onInstalled.addListener((e=>{if(Mr({dsn:"https://3b01d2829dd5f3793663d40323126fbf@o1335554.ingest.us.sentry.io/4508630143729664",integrations:[],tracesSampleRate:1,tracePropagationTargets:["localhost",/^https:\/\/yourserver\.io\/api/],environment:"production",enableTracing:!0,beforeSend:e=>(e.tags={...e.tags,context:"extension-background"},e)}),(0,i.s)(),"install"===e.reason||"update"===e.reason){(0,r.xo)("https://browsergpt.co").catch((e=>{}))}so(),(0,o.J0)(),(0,i.w)(),chrome.tabs.query({},(e=>{e.forEach((e=>{!e.url||e.url.startsWith("chrome://")||e.url.startsWith("about:")||e.url.startsWith("edge://")||e.url.startsWith("file://")||chrome.tabs.sendMessage(e.id,{action:"ping",stateId:is},(t=>{chrome.runtime.lastError&&(0,r.Iu)(e,is).then((()=>{(0,r.bQ)("bgptLicenseKey",(t=>{t&&(0,r.Y7)("license_key",t,e.id)}))})).catch((e=>{}))}))}))}))})),function(){const e=setInterval((()=>{null!==is&&(clearInterval(e),(0,a.je)(is),(0,l.FK)(is))}),100)}(),setTimeout((()=>{zs(!0)}),288e5),setInterval((()=>{zs(!1)}),72e5);let Ks=null;async function Vs(){try{Ks=null;const e=await(0,r.bQ)("bgptLicenseKey");if(!e)return;const t=await fetch(`${Fr}/get_pending_requests`,{method:"POST",headers:{"Content-Type":"application/json","bgpt-license-key":e},body:JSON.stringify({email:e})});if(!t.ok)throw new Error("Failed to fetch pending tasks");const n=await t.json(),s=new Date,o=n.filter((e=>{const t=new Date(e.execution_date+"Z");return"pending"===e.status&&t.toDateString()===s.toDateString()&&t>s}));if(o.length>0&&chrome.power){const e=o.reduce(((e,t)=>new Date(t.execution_date+"Z")<new Date(e.execution_date+"Z")?t:e)),t=new Date(e.execution_date+"Z"),n=new Date(t.getTime()+6e5);try{const e=Math.max(0,t.getTime()-s.getTime()),o=Math.max(0,n.getTime()-s.getTime());e>0&&(chrome.power.requestKeepAwake("system"),setTimeout((()=>{!async function(){const e=await chrome.windows.getAll({populate:!0});e.some((e=>e.tabs.some((e=>e.active&&!e.url.includes("file://","chrome://","about:","chrome-error://")))))||await async function(){const e="https://browsergpt.co/?mode=nova";try{(0,r.xo)(e)}catch(e){}}()}()}),e),setTimeout((()=>{try{chrome.power.releaseKeepAwake(),Vs().catch((e=>{}))}catch(e){Vs().catch((e=>{}))}}),o))}catch(e){}}else if(chrome.power)try{chrome.power.releaseKeepAwake()}catch(e){}}catch(e){if(chrome.power)try{chrome.power.releaseKeepAwake()}catch(e){}}}function Js(e,t,n){return new Promise(((s,o)=>{(0,r.bQ)("bgptLicenseKey",(r=>{fetch(Fr+"/process_image_profile",{method:"POST",headers:{"Content-Type":"application/json","bgpt-license-key":r},body:JSON.stringify({image:e,prompt:t,current_url:n})}).then((e=>{if(!e.ok){if(403===e.status)throw new Error("Access forbidden: Invalid license key or insufficient permissions.");throw new Error(`HTTP error: ${e.status}`)}return e.json()})).then((e=>{s(e)})).catch((e=>{o(e)}))}))}))}function Qs(e){return new Promise(((t,n)=>{(0,r.bQ)("bgptLicenseKey",(r=>{fetch(Fr+"/get_relevant_profile",{method:"POST",headers:{"Content-Type":"application/json","bgpt-license-key":r},body:JSON.stringify({prompt:e})}).then((e=>{if(!e.ok){if(403===e.status)throw new Error("Access forbidden: Invalid license key or insufficient permissions.");throw new Error(`HTTP error: ${e.status}`)}return e.json()})).then((e=>{const n="object"==typeof e.profile_info?JSON.stringify(e.profile_info):e.profile_info||"";t(n)})).catch((e=>{n(e)}))}))}))}async function Gs(){return new Promise((async(e,t)=>{try{await chrome.offscreen.hasDocument()&&await chrome.offscreen.closeDocument(),e()}catch(e){t(e)}}))}function Xs(e,t,n,r=null,s=!0,o=!1){let i=!1;if(n){let e=ns[n];if(e.enable_realtime_mode)return void chrome.tabs.sendMessage(e.mainTabId,{action:"disable_cancel_mode",bgptIndex:e.bgptIndex,stateId:is,message:{force:o}});i=r||e.bgptIndex,[e.tabId,e.mainTabId].forEach((e=>{chrome.tabs.sendMessage(e,{action:1==t?"enable_cancel_mode":"disable_cancel_mode",bgptIndex:i,stateId:is,message:{force:o}},(e=>{}))}))}else i=r||!1,chrome.tabs.sendMessage(e,{action:1==t?"enable_cancel_mode":"disable_cancel_mode",bgptIndex:i,stateId:is,message:{force:o}},(e=>{}))}function Zs(e,t,n,r=null,s=!0,o=!1){let i=!1;if(n){let e=ns[n];i=r||e.bgptIndex,[e.tabId,e.mainTabId].forEach((e=>{chrome.tabs.sendMessage(e,{action:1==t?"enable_spinner_mode":"disable_spinner_mode",bgptIndex:i,stateId:is,message:{force:o}},(e=>{}))}))}else i=r||!1,chrome.tabs.sendMessage(e,{action:1==t?"enable_spinner_mode":"disable_spinner_mode",bgptIndex:i,stateId:is,message:{force:o}},(e=>{}))}async function eo(e,t,n=!0){try{await Gs()}catch(e){}return es=!1,Zs(e,!1,null,t,!1),Xs(e,!1,null,t,!1),(0,o.K5)(),Us(0),{status:"success",message:"Extension reloaded successfully."}}function to(e,t,n="checkmark",s="do_nothing",o=!1){const i=[{text:t,icon:n,action:s}];chrome.tabs.sendMessage(e,{action:"updateSuggestions",message:i,stateId:is,bgptIndex:!1}).catch((i=>{o?no("Error Occurred","Error sending response, please try again."):chrome.tabs.get(e).then((i=>{(0,r.Iu)(i,is).then((()=>{setTimeout((()=>{to(e,t,n,s,o)}),3e3)})).catch((e=>{no("Error Occurred","Error sending response, please reload the page and try again.")}))})).catch((e=>{no("Error Occurred","Error sending response, please reload the page and try again.")}))}))}function no(e,t){chrome.notifications.create({type:"basic",iconUrl:"icon.png",title:e,message:t})}function ro(e,t="",n=!0,o=null,i="Input your Custom Instruction"){return new Promise(((a,c)=>{(0,r.YL)(e,is).then((()=>{n&&Zs(e,!0,null,!1,!1,!0),Cs(e,"input_request",`${i}\n\n`,null,!1,!1).then((e=>{})).catch((t=>{n&&Zs(e,!1,null,!1,!1,!0),c(t)})),Ts(e).then((i=>{i?(0,r.VS)(e).then((u=>{Rs(t?`Context: "${t}"\n\n${i}`:i,{image:u,conv_history:[],current_url:o,is_converse_only:!1},!1).then((t=>{chrome.tabs.sendMessage(e,{action:"customPromptResponse",status:"success",message:t,bgptIndex:!1,stateId:is}),"converse"===t.action&&(0,s.t)(),["navigate","task_list"].includes(t.action)&&(0,r.Hr)(null),n&&Zs(e,!1,null,!1,!1,!0),a(t)})).catch((t=>{Ls(t,{action:"customPromptResponse"},e),n&&Zs(e,!1,null,!1,!1,!0),c(t)}))})).catch((t=>{n&&Zs(e,!1,null,!1,!1,!0),c(t)})):(n&&Zs(e,!1,null,!1,!1,!0),a(null))})).catch(c)})).catch((e=>{"string"==typeof e?c(new Error("Error sending custom prompt, please try again.")):(e.message="Error sending custom prompt, please try again.",c(e))}))}))}function so(){chrome.contextMenus.removeAll(),chrome.contextMenus.create({id:"triggerSmartSense",title:" SmartSense",contexts:["all"]}),chrome.contextMenus.create({id:"memorizePage",title:" Add to Memory",contexts:["all"]}),chrome.contextMenus.create({id:"fillForm",title:" Fill Form Fields",contexts:["all"]}),chrome.contextMenus.create({id:"aiDetector",title:" AI Detector",contexts:["selection"]}),chrome.contextMenus.create({id:"humanizeText",title:" Humanize Text",contexts:["selection"]}),chrome.contextMenus.create({id:"enhancePrompt",title:" Enhance Prompt",contexts:["selection"]}),chrome.contextMenus.create({id:"fixSpellingGrammar",title:" Fix spelling & grammar",contexts:["selection"]}),chrome.contextMenus.create({id:"makeLonger",title:" Make Longer",contexts:["selection"]}),chrome.contextMenus.create({id:"makeExplain",title:" Explain this",contexts:["selection"]}),chrome.contextMenus.create({id:"translateMenu",title:" Translate",contexts:["selection"]}),chrome.contextMenus.create({id:"translateEnglish",parentId:"translateMenu",title:"English",contexts:["selection"]}),chrome.contextMenus.create({id:"translateYoruba",parentId:"translateMenu",title:"Yoruba",contexts:["selection"]}),chrome.contextMenus.create({id:"translateIgbo",parentId:"translateMenu",title:"Igbo",contexts:["selection"]}),chrome.contextMenus.create({id:"translateHausa",parentId:"translateMenu",title:"Hausa",contexts:["selection"]}),chrome.contextMenus.create({id:"makeShorter",title:" Make Shorter",contexts:["selection"]}),chrome.contextMenus.create({id:"changeToneMenu",title:" Change Tone",contexts:["selection"]}),chrome.contextMenus.create({id:"tonePositive",parentId:"changeToneMenu",title:"Positive",contexts:["selection"]}),chrome.contextMenus.create({id:"toneNegative",parentId:"changeToneMenu",title:"Negative",contexts:["selection"]}),chrome.contextMenus.create({id:"toneOppose",parentId:"changeToneMenu",title:"Oppose",contexts:["selection"]}),chrome.contextMenus.create({id:"dunk",parentId:"changeToneMenu",title:"Dunk",contexts:["selection"]}),chrome.contextMenus.create({id:"keyTakeaways",title:" List key takeaways",contexts:["selection"]}),chrome.contextMenus.create({id:"replyToThis",title:" Reply to this",contexts:["all"]}),chrome.contextMenus.create({id:"customPrompt",title:" Custom Prompt",contexts:["all"]}),chrome.contextMenus.create({id:"findExtractMenu",title:" Find And Extract",contexts:["all"]}),chrome.contextMenus.create({id:"extractUsernames",parentId:"findExtractMenu",title:"Usernames (@mentions)",contexts:["all"]}),chrome.contextMenus.create({id:"extractEmails",parentId:"findExtractMenu",title:"Email addresses",contexts:["all"]}),chrome.contextMenus.create({id:"cancelOngoingProcess",title:" Cancel Ongoing Process",contexts:["all"]}),chrome.contextMenus.create({id:"shamelessPlug",title:" Shameless Plug",contexts:["all"]})}function oo(e,t,n){return new Promise(((s,o)=>{try{const i=["input","bulk_input"];"bulk_input"===t.action?o(new Error(t.reason||"Failed to add bulk input values, retrying...")):(0,r.J2)().then((a=>{let c=i.includes(t.action)?12e4:7e3,u=i.includes(t.action)?"You have 2 minutes to complete this action. After that time, I'll assume you've completed it and continue with the next steps.":"You have 7 seconds to complete this action. After that time, I'll assume you've completed it and continue with the next steps.";(0,r.j2)(e,!0,is).then((()=>{const r=t.action||"requested action",s=t.status||"unsupported",o=t.reason||"This action is not supported in the current version";let i="";i="notfound"===s?"The element needed for this action could not be found on the page.":"failed"===s?"The action failed to complete automatically.":"This action is not currently supported for automatic execution.";return Ss(e,t,`\n\n\t\t\t\t\t\t\tInstruct the user to perform the "${r}" action manually.\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t\tReason: ${i} ${o}\n\t\t\t\n\t\t\t\t\t\t\tAlso mention this to the user:\n\t\t\t\t\t\t\t${u}\n\n\n\t\t\t\t\t\t\tDO NOT ASK QUESTIONS. JUST INSTRUCT THE USER TO PERFORM THE ACTION MANUALLY.\n\n\t\t\t\t\t\t\tBE CONCISE AND TO THE POINT.\n\t\t\t\t\t\t`,n)})).then((()=>{setTimeout((()=>{Cs(e,"info_message","Time's up! Continuing with the next steps...",n).then((()=>{a&&a!==e&&chrome.tabs.get(a,(e=>{chrome.runtime.lastError||setTimeout((()=>{(0,r.j2)(a,!0,is).then((()=>{})).catch((e=>{}))}),3e3)})),s({status:"success",message:`User manually performed the action: ${t.action}`})})).catch((e=>{s({status:"success",message:`User manually performed the action: ${t.action}`})}))}),c)})).catch((e=>{o(e)}))})).catch((e=>{o(e)}))}catch(e){o(e)}}))}chrome.runtime.onStartup.addListener((()=>{Vs(),Ks=setInterval(Vs,6e5)})),chrome.runtime.onInstalled.addListener((e=>{Vs(),Ks||(Ks=setInterval(Vs,18e5))})),chrome.runtime.onSuspend.addListener((()=>{Ks&&clearInterval(Ks),chrome.power.releaseKeepAwake()})),chrome.notifications.onClicked.addListener((e=>{(0,r.xo)("https://browsergpt.co").catch((e=>{}))})),chrome.tabs.onRemoved.addListener((e=>{rs&&ns[rs]&&ns[rs].tabId===e&&(Us(0),(0,r.Hr)(null))})),chrome.contextMenus.onClicked.addListener(((e,t)=>{if((0,r.YL)(t.id,is).catch((e=>{})),io[e.menuItemId])!function({tab:e,menuConfig:t}){if(Zs(e.id,!0,null,!1,!1,!0),"cancel ongoing request"===t.prompt)return void eo(e.id,!1).then((t=>{to(e.id,"Ongoing request cancelled","checkmark","do_nothing"),Zs(e.id,!1,null,!1,!1,!0)})).catch((t=>{to(e.id,"Error cancelling ongoing request","error","do_nothing"),Zs(e.id,!1,null,!1,!1,!0)}));if(t.askQuestion)return void Promise.all([ao({tabId:e.id,question:t.question}),Ys(e.id),t.image?(0,r.VS)(e.id):Promise.resolve(null)]).then((([n,o,i])=>{if(!n)return to(e.id,"No Input Received","error","do_nothing"),void Zs(e.id,!1,null,!1,!1,!0);let a;a="function"==typeof t.getPrompt?t.getPrompt(n):n.prompt;Rs(a,{...t.options||{},current_url:o,image:t.image?i:null},!1).then((t=>{to(e.id,t.prompt||"No response from BrowserGPT","checkmark","do_nothing"),chrome.tabs.sendMessage(e.id,{action:"customPromptResponse",status:"success",message:t,bgptIndex:!1,stateId:is}),"converse"===t.action&&(0,s.t)(),["navigate","task_list"].includes(t.action)&&(0,r.Hr)(null)})).catch((t=>{to(e.id,`Error: ${t.message}`,"error","do_nothing")})).finally((()=>{Zs(e.id,!1,null,!1,!1,!0)}))})).catch((()=>{Zs(e.id,!1,null,!1,!1,!0)}));Rs(t.prompt,t.options,!0).then((t=>{to(e.id,t.prompt||"No response from BrowserGPT","checkmark","do_nothing"),chrome.tabs.sendMessage(e.id,{action:"customPromptResponse",status:"success",message:t,bgptIndex:!1,stateId:is}),"converse"===t.action&&(0,s.t)(),["navigate","task_list"].includes(t.action)&&(0,r.Hr)(null)})).catch((t=>{to(e.id,`Error: ${t.message}`,"error","do_nothing")})).finally((()=>{Zs(e.id,!1,null,!1,!1,!0)}))}({tab:t,menuConfig:io[e.menuItemId]});else if("triggerSmartSense"===e.menuItemId)chrome.tabs.sendMessage(t.id,{action:"getElementSelector",stateId:is},(e=>{Zs(t.id,!0,null,!1,!1,!0),chrome.tabs.get(t.id,(e=>{(0,l.S4)(t.id,e.url,!1).then((()=>{Zs(t.id,!1,null,!1,!1,!0)}))}))}));else if("extractUsernames"===e.menuItemId)Zs(t.id,!0,null,!1,!1,!0),chrome.tabs.sendMessage(t.id,{action:"extractAllMentions",type:"username",stateId:is},(e=>{if(chrome.runtime.lastError)to(t.id,"Error extracting usernames, please try again.","error","do_nothing");else if(Zs(t.id,!1,null,!1,!1,!0),e&&"success"===e.status)if(e.result&&e.result.length>0){let n=`Extracted ${e.result.length} usernames: ${e.result.join(", ")}`;to(t.id,n,"checkmark","do_nothing")}else to(t.id,"No usernames found on this page.","info","do_nothing");else to(t.id,"Error extracting usernames","error","do_nothing")}));else if("extractEmails"===e.menuItemId)Zs(t.id,!0,null,!1,!1,!0),chrome.tabs.sendMessage(t.id,{action:"extractAllMentions",type:"email",stateId:is},(e=>{if(chrome.runtime.lastError)to(t.id,"Error extracting email addresses, please try again.","error","do_nothing");else if(Zs(t.id,!1,null,!1,!1,!0),e&&"success"===e.status)if(e.result&&e.result.length>0){let n=`Extracted ${e.result.length} email addresses: ${e.result.join(", ")}`;to(t.id,n,"checkmark","do_nothing")}else to(t.id,"No email addresses found on this page.","info","do_nothing");else to(t.id,"Error extracting email addresses","error","do_nothing")}));else if("enhancePrompt"===e.menuItemId){Zs(t.id,!0,null,!1,!1,!0);let n=`\n\t\tYou are an expert prompt engineer.\n\t\tYou will be given a llm prompt and screenshot of the page showing previous conversation and prompt result or previous image prompt and image result from the ai.\n\t\t\n\t\tYou will need to enhance the prompt to be more specific and accurate and to meet the user's specificneeds.\n\n\t\tHere is the llm prompt:\n\t\t${e.selectionText?`Here is the llm prompt to enhance: "${e.selectionText}"`:""}\n\n\t\tAnalyze the image showing the previous conversation and prompt result or image prompt and image result from the ai.\n\n\t\tYou will need to enhance the llm prompt to be more specific and accurate and to meet the user's specific needs.\n\n\n\t\tNOTE:\n\t\t - If the llm prompt is for generating an image, you will need to enhance the prompt to be more specific and accurate and to meet the user's specific needs.\n\t\t - If the llm prompt is for generating text, you will need to enhance the prompt to be more specific and accurate with guardrails to meet the user's specific needs.\n\n\n\t\tYour response should be the enhanced llm prompt.\n\n\t\tStart with "Here is the enhanced [Image or Text] prompt:\n\n\t\t`;(0,r.VS)(t.id).then((e=>{Rs(n,{is_converse_only:!0,image:e},!0).then((e=>{to(t.id,e),Zs(t.id,!1,null,!1,!1,!0)}))}))}else if("memorizePage"===e.menuItemId){Zs(t.id,!0,null,!1,!1,!0);const n=e.selectionText?`Here is the text to memorize: "${e.selectionText}"`:"";(0,r.lz)(t.id,"summarize").then((e=>{(0,r.VS)(t.id).then((r=>{const s=`\n\t\t\t\t\tYou are a memory assistant. \n\t\t\t\t\tMemorize the following page: ${t.title}\n\t\t\n\t\t\t\t\t${n}\n\n\t\t\t\t\tHere is the text elements on the page:\n\t\t\t\t\t${JSON.stringify(e)}\n\t\t\n\t\t\t\t\t`;chrome.tabs.get(t.id,(e=>{Js(r,s,e.url).then((e=>{to(t.id,`Memory updated with info from ${t.title}`)})).catch((e=>{to(t.id,"Error updating memory at this time. Please try again later.","error","do_nothing")})).finally((()=>{Zs(t.id,!1,null,!1,!1,!0)}))}))}))})).catch((e=>{}))}else if("aiDetector"===e.menuItemId){const n=e.selectionText;try{(0,r.VS)(t.id).then((e=>{Zs(t.id,!0,null,!1,!1,!0);Rs(`\n\t\t\t\tYou are an AI text detector. \n\t\t\t\t\n\t\t\t\tAnalyze the following text and determine the likelihood it was generated by AI.\n\n\t\t\t\tImportant: Start with the assumption that text could be human-written OR AI-generated. Avoid bias in either direction.\n\n\t\t\t\tCriteria for balanced analysis:\n\t\t\t\t \n\t\t\t\tAI indicators:\n\t\t\t\t - Lack of personal voice or unique style\n\t\t\t\t - Repetitive sentence structures\n\t\t\t\t - Em dashes or other uncommon punctuation used extensively\n\t\t\t\t\n\t\t\t\tHuman indicators:\n\t\t\t\t - Presence of Grammatical errors or typos (NOT REQUIRED)\n\t\t\t\t - Presence of Personal anecdotes or unique expressions\n\t\t\t\t - Presence of Inconsistent formatting\n\t\t\t\t - Presence of Casual language or slang\n\t\t\t\t - Presence of Shorthand instructions or command-like syntax\n\t\t\t\t - Presence of Step-by-step instructions without excessive explanation\n\t\t\t\t - Presence of Non-standard sentence structures or fragments\n\t\t\t\t - Presence of personal voice\n\n\t\t\t\tInstructions like "click here", "go to URL", lists of steps, or technical directions are often human-written.\n\t\t\t\t\n\t\t\t\tText to analyze:\n\t\t\t\t "${n}"\n\n\t\t\t\tStart with "The content is [PERCENTAGE]% AI-generated. [EXPLANATION]"\n\n\t\t\t\tFor lower confidence (<40%), emphasize human characteristics found.\n\t\t\t\t\n\t\t\t\tSample human response:\n\t\t\t\t"The content is 15% AI-generated. This appears to be human-written instructions with typical shorthand commands, step-by-step format, and practical directions without excessive explanations or perfect formatting."\n\t\t\t\t`,{is_converse_only:!0,image:e},!0).then((e=>{to(t.id,e,"checkmark","do_nothing"),Zs(t.id,!1,null,!1,!1,!0)}))}))}catch(e){to(t.id,"Error detecting AI text. Please try again later.","error","do_nothing"),Zs(t.id,!1,null,!1,!1,!0)}}else if("humanizeText"===e.menuItemId){const n=e.selectionText;if(n){Zs(t.id,!0,null,!1,!1,!0);try{(0,r.VS)(t.id).then((e=>{Rs(`\n\t\t\t\t\tYou are a text humanizer. \n\t\t\t\t\tTake the following AI-generated text and rewrite it to sound natural, engaging, and completely human-written. \n\t\t\t\t\t\n\t\t\t\t\tMake it undetectable by AI detectors while preserving the original meaning: \n\t\t\t\t\t\n\t\t\t\t\tText to humanize:\n\t\t\t\t\t"${n}"\n\t\t\t\t\t\n\t\t\t\t\t\n\t\t\t\t\tMake sure to remove em dashes and other uncommon punctuation.\n\t\t\t\t\tUse google search terms or layman's terms in the response to help with the humanization.\n\n\t\t\t\t\tYour response should be the humanized text.\n\n\t\t\t\t\tStart with "Here is the humanized text: "\n\t\t\t\t\t`,{is_converse_only:!0,image:e},!0).then((e=>{to(t.id,e),Zs(t.id,!1,null,!1,!1,!0)}))}))}catch(e){to(t.id,"Error humanizing text. Please try again later.","error","do_nothing"),Zs(t.id,!1,null,!1,!1,!0)}}}else if("fixSpellingGrammar"===e.menuItemId){const n=e.selectionText;if(n){Zs(t.id,!0,null,!1,!1,!0);Rs(`\n\t\t\tYou are a spelling and grammar assistant.\n\t\t\tFix the spelling and grammar in the following text while preserving its original meaning and tone:\n\t\t\t\n\t\t\t"${n}"\n\t\t\t\n\t\t\tOnly output the corrected text without any explanation or comments.\n\t\t\t`,{is_converse_only:!0},!0).then((e=>{to(t.id,e),Zs(t.id,!1,null,!1,!1,!0)}))}}else if("makeLonger"===e.menuItemId){const n=e.selectionText;n&&(Zs(t.id,!0,null,!1,!1,!0),(0,r.VS)(t.id).then((e=>{Rs(`\n\t\t\t\tYou are a content expansion assistant.\n\t\t\t\tExpand the following text to make it longer while maintaining its original meaning, tone, and intent:\n\t\t\t\t\n\t\t\t\t"${n}"\n\t\t\t\t\n\t\t\t\tAdd relevant details, examples, explanations, or supporting points to enrich the content.\n\t\t\t\tYour response should only contain the expanded text.\n\t\t\t\t`,{is_converse_only:!0,image:e},!0).then((e=>{to(t.id,e),Zs(t.id,!1,null,!1,!1,!0)}))})))}else if("makeExplain"===e.menuItemId){const n=e.selectionText;if(n){Zs(t.id,!0,null,!1,!1,!0);Rs(`\n\t\t\tYou are an explainer assistant.\n\t\t\tExplain the following text in simpler terms, reducing complexity and making it easier to understand:\n\t\t\t\n\t\t\t"${n}"\n\t\t\t\n\t\t\tYour explanation should be clear, concise, and accessible to someone without specialized knowledge in the topic.\n\t\t\tStart with "Explanation: "\n\t\t\t`,{is_converse_only:!0},!0).then((e=>{to(t.id,e),Zs(t.id,!1,null,!1,!1,!0)}))}}else if(e.menuItemId.startsWith("translate")){const n=e.selectionText;let r="English";if("translateYoruba"===e.menuItemId?r="Yoruba":"translateIgbo"===e.menuItemId?r="Igbo":"translateHausa"===e.menuItemId&&(r="Hausa"),n){Zs(t.id,!0,null,!1,!1,!0);Rs(`\n\t\t\tYou are a translation assistant.\n\t\t\tTranslate the following text into ${r}:\n\t\t\t\n\t\t\t"${n}"\n\t\t\t\n\t\t\tOnly output the translated text.\n\t\t\t`,{is_converse_only:!0},!0).then((e=>{to(t.id,e),Zs(t.id,!1,null,!1,!1,!0)}))}}else if("makeShorter"===e.menuItemId){const n=e.selectionText;if(n){Zs(t.id,!0,null,!1,!1,!0);Rs(`\n\t\t\tYou are a text summarization assistant.\n\t\t\tShorten the following text while preserving its key points and meaning:\n\t\t\t\n\t\t\t"${n}"\n\t\t\t\n\t\t\tYour response should be significantly shorter than the original while maintaining clarity.\n\t\t\tOnly output the shortened text.\n\t\t\t`,{is_converse_only:!0},!0).then((e=>{to(t.id,e),Zs(t.id,!1,null,!1,!1,!0)}))}}else if(e.menuItemId.startsWith("tone")){const n=e.selectionText;let r="Positive";if("toneNegative"===e.menuItemId?r="Negative":"toneOppose"===e.menuItemId?r="Oppositional":"dunk"===e.menuItemId&&(r="Dunk (Dunk Tweet)"),n){Zs(t.id,!0,null,!1,!1,!0);Rs(`\n\t\t\tYou are a tone-shifting assistant.\n\t\t\tRewrite the following text to have a ${r.toLowerCase()} tone while preserving its core meaning:\n\t\t\t\n\t\t\t"${n}"\n\t\t\t\n\t\t\tOnly output the rewritten text with the new tone.\n\t\t\t`,{is_converse_only:!0},!0).then((e=>{to(t.id,e),Zs(t.id,!1,null,!1,!1,!0)}))}}else if("keyTakeaways"===e.menuItemId){const n=e.selectionText;if(n){Zs(t.id,!0,null,!1,!1,!0);Rs(`\n\t\t\tYou are a content analysis assistant.\n\t\t\tExtract and list the key takeaways from the following text:\n\t\t\t\n\t\t\t"${n}"\n\t\t\t\n\t\t\tFormat your response as a bulleted list of the most important points.\n\t\t\tStart with "Key Takeaways:"\n\t\t\t`,{is_converse_only:!0},!0).then((e=>{to(t.id,e),Zs(t.id,!1,null,!1,!1,!0)}))}}else if("replyToThis"===e.menuItemId){Zs(t.id,!0,null,!1,!1,!0);const n=e.selectionText?`Using this selected text as context: "${e.selectionText}"`:"";(0,r.VS)(t.id).then((e=>{Rs(`\n\t\t\tYou are a response assistant.\n\t\t\t${n}\n\t\t\t\n\t\t\tBased on the screenshot and any selected text context, formulate a thoughtful, relevant reply.\n\t\t\t\n\t\t\tConsider:\n\t\t\t- The tone and content of the conversation\n\t\t\t- Any questions or points raised that need addressing\n\t\t\t- The appropriate level of formality for the context\n\t\t\t\n\t\t\tYour response should be a response to the visible prompt/input field, input or context.\n\n\t\t\tIf the visible prompt is an input field, your response should be the value to be entered into the input field (i.e if it is an email input field, value will be an email address)\n\t\t\tIf the visible prompt is a context, your response should be a reply to the context.\n\t\t\tIf the visible prompt is a question, your response should be a direct reply to the question which should be an answer to the question.\n\n\t\t\tStart with "Suggested reply:"\n\t\t\t`,{is_converse_only:!0,image:e},!0).then((e=>{to(t.id,e),Zs(t.id,!1,null,!1,!1,!0)}))}))}else if("customPrompt"===e.menuItemId){Zs(t.id,!0,null,!1,!1,!0);const n=e.selectionText||"";Ys(t.id).then((e=>{ro(t.id,n,!0,e).then((e=>{to(t.id,e.prompt||"No response from BrowserGPT","checkmark","do_nothing"),Zs(t.id,!1,null,!1,!1,!0)})).catch((e=>{Zs(t.id,!1,null,!1,!1,!0)}))}))}else"fillForm"===e.menuItemId&&(Zs(t.id,!0,null,!1,!1,!0),Ys(t.id).then((e=>{ro(t.id,"Please fill out the form on this page using your bulk input capabilties",!0,e,"What information should be used to fill the form?").then((e=>{to(t.id,e.prompt||"No response from BrowserGPT","checkmark","do_nothing"),Zs(t.id,!1,null,!1,!1,!0)})).catch((e=>{Zs(t.id,!1,null,!1,!1,!0),to(t.id,"Form filling canceled","info","do_nothing")}))})))})),chrome.idle.onStateChanged.addListener((e=>{"active"===e&&so()})),chrome.tabs.onActivated.addListener((e=>{so()})),chrome.windows.onFocusChanged.addListener((e=>{e!==chrome.windows.WINDOW_ID_NONE&&so()}));const io={cancelOngoingProcess:{prompt:"cancel ongoing request",options:{is_converse_only:!1},image:null,description:"Cancel Ongoing Process",askQuestion:!1},shamelessPlug:{askQuestion:!0,description:"Shameless Plug",image:!0,question:"Describe the product or service you want to shamelessly promote (be specific):",options:{is_converse_only:!1},getPrompt:e=>`You are a social media marketer.\n\nThe user wants to shamelessly promote the following product/service:\n\n"${e}"\n\nYour job is to reply to every comment (if any exist) on the current page with a personalized, engaging, and non-spammy promotion for this product/service.\nIteratively do this for multiple comments until you have promoted the product/service to all comments.\n\nMake each reply unique and relevant to the comment. If there are no comments, suggest a creative way to promote the product/service on this page. Do not mention you are an AI. Do not mention this is a shameless plug. Just do it naturally.`}};async function ao({tabId:e,question:t}){const n=Ts(e),r=Cs(e,"input_request",`${t}\n\n`,null,!1,!1);return Promise.all([n,r]).then((([e])=>e))}})();